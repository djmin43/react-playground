{"version":3,"file":"actions.js","names":["callApi","store","event","callRealApi","payload","addNodeMutation","assign","nodeMutationBatch","push","assignStoreAndWorkerPool","_context","workerPool","data","setQueryRunningFinished","dispatch","actions","setProgramStatus","ProgramStatus","BOOTSTRAP_QUERY_RUNNING_FINISHED","markQueryFilesDirty","queryFilesDirty","markSourceFilesDirty","context","prev","changedSourceFiles","Set","sourceFilesDirty","add","file","markSourceFilesClean","setRecompiledFiles","recompiledFiles","markNodesDirty","nodesMutatedDuringQueryRun","markNodesClean","incrementRecompileCount","nodesMutatedDuringQueryRunRecompileCount","count","reporter","verbose","resetRecompileCount","assignServiceResult","spawnMutationListener","mutationListener","spawn","listenForMutations","assignServers","spawnWebpackListener","webpackListener","compiler","undefined","createWebpackWatcher","assignWebhookBody","webhookBody","webhookSourcePluginName","pluginName","clearWebhookBody","finishParentSpan","parentSpan","finish","saveDbState","saveState","logError","error","panic","panicBecauseOfInfiniteLoop","stripIndent","trackRequestedQueryRun","pendingQueryRuns","pagePath","clearPendingQueryRuns","schemaTypegen","schema","directory","program","writeGraphQLSchema","err","panicOnBuild","id","sourceMessage","definitionsTypegen","definitions","config","getState","graphqlTypegenOptions","graphqlTypegen","Error","writeGraphQLFragments","writeTypeScriptTypes","buildActions"],"sources":["../../../src/state-machines/develop/actions.ts"],"sourcesContent":["import {\n  assign,\n  AnyEventObject,\n  ActionFunction,\n  spawn,\n  ActionFunctionMap,\n  DoneEventObject,\n} from \"xstate\"\nimport { IBuildContext } from \"../../services\"\nimport { actions } from \"../../redux/actions\"\nimport { listenForMutations } from \"../../services/listen-for-mutations\"\nimport { DataLayerResult } from \"../data-layer\"\nimport { saveState } from \"../../redux/save-state\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport { store } from \"../../redux\"\nimport { ProgramStatus } from \"../../redux/types\"\nimport { createWebpackWatcher } from \"../../services/listen-to-webpack\"\nimport { callRealApi } from \"../../utils/call-deferred-api\"\nimport {\n  writeGraphQLFragments,\n  writeGraphQLSchema,\n} from \"../../utils/graphql-typegen/file-writes\"\nimport { writeTypeScriptTypes } from \"../../utils/graphql-typegen/ts-codegen\"\n/**\n * Handler for when we're inside handlers that should be able to mutate nodes\n * Instead of queueing, we call it right away\n */\nexport const callApi: ActionFunction<IBuildContext, AnyEventObject> = (\n  { store },\n  event\n) => callRealApi(event.payload, store)\n\n/**\n * Event handler used in all states where we're not ready to process node\n * mutations. Instead we add it to a batch to process when we're next idle\n */\nexport const addNodeMutation = assign<IBuildContext, AnyEventObject>({\n  nodeMutationBatch: ({ nodeMutationBatch = [] }, { payload }) => {\n    // It's not pretty, but it's much quicker than concat\n    nodeMutationBatch.push(payload)\n    return nodeMutationBatch\n  },\n})\n\nexport const assignStoreAndWorkerPool = assign<IBuildContext, DoneEventObject>(\n  (_context, event) => {\n    const { store, workerPool } = event.data\n    return {\n      store,\n      workerPool,\n    }\n  }\n)\n\nconst setQueryRunningFinished = async (): Promise<void> => {\n  store.dispatch(\n    actions.setProgramStatus(ProgramStatus.BOOTSTRAP_QUERY_RUNNING_FINISHED)\n  )\n}\n\nexport const markQueryFilesDirty = assign<IBuildContext>({\n  queryFilesDirty: true,\n})\n\nexport const markSourceFilesDirty = assign<IBuildContext, AnyEventObject>(\n  (context, event) => {\n    const prev = context.changedSourceFiles ?? new Set()\n    return {\n      sourceFilesDirty: true,\n      changedSourceFiles: prev.add(event.payload ?? event.file),\n    }\n  }\n)\n\nexport const markSourceFilesClean = assign<IBuildContext>({\n  sourceFilesDirty: false,\n  changedSourceFiles: () => new Set(),\n})\n\nexport const setRecompiledFiles = assign<IBuildContext, AnyEventObject>(\n  context => {\n    return {\n      recompiledFiles: context.changedSourceFiles,\n    }\n  }\n)\n\nexport const markNodesDirty = assign<IBuildContext>({\n  nodesMutatedDuringQueryRun: true,\n})\n\nexport const markNodesClean = assign<IBuildContext>({\n  nodesMutatedDuringQueryRun: false,\n})\n\nexport const incrementRecompileCount = assign<IBuildContext>({\n  nodesMutatedDuringQueryRunRecompileCount: ({\n    nodesMutatedDuringQueryRunRecompileCount: count = 0,\n  }) => {\n    reporter.verbose(\n      `Re-running queries because nodes mutated during query run. Count: ${\n        count + 1\n      }`\n    )\n    return count + 1\n  },\n})\n\nexport const resetRecompileCount = assign<IBuildContext>({\n  nodesMutatedDuringQueryRunRecompileCount: 0,\n  nodesMutatedDuringQueryRun: false,\n})\n\nexport const assignServiceResult = assign<IBuildContext, DoneEventObject>(\n  (_context, { data }): DataLayerResult => data\n)\n\n/**\n * This spawns the service that listens to the `emitter` for various mutation events\n */\nexport const spawnMutationListener = assign<IBuildContext>({\n  // @ts-ignore - TODO: Fixing this seems more involved: https://xstate.js.org/docs/guides/typescript.html#troubleshooting & https://github.com/statelyai/xstate/issues/2664\n  mutationListener: () => spawn(listenForMutations, `listen-for-mutations`),\n})\n\nexport const assignServers = assign<IBuildContext, AnyEventObject>(\n  (_context, { data }) => {\n    return {\n      ...data,\n    }\n  }\n)\n\nexport const spawnWebpackListener = assign<IBuildContext, AnyEventObject>({\n  // @ts-ignore - TODO: Fixing this seems more involved: https://xstate.js.org/docs/guides/typescript.html#troubleshooting & https://github.com/statelyai/xstate/issues/2664\n  webpackListener: ({ compiler }) => {\n    if (!compiler) {\n      return undefined\n    }\n    return spawn(createWebpackWatcher(compiler))\n  },\n})\n\nexport const assignWebhookBody = assign<IBuildContext, AnyEventObject>({\n  webhookBody: (_context, { payload }) => payload?.webhookBody,\n  webhookSourcePluginName: (_context, { payload }) => payload?.pluginName,\n})\n\nexport const clearWebhookBody = assign<IBuildContext, AnyEventObject>({\n  webhookBody: undefined,\n  webhookSourcePluginName: undefined,\n})\n\nexport const finishParentSpan = ({ parentSpan }: IBuildContext): void =>\n  parentSpan?.finish()\n\nexport const saveDbState = (): Promise<void> => saveState()\n\nexport const logError: ActionFunction<IBuildContext, AnyEventObject> = (\n  _context,\n  event\n) => {\n  reporter.error(event.data)\n}\n\nexport const panic: ActionFunction<IBuildContext, AnyEventObject> = (\n  _context,\n  event\n) => {\n  reporter.panic(event.data)\n}\n\nexport const panicBecauseOfInfiniteLoop: ActionFunction<\n  IBuildContext,\n  AnyEventObject\n> = () => {\n  reporter.panic(\n    reporter.stripIndent(`\n  Panicking because nodes appear to be being changed every time we run queries. This would cause the site to recompile infinitely.\n  Check custom resolvers to see if they are unconditionally creating or mutating nodes on every query.\n  This may happen if they create nodes with a field that is different every time, such as a timestamp or unique id.`)\n  )\n}\n\nexport const trackRequestedQueryRun = assign<IBuildContext, AnyEventObject>({\n  pendingQueryRuns: (context, { payload }) => {\n    const pendingQueryRuns = context.pendingQueryRuns || new Set<string>()\n    if (payload?.pagePath) {\n      pendingQueryRuns.add(payload.pagePath)\n    }\n    return pendingQueryRuns\n  },\n})\n\nexport const clearPendingQueryRuns = assign<IBuildContext>(() => {\n  return {\n    pendingQueryRuns: new Set<string>(),\n  }\n})\n\nexport const schemaTypegen: ActionFunction<\n  IBuildContext,\n  AnyEventObject\n> = async (context, event) => {\n  const schema = event.payload.payload\n  const directory = context.program.directory\n\n  context.reporter!.verbose(`Re-Generating schema.graphql`)\n\n  try {\n    await writeGraphQLSchema(directory, schema)\n  } catch (err) {\n    context.reporter!.panicOnBuild({\n      id: `12100`,\n      context: {\n        sourceMessage: err,\n      },\n    })\n  }\n}\n\nexport const definitionsTypegen: ActionFunction<\n  IBuildContext,\n  AnyEventObject\n> = async (context, event) => {\n  const definitions = event.payload.payload\n  const { schema, config } = context.store!.getState()\n  const directory = context.program.directory\n  const graphqlTypegenOptions = config.graphqlTypegen\n\n  if (!graphqlTypegenOptions) {\n    throw new Error(`graphqlTypegen option is falsy. This should never happen.`)\n  }\n\n  context.reporter!.verbose(`Re-Generating fragments.graphql & TS Types`)\n\n  try {\n    await writeGraphQLFragments(directory, definitions)\n    await writeTypeScriptTypes(\n      directory,\n      schema,\n      definitions,\n      graphqlTypegenOptions\n    )\n  } catch (err) {\n    context.reporter!.panicOnBuild({\n      id: `12100`,\n      context: {\n        sourceMessage: err,\n      },\n    })\n  }\n}\n\nexport const buildActions: ActionFunctionMap<IBuildContext, AnyEventObject> = {\n  callApi,\n  markNodesDirty,\n  addNodeMutation,\n  spawnMutationListener,\n  assignStoreAndWorkerPool,\n  assignServiceResult,\n  assignServers,\n  markQueryFilesDirty,\n  assignWebhookBody,\n  clearWebhookBody,\n  finishParentSpan,\n  spawnWebpackListener,\n  markSourceFilesDirty,\n  markSourceFilesClean,\n  setRecompiledFiles,\n  markNodesClean,\n  incrementRecompileCount,\n  resetRecompileCount,\n  panicBecauseOfInfiniteLoop,\n  saveDbState,\n  setQueryRunningFinished,\n  panic,\n  logError,\n  trackRequestedQueryRun,\n  clearPendingQueryRuns,\n  schemaTypegen,\n  definitionsTypegen,\n}\n"],"mappings":"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"}