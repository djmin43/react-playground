{"version":3,"file":"gatsby-dependents.js","names":["getAllDependencies","pkg","Set","Object","entries","dependencies","devDependencies","optionalDependencies","readJSON","file","buffer","readFile","JSON","parse","toString","getTreeFromNodeModules","dir","results","Map","requireFromHere","createRequireFromPath","packageJSON","require","resolve","join","error","Promise","all","Array","from","map","name","version","currentDependency","path","dirname","test","has","set","values","getGatsbyDependents","program","store","getState","directory"],"sources":["../../src/utils/gatsby-dependents.ts"],"sourcesContent":["import { store } from \"../redux\"\nimport { memoize } from \"lodash\"\n\nimport { createRequireFromPath } from \"gatsby-core-utils\"\nimport { join, dirname } from \"path\"\nimport { PackageJson } from \"../..\"\nimport { readFile } from \"fs-extra\"\n\ninterface IDependency {\n  name: string\n  version: string\n  path: string\n}\n\nconst getAllDependencies = (pkg: PackageJson): Set<[string, string]> =>\n  new Set([\n    ...Object.entries(pkg.dependencies || {}),\n    ...Object.entries(pkg.devDependencies || {}),\n    ...Object.entries(pkg.optionalDependencies || {}),\n  ])\n\nconst readJSON = async (file: string): Promise<PackageJson> => {\n  const buffer = await readFile(file)\n  return JSON.parse(buffer.toString())\n}\n\nconst getTreeFromNodeModules = async (\n  dir: string,\n  results: Map<string, IDependency> = new Map()\n): Promise<Array<IDependency>> => {\n  const requireFromHere = createRequireFromPath(`${dir}/:internal:`)\n  let packageJSON: PackageJson\n  try {\n    packageJSON = await readJSON(require.resolve(join(dir, `package.json`)))\n  } catch (error) {\n    packageJSON = {}\n  }\n\n  await Promise.all(\n    Array.from(getAllDependencies(packageJSON)).map(async ([name, version]) => {\n      try {\n        const currentDependency: IDependency = {\n          name,\n          version,\n          path: dirname(requireFromHere.resolve(`${name}/package.json`)),\n        }\n\n        // Include anything that has `gatsby` in its name but not `gatsby` itself\n        if (\n          /gatsby/.test(currentDependency.name) &&\n          currentDependency.name !== `gatsby`\n        ) {\n          await getTreeFromNodeModules(currentDependency.path, results)\n          if (!results.has(currentDependency.name))\n            results.set(currentDependency.name, currentDependency)\n        }\n      } catch (error) {\n        // Sometimes dev dependencies of dependencies aren't installed\n        // when using `yarn`. This is okay and safe to ignore.\n      }\n    })\n  )\n\n  return Array.from(results.values())\n}\n\nexport const getGatsbyDependents = memoize(\n  async (): Promise<Array<IDependency>> => {\n    const { program } = store.getState()\n    return getTreeFromNodeModules(program.directory)\n  }\n)\n"],"mappings":";;;;;;;;;AAAA;;AAGA;;AACA;;AAEA;;AAQA,MAAMA,kBAAkB,GAAIC,GAAD,IACzB,IAAIC,GAAJ,CAAQ,CACN,GAAGC,MAAM,CAACC,OAAP,CAAeH,GAAG,CAACI,YAAJ,IAAoB,EAAnC,CADG,EAEN,GAAGF,MAAM,CAACC,OAAP,CAAeH,GAAG,CAACK,eAAJ,IAAuB,EAAtC,CAFG,EAGN,GAAGH,MAAM,CAACC,OAAP,CAAeH,GAAG,CAACM,oBAAJ,IAA4B,EAA3C,CAHG,CAAR,CADF;;AAOA,MAAMC,QAAQ,GAAG,MAAOC,IAAP,IAA8C;EAC7D,MAAMC,MAAM,GAAG,MAAM,IAAAC,iBAAA,EAASF,IAAT,CAArB;EACA,OAAOG,IAAI,CAACC,KAAL,CAAWH,MAAM,CAACI,QAAP,EAAX,CAAP;AACD,CAHD;;AAKA,MAAMC,sBAAsB,GAAG,OAC7BC,GAD6B,EAE7BC,OAAiC,GAAG,IAAIC,GAAJ,EAFP,KAGG;EAChC,MAAMC,eAAe,GAAG,IAAAC,sCAAA,EAAuB,GAAEJ,GAAI,aAA7B,CAAxB;EACA,IAAIK,WAAJ;;EACA,IAAI;IACFA,WAAW,GAAG,MAAMb,QAAQ,CAACc,OAAO,CAACC,OAAR,CAAgB,IAAAC,UAAA,EAAKR,GAAL,EAAW,cAAX,CAAhB,CAAD,CAA5B;EACD,CAFD,CAEE,OAAOS,KAAP,EAAc;IACdJ,WAAW,GAAG,EAAd;EACD;;EAED,MAAMK,OAAO,CAACC,GAAR,CACJC,KAAK,CAACC,IAAN,CAAW7B,kBAAkB,CAACqB,WAAD,CAA7B,EAA4CS,GAA5C,CAAgD,OAAO,CAACC,IAAD,EAAOC,OAAP,CAAP,KAA2B;IACzE,IAAI;MACF,MAAMC,iBAA8B,GAAG;QACrCF,IADqC;QAErCC,OAFqC;QAGrCE,IAAI,EAAE,IAAAC,aAAA,EAAQhB,eAAe,CAACI,OAAhB,CAAyB,GAAEQ,IAAK,eAAhC,CAAR;MAH+B,CAAvC,CADE,CAOF;;MACA,IACE,SAASK,IAAT,CAAcH,iBAAiB,CAACF,IAAhC,KACAE,iBAAiB,CAACF,IAAlB,KAA4B,QAF9B,EAGE;QACA,MAAMhB,sBAAsB,CAACkB,iBAAiB,CAACC,IAAnB,EAAyBjB,OAAzB,CAA5B;QACA,IAAI,CAACA,OAAO,CAACoB,GAAR,CAAYJ,iBAAiB,CAACF,IAA9B,CAAL,EACEd,OAAO,CAACqB,GAAR,CAAYL,iBAAiB,CAACF,IAA9B,EAAoCE,iBAApC;MACH;IACF,CAhBD,CAgBE,OAAOR,KAAP,EAAc,CACd;MACA;IACD;EACF,CArBD,CADI,CAAN;EAyBA,OAAOG,KAAK,CAACC,IAAN,CAAWZ,OAAO,CAACsB,MAAR,EAAX,CAAP;AACD,CAtCD;;AAwCO,MAAMC,mBAAmB,GAAG,uBACjC,YAAyC;EACvC,MAAM;IAAEC;EAAF,IAAcC,YAAA,CAAMC,QAAN,EAApB;;EACA,OAAO5B,sBAAsB,CAAC0B,OAAO,CAACG,SAAT,CAA7B;AACD,CAJgC,CAA5B"}