{"version":3,"file":"babel-plugin-remove-api.js","names":["declare","removeApiCalls","api","options","assertVersion","apisToRemove","apis","length","console","warn","name","visitor","Program","exit","path","state","apiRemoved","removed","scope","crawl","Object","keys","bindings","forEach","refName","ref","referenced","type","isSelfReferenced","referencePaths","every","refPath","findParent","p","remove","t","isVariableDeclarator","isObjectPattern","parent","declarations","id","objectPattern","properties","filter","prop","isObjectProperty","value","argument","kind","specifiers","parentPath","ExportDefaultDeclaration","includes","ExportNamedDeclaration","declaration","node","isExportNamedDeclaration","specifiersToKeep","specifier","isExportSpecifier","isIdentifier","exported","binding","local","push","apiToCheck","isFunctionDeclaration","isVariableDeclaration","i","objectPath","get","removeExportProperties","source","ExpressionStatement","isAssignmentExpression","expression","isMemberExpression","left","object","property"],"sources":["../../../src/utils/babel/babel-plugin-remove-api.ts"],"sourcesContent":["import { declare } from \"@babel/helper-plugin-utils\"\nimport * as t from \"@babel/types\"\nimport type { PluginObj, ConfigAPI, NodePath } from \"@babel/core\"\nimport { removeExportProperties } from \"./babel-module-exports-helpers\"\n\n/**\n * Remove specified module exports from files.\n */\nexport default declare(function removeApiCalls(\n  api: ConfigAPI,\n  options: { apis?: Array<string> }\n): PluginObj {\n  api.assertVersion(7)\n\n  const apisToRemove = options?.apis ?? []\n\n  if (!apisToRemove.length) {\n    console.warn(\n      `No list of APIs was given to remove, check your plugin options.`\n    )\n  }\n\n  return {\n    name: `remove-api`,\n    visitor: {\n      Program: {\n        exit(path, state): void {\n          if (!state.apiRemoved) {\n            return\n          }\n\n          // babel doesn't remove references very well so we loop until nothing gets removed\n          let removed = false\n\n          // remove all unreferenced bindings\n          do {\n            removed = false\n            // make sure all references are up to date\n            path.scope.crawl()\n\n            Object.keys(path.scope.bindings).forEach(refName => {\n              const ref = path.scope.bindings[refName]\n\n              if (ref.referenced) {\n                // Functions can reference themselves, so we need to check if there's a\n                // binding outside the function scope or not.\n                if (ref.path.type === `FunctionDeclaration`) {\n                  const isSelfReferenced = ref.referencePaths.every(\n                    refPath => !!refPath.findParent(p => p === ref.path)\n                  )\n\n                  if (isSelfReferenced) {\n                    ref.path.remove()\n                    removed = true\n                  }\n                }\n              } else {\n                // if const {x,y} is used, we remove the property\n                if (\n                  t.isVariableDeclarator(ref.path) &&\n                  t.isObjectPattern(\n                    (ref.path.parent as t.VariableDeclaration).declarations[0]\n                      .id\n                  )\n                ) {\n                  const objectPattern = (\n                    ref.path.parent as t.VariableDeclaration\n                  ).declarations[0].id as t.ObjectPattern\n                  objectPattern.properties = objectPattern.properties.filter(\n                    prop =>\n                      t.isObjectProperty(prop)\n                        ? (prop.value as t.Identifier).name !== refName\n                        : ((prop as t.RestElement).argument as t.Identifier)\n                            .name !== refName\n                  )\n\n                  // if all properties got removed thus the object pattern is empty, we remove the whole declaration\n                  if (!objectPattern.properties.length) {\n                    ref.path.remove()\n                  }\n                } else {\n                  ref.path.remove()\n                }\n\n                // if it's a module and all specifiers are removed, remove the full binding\n                if (\n                  ref.kind === `module` &&\n                  !(ref.path.parent as t.ImportDeclaration).specifiers.length &&\n                  ref.path.parentPath\n                ) {\n                  ref.path.parentPath.remove()\n                }\n\n                removed = true\n              }\n            })\n          } while (removed)\n        },\n      },\n\n      // Remove export statements\n\n      ExportDefaultDeclaration(path, state): void {\n        if (apisToRemove.includes(`default`)) {\n          state.apiRemoved = true\n          path.remove()\n        }\n      },\n      ExportNamedDeclaration(path, state): void {\n        const declaration = path.node.declaration\n\n        if (t.isExportNamedDeclaration(path.node)) {\n          const specifiersToKeep: Array<\n            | t.ExportDefaultSpecifier\n            | t.ExportNamespaceSpecifier\n            | t.ExportSpecifier\n          > = []\n\n          // Remove `export { foo } = [...]` and `export { foo } from \"X\"` shaped exports\n          path.node.specifiers.forEach(specifier => {\n            if (\n              t.isExportSpecifier(specifier) &&\n              t.isIdentifier(specifier.exported) &&\n              apisToRemove.includes(specifier.exported.name)\n            ) {\n              const binding = path.scope.bindings[specifier.local.name]\n              // binding will not exist for `export { foo } from \"X\"` cases\n              if (binding) {\n                binding.path.remove()\n              }\n            } else {\n              specifiersToKeep.push(specifier)\n            }\n          })\n\n          path.node.specifiers = specifiersToKeep\n        }\n\n        // Remove `export function foo() {}` shaped exports\n        let apiToCheck\n        if (t.isFunctionDeclaration(declaration) && declaration.id) {\n          apiToCheck = declaration.id.name\n        }\n\n        // Remove `export const foo = () => {}` shaped exports\n        if (\n          t.isVariableDeclaration(declaration) &&\n          t.isIdentifier(declaration.declarations[0].id)\n        ) {\n          apiToCheck = declaration.declarations[0].id.name\n        }\n\n        if (apiToCheck && apisToRemove.includes(apiToCheck)) {\n          state.apiRemoved = true\n          path.remove()\n        }\n\n        // Remove `export const { foo } = () => {}` shaped exports\n        if (t.isVariableDeclaration(declaration)) {\n          for (let i = 0; i < declaration?.declarations.length; i++) {\n            if (declaration?.declarations[i].id.type === `ObjectPattern`) {\n              const objectPath = path.get(\n                `declaration.declarations.${i}.id`\n              ) as NodePath<t.ObjectPattern>\n              removeExportProperties(path, objectPath, apisToRemove)\n            }\n          }\n        }\n        // Remove `export const { foo } from \"X\"` shaped exports\n        else if (path.node?.source) {\n          if (path.node.specifiers.length === 0) {\n            path.remove()\n          }\n        }\n      },\n\n      // Remove `module.exports = { foo }` and `exports.foo = {}` shaped exports\n      ExpressionStatement(path, state): void {\n        if (\n          !t.isAssignmentExpression(path.node.expression) ||\n          !t.isMemberExpression(path.node.expression.left) ||\n          (path.node.expression.left.object as t.Identifier).name !== `exports`\n        ) {\n          return\n        }\n\n        const apiToCheck = (path.node.expression.left.property as t.Identifier)\n          .name\n        if (apiToCheck && apisToRemove.includes(apiToCheck)) {\n          state.apiRemoved = true\n          path.remove()\n        }\n      },\n    },\n  }\n})\n"],"mappings":";;;;;AAAA;;AACA;;AAEA;;;;;;AAEA;AACA;AACA;eACe,IAAAA,0BAAA,EAAQ,SAASC,cAAT,CACrBC,GADqB,EAErBC,OAFqB,EAGV;EAAA;;EACXD,GAAG,CAACE,aAAJ,CAAkB,CAAlB;EAEA,MAAMC,YAAY,oBAAGF,OAAH,aAAGA,OAAH,uBAAGA,OAAO,CAAEG,IAAZ,yDAAoB,EAAtC;;EAEA,IAAI,CAACD,YAAY,CAACE,MAAlB,EAA0B;IACxBC,OAAO,CAACC,IAAR,CACG,iEADH;EAGD;;EAED,OAAO;IACLC,IAAI,EAAG,YADF;IAELC,OAAO,EAAE;MACPC,OAAO,EAAE;QACPC,IAAI,CAACC,IAAD,EAAOC,KAAP,EAAoB;UACtB,IAAI,CAACA,KAAK,CAACC,UAAX,EAAuB;YACrB;UACD,CAHqB,CAKtB;;;UACA,IAAIC,OAAO,GAAG,KAAd,CANsB,CAQtB;;UACA,GAAG;YACDA,OAAO,GAAG,KAAV,CADC,CAED;;YACAH,IAAI,CAACI,KAAL,CAAWC,KAAX;YAEAC,MAAM,CAACC,IAAP,CAAYP,IAAI,CAACI,KAAL,CAAWI,QAAvB,EAAiCC,OAAjC,CAAyCC,OAAO,IAAI;cAClD,MAAMC,GAAG,GAAGX,IAAI,CAACI,KAAL,CAAWI,QAAX,CAAoBE,OAApB,CAAZ;;cAEA,IAAIC,GAAG,CAACC,UAAR,EAAoB;gBAClB;gBACA;gBACA,IAAID,GAAG,CAACX,IAAJ,CAASa,IAAT,KAAmB,qBAAvB,EAA6C;kBAC3C,MAAMC,gBAAgB,GAAGH,GAAG,CAACI,cAAJ,CAAmBC,KAAnB,CACvBC,OAAO,IAAI,CAAC,CAACA,OAAO,CAACC,UAAR,CAAmBC,CAAC,IAAIA,CAAC,KAAKR,GAAG,CAACX,IAAlC,CADU,CAAzB;;kBAIA,IAAIc,gBAAJ,EAAsB;oBACpBH,GAAG,CAACX,IAAJ,CAASoB,MAAT;oBACAjB,OAAO,GAAG,IAAV;kBACD;gBACF;cACF,CAbD,MAaO;gBACL;gBACA,IACEkB,CAAC,CAACC,oBAAF,CAAuBX,GAAG,CAACX,IAA3B,KACAqB,CAAC,CAACE,eAAF,CACGZ,GAAG,CAACX,IAAJ,CAASwB,MAAV,CAA2CC,YAA3C,CAAwD,CAAxD,EACGC,EAFL,CAFF,EAME;kBACA,MAAMC,aAAa,GACjBhB,GAAG,CAACX,IAAJ,CAASwB,MADW,CAEpBC,YAFoB,CAEP,CAFO,EAEJC,EAFlB;kBAGAC,aAAa,CAACC,UAAd,GAA2BD,aAAa,CAACC,UAAd,CAAyBC,MAAzB,CACzBC,IAAI,IACFT,CAAC,CAACU,gBAAF,CAAmBD,IAAnB,IACKA,IAAI,CAACE,KAAN,CAA6BpC,IAA7B,KAAsCc,OAD1C,GAEMoB,IAAD,CAAwBG,QAAzB,CACGrC,IADH,KACYc,OALO,CAA3B,CAJA,CAYA;;kBACA,IAAI,CAACiB,aAAa,CAACC,UAAd,CAAyBnC,MAA9B,EAAsC;oBACpCkB,GAAG,CAACX,IAAJ,CAASoB,MAAT;kBACD;gBACF,CAtBD,MAsBO;kBACLT,GAAG,CAACX,IAAJ,CAASoB,MAAT;gBACD,CA1BI,CA4BL;;;gBACA,IACET,GAAG,CAACuB,IAAJ,KAAc,QAAd,IACA,CAAEvB,GAAG,CAACX,IAAJ,CAASwB,MAAV,CAAyCW,UAAzC,CAAoD1C,MADrD,IAEAkB,GAAG,CAACX,IAAJ,CAASoC,UAHX,EAIE;kBACAzB,GAAG,CAACX,IAAJ,CAASoC,UAAT,CAAoBhB,MAApB;gBACD;;gBAEDjB,OAAO,GAAG,IAAV;cACD;YACF,CAvDD;UAwDD,CA7DD,QA6DSA,OA7DT;QA8DD;;MAxEM,CADF;;MA4EP;MAEAkC,wBAAwB,CAACrC,IAAD,EAAOC,KAAP,EAAoB;QAC1C,IAAIV,YAAY,CAAC+C,QAAb,CAAuB,SAAvB,CAAJ,EAAsC;UACpCrC,KAAK,CAACC,UAAN,GAAmB,IAAnB;UACAF,IAAI,CAACoB,MAAL;QACD;MACF,CAnFM;;MAoFPmB,sBAAsB,CAACvC,IAAD,EAAOC,KAAP,EAAoB;QAAA;;QACxC,MAAMuC,WAAW,GAAGxC,IAAI,CAACyC,IAAL,CAAUD,WAA9B;;QAEA,IAAInB,CAAC,CAACqB,wBAAF,CAA2B1C,IAAI,CAACyC,IAAhC,CAAJ,EAA2C;UACzC,MAAME,gBAIL,GAAG,EAJJ,CADyC,CAOzC;;UACA3C,IAAI,CAACyC,IAAL,CAAUN,UAAV,CAAqB1B,OAArB,CAA6BmC,SAAS,IAAI;YACxC,IACEvB,CAAC,CAACwB,iBAAF,CAAoBD,SAApB,KACAvB,CAAC,CAACyB,YAAF,CAAeF,SAAS,CAACG,QAAzB,CADA,IAEAxD,YAAY,CAAC+C,QAAb,CAAsBM,SAAS,CAACG,QAAV,CAAmBnD,IAAzC,CAHF,EAIE;cACA,MAAMoD,OAAO,GAAGhD,IAAI,CAACI,KAAL,CAAWI,QAAX,CAAoBoC,SAAS,CAACK,KAAV,CAAgBrD,IAApC,CAAhB,CADA,CAEA;;cACA,IAAIoD,OAAJ,EAAa;gBACXA,OAAO,CAAChD,IAAR,CAAaoB,MAAb;cACD;YACF,CAVD,MAUO;cACLuB,gBAAgB,CAACO,IAAjB,CAAsBN,SAAtB;YACD;UACF,CAdD;UAgBA5C,IAAI,CAACyC,IAAL,CAAUN,UAAV,GAAuBQ,gBAAvB;QACD,CA5BuC,CA8BxC;;;QACA,IAAIQ,UAAJ;;QACA,IAAI9B,CAAC,CAAC+B,qBAAF,CAAwBZ,WAAxB,KAAwCA,WAAW,CAACd,EAAxD,EAA4D;UAC1DyB,UAAU,GAAGX,WAAW,CAACd,EAAZ,CAAe9B,IAA5B;QACD,CAlCuC,CAoCxC;;;QACA,IACEyB,CAAC,CAACgC,qBAAF,CAAwBb,WAAxB,KACAnB,CAAC,CAACyB,YAAF,CAAeN,WAAW,CAACf,YAAZ,CAAyB,CAAzB,EAA4BC,EAA3C,CAFF,EAGE;UACAyB,UAAU,GAAGX,WAAW,CAACf,YAAZ,CAAyB,CAAzB,EAA4BC,EAA5B,CAA+B9B,IAA5C;QACD;;QAED,IAAIuD,UAAU,IAAI5D,YAAY,CAAC+C,QAAb,CAAsBa,UAAtB,CAAlB,EAAqD;UACnDlD,KAAK,CAACC,UAAN,GAAmB,IAAnB;UACAF,IAAI,CAACoB,MAAL;QACD,CA/CuC,CAiDxC;;;QACA,IAAIC,CAAC,CAACgC,qBAAF,CAAwBb,WAAxB,CAAJ,EAA0C;UACxC,KAAK,IAAIc,CAAC,GAAG,CAAb,EAAgBA,CAAC,IAAGd,WAAH,aAAGA,WAAH,uBAAGA,WAAW,CAAEf,YAAb,CAA0BhC,MAA7B,CAAjB,EAAsD6D,CAAC,EAAvD,EAA2D;YACzD,IAAI,CAAAd,WAAW,SAAX,IAAAA,WAAW,WAAX,YAAAA,WAAW,CAAEf,YAAb,CAA0B6B,CAA1B,EAA6B5B,EAA7B,CAAgCb,IAAhC,MAA0C,eAA9C,EAA8D;cAC5D,MAAM0C,UAAU,GAAGvD,IAAI,CAACwD,GAAL,CAChB,4BAA2BF,CAAE,KADb,CAAnB;cAGA,IAAAG,iDAAA,EAAuBzD,IAAvB,EAA6BuD,UAA7B,EAAyChE,YAAzC;YACD;UACF;QACF,CATD,CAUA;QAVA,KAWK,kBAAIS,IAAI,CAACyC,IAAT,uCAAI,WAAWiB,MAAf,EAAuB;UAC1B,IAAI1D,IAAI,CAACyC,IAAL,CAAUN,UAAV,CAAqB1C,MAArB,KAAgC,CAApC,EAAuC;YACrCO,IAAI,CAACoB,MAAL;UACD;QACF;MACF,CAtJM;;MAwJP;MACAuC,mBAAmB,CAAC3D,IAAD,EAAOC,KAAP,EAAoB;QACrC,IACE,CAACoB,CAAC,CAACuC,sBAAF,CAAyB5D,IAAI,CAACyC,IAAL,CAAUoB,UAAnC,CAAD,IACA,CAACxC,CAAC,CAACyC,kBAAF,CAAqB9D,IAAI,CAACyC,IAAL,CAAUoB,UAAV,CAAqBE,IAA1C,CADD,IAEC/D,IAAI,CAACyC,IAAL,CAAUoB,UAAV,CAAqBE,IAArB,CAA0BC,MAA3B,CAAmDpE,IAAnD,KAA6D,SAH/D,EAIE;UACA;QACD;;QAED,MAAMuD,UAAU,GAAInD,IAAI,CAACyC,IAAL,CAAUoB,UAAV,CAAqBE,IAArB,CAA0BE,QAA3B,CAChBrE,IADH;;QAEA,IAAIuD,UAAU,IAAI5D,YAAY,CAAC+C,QAAb,CAAsBa,UAAtB,CAAlB,EAAqD;UACnDlD,KAAK,CAACC,UAAN,GAAmB,IAAnB;UACAF,IAAI,CAACoB,MAAL;QACD;MACF;;IAxKM;EAFJ,CAAP;AA6KD,CA3Lc,C"}