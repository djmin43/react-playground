{"version":3,"file":"cache.js","names":["MAX_CACHE_SIZE","TTL","Number","MAX_SAFE_INTEGER","GatsbyCache","constructor","name","store","fsStore","directory","path","join","global","__GATSBY","root","process","cwd","init","fs","ensureDirSync","configs","max","ttl","options","caches","map","cache","manager","caching","multiCaching","get","key","Promise","resolve","Error","err","res","undefined","set","value","args","del"],"sources":["../../src/utils/cache.ts"],"sourcesContent":["import manager, {\n  Store,\n  StoreConfig,\n  CachingConfig,\n  MultiCache,\n} from \"cache-manager\"\nimport fs from \"fs-extra\"\nimport * as fsStore from \"../cache/cache-fs\"\nimport path from \"path\"\n\nconst MAX_CACHE_SIZE = 250\nconst TTL = Number.MAX_SAFE_INTEGER\n\ninterface ICacheProperties {\n  name?: string\n  store?: Store\n}\n\nexport default class GatsbyCache {\n  public name: string\n  public store: Store\n  public directory: string\n  // TODO: remove `.cache` in v4. This is compat mode - cache-manager cache implementation\n  // expose internal cache that gives access to `.del` function that wasn't available in public\n  // cache interface (gatsby-plugin-sharp use it to clear no longer needed data)\n  public cache?: MultiCache\n\n  // @ts-ignore - set & get types are missing from fsStore?\n  constructor({ name = `db`, store = fsStore }: ICacheProperties = {}) {\n    this.name = name\n    this.store = store\n    this.directory = path.join(\n      global.__GATSBY?.root ?? process.cwd(),\n      `.cache`,\n      `caches`,\n      name\n    )\n  }\n\n  init(): GatsbyCache {\n    fs.ensureDirSync(this.directory)\n\n    const configs: Array<StoreConfig> = [\n      {\n        store: `memory`,\n        max: MAX_CACHE_SIZE,\n        ttl: TTL,\n      },\n      {\n        store: this.store,\n        ttl: TTL,\n        options: {\n          path: this.directory,\n          ttl: TTL,\n        },\n      },\n    ]\n\n    const caches = configs.map(cache => manager.caching(cache))\n\n    this.cache = manager.multiCaching(caches)\n\n    return this\n  }\n\n  async get<T = unknown>(key): Promise<T | undefined> {\n    return new Promise(resolve => {\n      if (!this.cache) {\n        throw new Error(\n          `GatsbyCache wasn't initialised yet, please run the init method first`\n        )\n      }\n      this.cache.get<T>(key, (err, res) => {\n        resolve(err ? undefined : res)\n      })\n    })\n  }\n\n  async set<T>(\n    key: string,\n    value: T,\n    args: CachingConfig = { ttl: TTL }\n  ): Promise<T | undefined> {\n    return new Promise(resolve => {\n      if (!this.cache) {\n        throw new Error(\n          `GatsbyCache wasn't initialised yet, please run the init method first`\n        )\n      }\n      this.cache.set(key, value, args, err => {\n        resolve(err ? undefined : value)\n      })\n    })\n  }\n\n  async del(key: string): Promise<void> {\n    if (!this.cache) {\n      throw new Error(\n        `GatsbyCache wasn't initialised yet, please run the init method first`\n      )\n    }\n\n    return this.cache.del(key)\n  }\n}\n"],"mappings":";;;;;;;AAAA;;AAMA;;AACA;;AACA;;;;;;AAEA,MAAMA,cAAc,GAAG,GAAvB;AACA,MAAMC,GAAG,GAAGC,MAAM,CAACC,gBAAnB;;AAOe,MAAMC,WAAN,CAAkB;EAI/B;EACA;EACA;EAGA;EACAC,WAAW,CAAC;IAAEC,IAAI,GAAI,IAAV;IAAeC,KAAK,GAAGC;EAAvB,IAAqD,EAAtD,EAA0D;IAAA;;IACnE,KAAKF,IAAL,GAAYA,IAAZ;IACA,KAAKC,KAAL,GAAaA,KAAb;IACA,KAAKE,SAAL,GAAiBC,aAAA,CAAKC,IAAL,8CACfC,MAAM,CAACC,QADQ,qDACf,iBAAiBC,IADF,yEACUC,OAAO,CAACC,GAAR,EADV,EAEd,QAFc,EAGd,QAHc,EAIfV,IAJe,CAAjB;EAMD;;EAEDW,IAAI,GAAgB;IAClBC,gBAAA,CAAGC,aAAH,CAAiB,KAAKV,SAAtB;;IAEA,MAAMW,OAA2B,GAAG,CAClC;MACEb,KAAK,EAAG,QADV;MAEEc,GAAG,EAAErB,cAFP;MAGEsB,GAAG,EAAErB;IAHP,CADkC,EAMlC;MACEM,KAAK,EAAE,KAAKA,KADd;MAEEe,GAAG,EAAErB,GAFP;MAGEsB,OAAO,EAAE;QACPb,IAAI,EAAE,KAAKD,SADJ;QAEPa,GAAG,EAAErB;MAFE;IAHX,CANkC,CAApC;IAgBA,MAAMuB,MAAM,GAAGJ,OAAO,CAACK,GAAR,CAAYC,KAAK,IAAIC,qBAAA,CAAQC,OAAR,CAAgBF,KAAhB,CAArB,CAAf;IAEA,KAAKA,KAAL,GAAaC,qBAAA,CAAQE,YAAR,CAAqBL,MAArB,CAAb;IAEA,OAAO,IAAP;EACD;;EAEQ,MAAHM,GAAG,CAAcC,GAAd,EAA2C;IAClD,OAAO,IAAIC,OAAJ,CAAYC,OAAO,IAAI;MAC5B,IAAI,CAAC,KAAKP,KAAV,EAAiB;QACf,MAAM,IAAIQ,KAAJ,CACH,sEADG,CAAN;MAGD;;MACD,KAAKR,KAAL,CAAWI,GAAX,CAAkBC,GAAlB,EAAuB,CAACI,GAAD,EAAMC,GAAN,KAAc;QACnCH,OAAO,CAACE,GAAG,GAAGE,SAAH,GAAeD,GAAnB,CAAP;MACD,CAFD;IAGD,CATM,CAAP;EAUD;;EAEQ,MAAHE,GAAG,CACPP,GADO,EAEPQ,KAFO,EAGPC,IAAmB,GAAG;IAAElB,GAAG,EAAErB;EAAP,CAHf,EAIiB;IACxB,OAAO,IAAI+B,OAAJ,CAAYC,OAAO,IAAI;MAC5B,IAAI,CAAC,KAAKP,KAAV,EAAiB;QACf,MAAM,IAAIQ,KAAJ,CACH,sEADG,CAAN;MAGD;;MACD,KAAKR,KAAL,CAAWY,GAAX,CAAeP,GAAf,EAAoBQ,KAApB,EAA2BC,IAA3B,EAAiCL,GAAG,IAAI;QACtCF,OAAO,CAACE,GAAG,GAAGE,SAAH,GAAeE,KAAnB,CAAP;MACD,CAFD;IAGD,CATM,CAAP;EAUD;;EAEQ,MAAHE,GAAG,CAACV,GAAD,EAA6B;IACpC,IAAI,CAAC,KAAKL,KAAV,EAAiB;MACf,MAAM,IAAIQ,KAAJ,CACH,sEADG,CAAN;IAGD;;IAED,OAAO,KAAKR,KAAL,CAAWe,GAAX,CAAeV,GAAf,CAAP;EACD;;AArF8B"}