{"version":3,"file":"babel-loader-helpers.js","names":["path","require","_","loadCachedConfig","pluginBabelConfig","stages","test","plugins","presets","process","env","NODE_ENV","join","cwd","getCustomOptions","stage","options","configItemsMemoCache","Map","prepareOptions","babel","customOptions","resolve","reactRuntime","reactImportSource","isPageTemplate","resourceQuery","configItemsMemoCacheKey","has","get","requiredPlugins","createConfigItem","staticQueryDir","type","apis","push","requiredPresets","fallbackPresets","reduxPlugins","reduxPresets","forEach","plugin","name","preset","toReturn","set","addRequiredPresetOptions","gatsbyPresetResolved","index","findIndex","p","file","resolved","mergeConfigItemOptions","items","itemToMerge","i","merge","exports"],"sources":["../../src/utils/babel-loader-helpers.js"],"sourcesContent":["const path = require(`path`)\nconst _ = require(`lodash`)\n\nconst loadCachedConfig = () => {\n  let pluginBabelConfig = {\n    stages: {\n      test: { plugins: [], presets: [] },\n    },\n  }\n  if (process.env.NODE_ENV !== `test`) {\n    pluginBabelConfig = require(path.join(\n      process.cwd(),\n      `./.cache/babelState.json`\n    ))\n  }\n  return pluginBabelConfig\n}\n\nconst getCustomOptions = stage => {\n  const pluginBabelConfig = loadCachedConfig()\n  return pluginBabelConfig.stages[stage].options\n}\n\n/**\n * https://babeljs.io/docs/en/babel-core#createconfigitem\n * If this function is called multiple times for a given plugin,\n * Babel will call the plugin's function itself multiple times.\n * If you have a clear set of expected plugins and presets to inject,\n * pre-constructing the config items would be recommended.\n */\nconst configItemsMemoCache = new Map()\n\nconst prepareOptions = (\n  babel,\n  customOptions = {},\n  resolve = require.resolve\n) => {\n  const {\n    stage,\n    reactRuntime,\n    reactImportSource,\n    isPageTemplate,\n    resourceQuery,\n  } = customOptions\n\n  const configItemsMemoCacheKey = `${stage}-${isPageTemplate}-${resourceQuery}`\n\n  if (configItemsMemoCache.has(configItemsMemoCacheKey)) {\n    return configItemsMemoCache.get(configItemsMemoCacheKey)\n  }\n\n  const pluginBabelConfig = loadCachedConfig()\n\n  // Required plugins/presets\n  const requiredPlugins = [\n    babel.createConfigItem(\n      [\n        resolve(`babel-plugin-remove-graphql-queries`),\n        { stage, staticQueryDir: `page-data/sq/d` },\n      ],\n      {\n        type: `plugin`,\n      }\n    ),\n  ]\n\n  if (\n    _CFLAGS_.GATSBY_MAJOR === `4` &&\n    (stage === `develop` || stage === `build-javascript`) &&\n    isPageTemplate\n  ) {\n    const apis = [`getServerData`, `config`]\n\n    if (resourceQuery === `?export=default`) {\n      apis.push(`Head`)\n    }\n\n    if (resourceQuery === `?export=head`) {\n      apis.push(`default`)\n    }\n\n    requiredPlugins.push(\n      babel.createConfigItem(\n        [\n          resolve(`./babel/babel-plugin-remove-api`),\n          {\n            apis,\n          },\n        ],\n        {\n          type: `plugin`,\n        }\n      )\n    )\n  }\n\n  const requiredPresets = []\n\n  // Stage specific plugins to add\n  if (\n    _CFLAGS_.GATSBY_MAJOR !== `4` &&\n    (stage === `build-html` || stage === `develop-html`)\n  ) {\n    requiredPlugins.push(\n      babel.createConfigItem([resolve(`babel-plugin-dynamic-import-node`)], {\n        type: `plugin`,\n      })\n    )\n  }\n\n  if (stage === `develop`) {\n    requiredPlugins.push(\n      babel.createConfigItem([resolve(`react-refresh/babel`)], {\n        type: `plugin`,\n      })\n    )\n  }\n\n  // Fallback preset\n  const fallbackPresets = []\n\n  fallbackPresets.push(\n    babel.createConfigItem(\n      [\n        resolve(`babel-preset-gatsby`),\n        {\n          stage,\n          reactRuntime,\n          reactImportSource,\n        },\n      ],\n      {\n        type: `preset`,\n      }\n    )\n  )\n\n  // Go through babel state and create config items for presets/plugins from.\n  const reduxPlugins = []\n  const reduxPresets = []\n  pluginBabelConfig.stages[stage].plugins.forEach(plugin => {\n    reduxPlugins.push(\n      babel.createConfigItem([resolve(plugin.name), plugin.options], {\n        name: plugin.name,\n        type: `plugin`,\n      })\n    )\n  })\n  pluginBabelConfig.stages[stage].presets.forEach(preset => {\n    reduxPresets.push(\n      babel.createConfigItem([resolve(preset.name), preset.options], {\n        name: preset.name,\n        type: `preset`,\n      })\n    )\n  })\n\n  const toReturn = [\n    reduxPresets,\n    reduxPlugins,\n    requiredPresets,\n    requiredPlugins,\n    fallbackPresets,\n  ]\n\n  configItemsMemoCache.set(configItemsMemoCacheKey, toReturn)\n\n  return toReturn\n}\n\nconst addRequiredPresetOptions = (\n  babel,\n  presets,\n  options = {},\n  resolve = require.resolve\n) => {\n  // Always pass `stage` option to babel-preset-gatsby\n  //  (even if defined in custom babelrc)\n  const gatsbyPresetResolved = resolve(`babel-preset-gatsby`)\n  const index = presets.findIndex(p => p.file.resolved === gatsbyPresetResolved)\n\n  if (index !== -1) {\n    presets[index] = babel.createConfigItem(\n      [\n        gatsbyPresetResolved,\n        { ...presets[index].options, stage: options.stage },\n      ],\n      { type: `preset` }\n    )\n  }\n  return presets\n}\n\nconst mergeConfigItemOptions = ({ items, itemToMerge, type, babel }) => {\n  const index = _.findIndex(\n    items,\n    i => i.file.resolved === itemToMerge.file.resolved\n  )\n\n  // If this exist, merge the options, otherwise, add it to the array\n  if (index !== -1) {\n    items[index] = babel.createConfigItem(\n      [\n        itemToMerge.file.resolved,\n        _.merge({}, items[index].options, itemToMerge.options),\n      ],\n      {\n        type,\n      }\n    )\n  } else {\n    items.push(itemToMerge)\n  }\n\n  return items\n}\n\nexports.getCustomOptions = getCustomOptions\n\n// Export helper functions for testing\nexports.prepareOptions = prepareOptions\nexports.mergeConfigItemOptions = mergeConfigItemOptions\nexports.addRequiredPresetOptions = addRequiredPresetOptions\n"],"mappings":"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"}