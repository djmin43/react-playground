{"version":3,"file":"state-machine-logging.js","names":["isInterpreter","actor","logTransitions","service","listeners","WeakSet","last","onTransition","state","changed","matches","process","env","gatsby_log_level","reporter","verbose","JSON","stringify","value","children","forEach","child","has","sublast","substate","add"],"sources":["../../src/utils/state-machine-logging.ts"],"sourcesContent":["import {\n  DefaultContext,\n  Interpreter,\n  Actor,\n  State,\n  AnyEventObject,\n} from \"xstate\"\nimport reporter from \"gatsby-cli/lib/reporter\"\n\nconst isInterpreter = <T>(\n  actor: Actor<T> | Interpreter<T>\n): actor is Interpreter<T> => `machine` in actor\n\nexport function logTransitions<T = DefaultContext>(\n  service: Interpreter<T>\n): void {\n  const listeners = new WeakSet()\n  let last: State<T, AnyEventObject, any, any>\n\n  service.onTransition(state => {\n    if (!last) {\n      last = state\n    } else if (!state.changed || last.matches(state)) {\n      return\n    }\n    last = state\n    if (process.env.gatsby_log_level === `verbose`) {\n      reporter.verbose(`Transition to ${JSON.stringify(state.value)}`)\n    }\n    // eslint-disable-next-line no-unused-expressions\n    service.children?.forEach(child => {\n      // We want to ensure we don't attach a listener to the same\n      // actor. We don't need to worry about detaching the listener\n      // because xstate handles that for us when the actor is stopped.\n\n      // @ts-ignore - TODO: Fix it\n      if (isInterpreter(child) && !listeners.has(child)) {\n        let sublast = child.state\n        child.onTransition(substate => {\n          if (!sublast) {\n            sublast = substate\n          } else if (!substate.changed || sublast.matches(substate)) {\n            return\n          }\n          sublast = substate\n          if (process.env.gatsby_log_level === `verbose`) {\n            reporter.verbose(\n              `Transition to ${JSON.stringify(state.value)} > ${JSON.stringify(\n                substate.value\n              )}`\n            )\n          }\n        })\n        listeners.add(child)\n      }\n    })\n  })\n}\n"],"mappings":";;;;;;;AAOA;;AAEA,MAAMA,aAAa,GACjBC,KADoB,IAES,SAAD,IAAaA,KAF3C;;AAIO,SAASC,cAAT,CACLC,OADK,EAEC;EACN,MAAMC,SAAS,GAAG,IAAIC,OAAJ,EAAlB;EACA,IAAIC,IAAJ;EAEAH,OAAO,CAACI,YAAR,CAAqBC,KAAK,IAAI;IAAA;;IAC5B,IAAI,CAACF,IAAL,EAAW;MACTA,IAAI,GAAGE,KAAP;IACD,CAFD,MAEO,IAAI,CAACA,KAAK,CAACC,OAAP,IAAkBH,IAAI,CAACI,OAAL,CAAaF,KAAb,CAAtB,EAA2C;MAChD;IACD;;IACDF,IAAI,GAAGE,KAAP;;IACA,IAAIG,OAAO,CAACC,GAAR,CAAYC,gBAAZ,KAAkC,SAAtC,EAAgD;MAC9CC,iBAAA,CAASC,OAAT,CAAkB,iBAAgBC,IAAI,CAACC,SAAL,CAAeT,KAAK,CAACU,KAArB,CAA4B,EAA9D;IACD,CAT2B,CAU5B;;;IACA,qBAAAf,OAAO,CAACgB,QAAR,wEAAkBC,OAAlB,CAA0BC,KAAK,IAAI;MACjC;MACA;MACA;MAEA;MACA,IAAIrB,aAAa,CAACqB,KAAD,CAAb,IAAwB,CAACjB,SAAS,CAACkB,GAAV,CAAcD,KAAd,CAA7B,EAAmD;QACjD,IAAIE,OAAO,GAAGF,KAAK,CAACb,KAApB;QACAa,KAAK,CAACd,YAAN,CAAmBiB,QAAQ,IAAI;UAC7B,IAAI,CAACD,OAAL,EAAc;YACZA,OAAO,GAAGC,QAAV;UACD,CAFD,MAEO,IAAI,CAACA,QAAQ,CAACf,OAAV,IAAqBc,OAAO,CAACb,OAAR,CAAgBc,QAAhB,CAAzB,EAAoD;YACzD;UACD;;UACDD,OAAO,GAAGC,QAAV;;UACA,IAAIb,OAAO,CAACC,GAAR,CAAYC,gBAAZ,KAAkC,SAAtC,EAAgD;YAC9CC,iBAAA,CAASC,OAAT,CACG,iBAAgBC,IAAI,CAACC,SAAL,CAAeT,KAAK,CAACU,KAArB,CAA4B,MAAKF,IAAI,CAACC,SAAL,CAChDO,QAAQ,CAACN,KADuC,CAEhD,EAHJ;UAKD;QACF,CAdD;QAeAd,SAAS,CAACqB,GAAV,CAAcJ,KAAd;MACD;IACF,CAzBD;EA0BD,CArCD;AAsCD"}