{"version":3,"file":"show-experiment-notice.js","names":["ONE_DAY","noticesToShow","configStoreKey","experimentIdentifier","showExperimentNoticeAfterTimeout","umbrellaLink","noticeText","showNoticeAfterMs","minimumIntervalBetweenNoticesMs","lastTimeWeShowedNotice","getConfigStore","get","Date","now","undefined","noticeTimeout","setTimeout","push","clearNoticeTimeout","clearTimeout","createNoticeMessage","notices","message","forEach","notice","chalk","bgBlue","bold","showExperimentNotices","length","telemetry","trackCli","set","reporter","info"],"sources":["../../src/utils/show-experiment-notice.ts"],"sourcesContent":["import { getConfigStore } from \"gatsby-core-utils\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport chalk from \"chalk\"\nimport telemetry from \"gatsby-telemetry\"\n\ntype CancelExperimentNoticeCallback = () => void\n\nexport type CancelExperimentNoticeCallbackOrUndefined =\n  | CancelExperimentNoticeCallback\n  | undefined\n\nconst ONE_DAY = 24 * 60 * 60 * 1000\n\ninterface INoticeObject {\n  noticeText: string\n  umbrellaLink: string\n  experimentIdentifier: string\n}\n\nconst noticesToShow: Array<INoticeObject> = []\nconst configStoreKey = (experimentIdentifier): string =>\n  `lastExperimentNotice.${experimentIdentifier}`\n\nexport function showExperimentNoticeAfterTimeout(\n  experimentIdentifier: string,\n  umbrellaLink: string,\n  noticeText: string,\n  showNoticeAfterMs: number,\n  minimumIntervalBetweenNoticesMs: number = ONE_DAY\n): CancelExperimentNoticeCallbackOrUndefined {\n  const lastTimeWeShowedNotice = getConfigStore().get(\n    configStoreKey(experimentIdentifier)\n  )\n\n  if (lastTimeWeShowedNotice) {\n    if (Date.now() - lastTimeWeShowedNotice < minimumIntervalBetweenNoticesMs) {\n      return undefined\n    }\n  }\n\n  const noticeTimeout = setTimeout(() => {\n    noticesToShow.push({ noticeText, umbrellaLink, experimentIdentifier })\n  }, showNoticeAfterMs)\n\n  return function clearNoticeTimeout(): void {\n    clearTimeout(noticeTimeout)\n  }\n}\n\nexport const createNoticeMessage = (notices): string => {\n  let message = `\\nHi from the Gatsby maintainers! Based on what we see in your site, these coming\nfeatures may help you. All of these can be enabled within gatsby-config.js via\nflags (samples below)`\n\n  notices.forEach(\n    notice =>\n      (message += `\n\n${chalk.bgBlue.bold(notice.experimentIdentifier)} (${notice.umbrellaLink}), ${\n        notice.noticeText\n      }\\n`)\n  )\n\n  return message\n}\n\nexport const showExperimentNotices = (): void => {\n  if (noticesToShow.length > 0) {\n    telemetry.trackCli(`InviteToTryExperiment`)\n    // Store that we're showing the invite.\n    noticesToShow.forEach(notice =>\n      getConfigStore().set(\n        configStoreKey(notice.experimentIdentifier),\n        Date.now()\n      )\n    )\n\n    const message = createNoticeMessage(noticesToShow)\n    reporter.info(message)\n  }\n}\n"],"mappings":";;;;;;;;;AAAA;;AACA;;AACA;;AACA;;AAQA,MAAMA,OAAO,GAAG,KAAK,EAAL,GAAU,EAAV,GAAe,IAA/B;AAQA,MAAMC,aAAmC,GAAG,EAA5C;;AACA,MAAMC,cAAc,GAAIC,oBAAD,IACpB,wBAAuBA,oBAAqB,EAD/C;;AAGO,SAASC,gCAAT,CACLD,oBADK,EAELE,YAFK,EAGLC,UAHK,EAILC,iBAJK,EAKLC,+BAAuC,GAAGR,OALrC,EAMsC;EAC3C,MAAMS,sBAAsB,GAAG,IAAAC,+BAAA,IAAiBC,GAAjB,CAC7BT,cAAc,CAACC,oBAAD,CADe,CAA/B;;EAIA,IAAIM,sBAAJ,EAA4B;IAC1B,IAAIG,IAAI,CAACC,GAAL,KAAaJ,sBAAb,GAAsCD,+BAA1C,EAA2E;MACzE,OAAOM,SAAP;IACD;EACF;;EAED,MAAMC,aAAa,GAAGC,UAAU,CAAC,MAAM;IACrCf,aAAa,CAACgB,IAAd,CAAmB;MAAEX,UAAF;MAAcD,YAAd;MAA4BF;IAA5B,CAAnB;EACD,CAF+B,EAE7BI,iBAF6B,CAAhC;EAIA,OAAO,SAASW,kBAAT,GAAoC;IACzCC,YAAY,CAACJ,aAAD,CAAZ;EACD,CAFD;AAGD;;AAEM,MAAMK,mBAAmB,GAAIC,OAAD,IAAqB;EACtD,IAAIC,OAAO,GAAI;AACjB;AACA,sBAFE;EAIAD,OAAO,CAACE,OAAR,CACEC,MAAM,IACHF,OAAO,IAAK;AACnB;AACA,EAAEG,cAAA,CAAMC,MAAN,CAAaC,IAAb,CAAkBH,MAAM,CAACrB,oBAAzB,CAA+C,KAAIqB,MAAM,CAACnB,YAAa,MACjEmB,MAAM,CAAClB,UACR,IANL;EASA,OAAOgB,OAAP;AACD,CAfM;;;;AAiBA,MAAMM,qBAAqB,GAAG,MAAY;EAC/C,IAAI3B,aAAa,CAAC4B,MAAd,GAAuB,CAA3B,EAA8B;IAC5BC,wBAAA,CAAUC,QAAV,CAAoB,uBAApB,EAD4B,CAE5B;;;IACA9B,aAAa,CAACsB,OAAd,CAAsBC,MAAM,IAC1B,IAAAd,+BAAA,IAAiBsB,GAAjB,CACE9B,cAAc,CAACsB,MAAM,CAACrB,oBAAR,CADhB,EAEES,IAAI,CAACC,GAAL,EAFF,CADF;IAOA,MAAMS,OAAO,GAAGF,mBAAmB,CAACnB,aAAD,CAAnC;;IACAgC,iBAAA,CAASC,IAAT,CAAcZ,OAAd;EACD;AACF,CAdM"}