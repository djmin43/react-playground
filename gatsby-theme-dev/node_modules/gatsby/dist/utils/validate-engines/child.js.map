{"version":3,"file":"child.js","names":["originalModuleLoad","mod","_load","EngineValidationError","Error","constructor","request","relativeToRoot","parent","parentPath","filename","validate","directory","isMain","builtinModules","includes","allowedPrefixes","path","join","localRequire","createRequire","absPath","resolve","relative","allowedPrefix","startsWith","process","env","GATSBY_WORKER_MODULE_PATH","GraphQLEngine","require","graphqlEngine","dbPath","ready"],"sources":["../../../src/utils/validate-engines/child.ts"],"sourcesContent":["import mod from \"module\"\nimport * as path from \"path\"\n\n// @ts-ignore TS doesn't like accessing `_load`\nconst originalModuleLoad = mod._load\n\nclass EngineValidationError extends Error {\n  request: string\n  relativeToRoot: string\n  parentPath: string\n\n  constructor({\n    request,\n    relativeToRoot,\n    parent,\n  }: {\n    request: string\n    relativeToRoot: string\n    parent: mod\n  }) {\n    super(\n      `Generated engines use disallowed import \"${request}\". Only allowed imports are to Node.js builtin modules or engines internals.`\n    )\n    this.request = request\n    this.relativeToRoot = relativeToRoot\n    this.parentPath = parent.filename\n  }\n}\n\nexport async function validate(directory: string): Promise<void> {\n  // intercept module loading and validate no unexpected imports are happening\n  // @ts-ignore TS doesn't like accessing `_load`\n  mod._load = (request: string, parent: mod, isMain: boolean): any => {\n    // Allow all node builtins\n    if (mod.builtinModules.includes(request)) {\n      return originalModuleLoad(request, parent, isMain)\n    }\n\n    // Allow imports to modules in engines directory.\n    // For example: importing \".cache/page-ssr/routes/render-page\" from\n    // page-ssr engine should be allowed as it is part of engine.\n    const allowedPrefixes = [\n      path.join(`.cache`, `query-engine`),\n      path.join(`.cache`, `page-ssr`),\n    ]\n    const localRequire = mod.createRequire(parent.filename)\n    const absPath = localRequire.resolve(request)\n    const relativeToRoot = path.relative(directory, absPath)\n    for (const allowedPrefix of allowedPrefixes) {\n      if (relativeToRoot.startsWith(allowedPrefix)) {\n        return originalModuleLoad(request, parent, isMain)\n      }\n    }\n\n    // We throw on anything that is not allowed\n    // Runtime might have try/catch for it and continue to work\n    // (for example`msgpackr` have fallback if native `msgpack-extract` can't be loaded)\n    // and we don't fail validation in those cases because error we throw will be handled.\n    // We do want to fail validation if there is no fallback\n    throw new EngineValidationError({ request, relativeToRoot, parent })\n  }\n\n  // workaround for gatsby-worker issue:\n  // gatsby-worker gets bundled in engines and it will auto-init \"child\" module\n  // if GATSBY_WORKER_MODULE_PATH env var is set. To prevent this we just unset\n  // env var so it's falsy.\n  process.env.GATSBY_WORKER_MODULE_PATH = ``\n\n  // import engines, initiate them, if there is any error thrown it will be handled in parent process\n  const { GraphQLEngine } = require(path.join(\n    directory,\n    `.cache`,\n    `query-engine`\n  ))\n  require(path.join(directory, `.cache`, `page-ssr`))\n  const graphqlEngine = new GraphQLEngine({\n    dbPath: path.join(directory, `.cache`, `data`, `datastore`),\n  })\n  await graphqlEngine.ready()\n}\n"],"mappings":";;;;;;;AAAA;;AACA;;;;;;AAEA;AACA,MAAMA,kBAAkB,GAAGC,eAAA,CAAIC,KAA/B;;AAEA,MAAMC,qBAAN,SAAoCC,KAApC,CAA0C;EAKxCC,WAAW,CAAC;IACVC,OADU;IAEVC,cAFU;IAGVC;EAHU,CAAD,EAQR;IACD,MACG,4CAA2CF,OAAQ,8EADtD;IAGA,KAAKA,OAAL,GAAeA,OAAf;IACA,KAAKC,cAAL,GAAsBA,cAAtB;IACA,KAAKE,UAAL,GAAkBD,MAAM,CAACE,QAAzB;EACD;;AApBuC;;AAuBnC,eAAeC,QAAf,CAAwBC,SAAxB,EAA0D;EAC/D;EACA;EACAX,eAAA,CAAIC,KAAJ,GAAY,CAACI,OAAD,EAAkBE,MAAlB,EAA+BK,MAA/B,KAAwD;IAClE;IACA,IAAIZ,eAAA,CAAIa,cAAJ,CAAmBC,QAAnB,CAA4BT,OAA5B,CAAJ,EAA0C;MACxC,OAAON,kBAAkB,CAACM,OAAD,EAAUE,MAAV,EAAkBK,MAAlB,CAAzB;IACD,CAJiE,CAMlE;IACA;IACA;;;IACA,MAAMG,eAAe,GAAG,CACtBC,IAAI,CAACC,IAAL,CAAW,QAAX,EAAqB,cAArB,CADsB,EAEtBD,IAAI,CAACC,IAAL,CAAW,QAAX,EAAqB,UAArB,CAFsB,CAAxB;;IAIA,MAAMC,YAAY,GAAGlB,eAAA,CAAImB,aAAJ,CAAkBZ,MAAM,CAACE,QAAzB,CAArB;;IACA,MAAMW,OAAO,GAAGF,YAAY,CAACG,OAAb,CAAqBhB,OAArB,CAAhB;IACA,MAAMC,cAAc,GAAGU,IAAI,CAACM,QAAL,CAAcX,SAAd,EAAyBS,OAAzB,CAAvB;;IACA,KAAK,MAAMG,aAAX,IAA4BR,eAA5B,EAA6C;MAC3C,IAAIT,cAAc,CAACkB,UAAf,CAA0BD,aAA1B,CAAJ,EAA8C;QAC5C,OAAOxB,kBAAkB,CAACM,OAAD,EAAUE,MAAV,EAAkBK,MAAlB,CAAzB;MACD;IACF,CApBiE,CAsBlE;IACA;IACA;IACA;IACA;;;IACA,MAAM,IAAIV,qBAAJ,CAA0B;MAAEG,OAAF;MAAWC,cAAX;MAA2BC;IAA3B,CAA1B,CAAN;EACD,CA5BD,CAH+D,CAiC/D;EACA;EACA;EACA;;;EACAkB,OAAO,CAACC,GAAR,CAAYC,yBAAZ,GAAyC,EAAzC,CArC+D,CAuC/D;;EACA,MAAM;IAAEC;EAAF,IAAoBC,OAAO,CAACb,IAAI,CAACC,IAAL,CAChCN,SADgC,EAE/B,QAF+B,EAG/B,cAH+B,CAAD,CAAjC;;EAKAkB,OAAO,CAACb,IAAI,CAACC,IAAL,CAAUN,SAAV,EAAsB,QAAtB,EAAgC,UAAhC,CAAD,CAAP;;EACA,MAAMmB,aAAa,GAAG,IAAIF,aAAJ,CAAkB;IACtCG,MAAM,EAAEf,IAAI,CAACC,IAAL,CAAUN,SAAV,EAAsB,QAAtB,EAAgC,MAAhC,EAAwC,WAAxC;EAD8B,CAAlB,CAAtB;EAGA,MAAMmB,aAAa,CAACE,KAAd,EAAN;AACD"}