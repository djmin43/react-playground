{"version":3,"file":"api-runner-node.js","names":["Promise","require","_","chalk","bindActionCreators","origBindActionCreators","memoize","tracer","globalTracer","reporter","stackTrace","codeFrameColumns","fs","getCache","createContentDigest","_createContentDigest","emitter","store","getNodes","getNode","getNodesByType","getNodeAndSavePathDependency","loadNodeContent","getPublicPath","requireGatsbyPlugin","getNonGatsbyCodeFrameFormatted","trackBuildError","decorateEvent","node","internal","type","contentDigest","undefined","owner","fieldOwners","ignoreType","counter","fields","process","env","BLUEBIRD_DEBUG","BLUEBIRD_LONG_STACK_TRACES","config","longStackTraces","nodeMutationsWrappers","id","wrapNode","wrapNodes","boundPluginActionCreators","doubleBind","boundActionCreators","api","plugin","actionOptions","traceId","deferNodeMutation","defer","actionKey","name","keys","Object","doubleBoundActionCreators","i","length","key","boundActionCreator","args","initAPICallTracing","parentSpan","startSpan","spanName","spanArgs","defaultSpanArgs","childOf","merge","deferredAction","resolve","emit","payload","NODE_MUTATION_ACTIONS","deferActions","actions","deferred","forEach","action","getLocalReporter","activity","panicOnBuild","bind","getErrorMapWithPluginName","pluginName","errorMap","entries","reduce","memo","val","extendLocalReporterToCatchPluginErrors","runningActivities","setErrorMap","error","panic","errorMeta","activityTimer","apply","originalStart","start","originalEnd","end","add","delete","createProgress","originalDone","done","getUninitializedCache","message","get","Error","set","del","availableActionsCache","Map","publicPath","runAPI","gatsbyNode","spanOptions","pluginSpan","setTag","publicActions","restrictedActionsAvailableInAPI","availableActions","has","dispatch","program","getState","pathPrefix","prefixPaths","namespacedCreateNodeId","createNodeId","tracing","cache","apiFinished","alreadyDisplayed","createPageAction","createPage","warning","stripIndent","bold","possiblyCodeFrame","push","warn","join","localReporter","Set","extendedLocalReporter","endInProgressActivitiesCreatedByThisRun","shouldDetectNodeMutations","includes","apiCallArgs","basePath","schema","buildObjectType","buildUnionType","buildInterfaceType","buildInputObjectType","buildEnumType","buildScalarType","pluginOptions","fromCallback","callback","cb","err","finish","e","version","apisRunningById","apisRunningByTraceId","waitingForCasacadeToFinish","apiRunnerNode","pluginSource","plugins","flattenedPlugins","implementingPlugins","filter","nodeAPIs","traceTags","waitForCascadingActions","apiSpanArgs","apiSpan","value","apiRunInstance","span","startTime","Date","toJSON","filename","page","path","argsJson","JSON","stringify","omit","size","currentCount","stopQueuedApiRuns","onAPIRunComplete","actionHandler","on","off","apiRunPromiseOptions","runPromise","GATSBY_EXPERIMENTAL_PARALLEL_SOURCING","map","concurrency","mapSeries","unstable_shouldOnCreateNode","catch","file","parse","find","test","fileName","codeFrame","structuredError","errorParser","lineNumber","line","columnNumber","column","trimmedFileName","match","code","readFileSync","encoding","highlightCode","_e","location","filePath","context","then","results","result","isEmpty","instance","apisByTraceIdCount","module","exports"],"sources":["../../src/utils/api-runner-node.js"],"sourcesContent":["const Promise = require(`bluebird`)\nconst _ = require(`lodash`)\nconst chalk = require(`chalk`)\nconst { bindActionCreators: origBindActionCreators } = require(`redux`)\nconst memoize = require(`memoizee`)\n\nconst bindActionCreators = memoize(origBindActionCreators)\n\nconst tracer = require(`opentracing`).globalTracer()\nconst reporter = require(`gatsby-cli/lib/reporter`)\nconst stackTrace = require(`stack-trace`)\nconst { codeFrameColumns } = require(`@babel/code-frame`)\nconst fs = require(`fs-extra`)\nconst { getCache } = require(`./get-cache`)\nimport { createNodeId } from \"./create-node-id\"\nconst {\n  createContentDigest: _createContentDigest,\n} = require(`gatsby-core-utils`)\nimport {\n  buildObjectType,\n  buildUnionType,\n  buildInterfaceType,\n  buildInputObjectType,\n  buildEnumType,\n  buildScalarType,\n} from \"../schema/types/type-builders\"\nconst { emitter, store } = require(`../redux`)\nconst { getNodes, getNode, getNodesByType } = require(`../datastore`)\nconst { getNodeAndSavePathDependency, loadNodeContent } = require(`./nodes`)\nconst { getPublicPath } = require(`./get-public-path`)\nconst { requireGatsbyPlugin } = require(`./require-gatsby-plugin`)\nconst { getNonGatsbyCodeFrameFormatted } = require(`./stack-trace-utils`)\nconst { trackBuildError, decorateEvent } = require(`gatsby-telemetry`)\nimport errorParser from \"./api-runner-error-parser\"\nimport { wrapNode, wrapNodes } from \"./detect-node-mutations\"\n\n// Override createContentDigest to remove autogenerated data from nodes to\n// ensure consistent digests.\nfunction createContentDigest(node) {\n  if (!node?.internal?.type) {\n    // this doesn't look like a node, so let's just pass it as-is\n    return _createContentDigest(node)\n  }\n  return _createContentDigest({\n    ...node,\n    internal: {\n      ...node.internal,\n      // Remove auto-generated fields that'd prevent\n      // creating a consistent contentDigest.\n      contentDigest: undefined,\n      owner: undefined,\n      fieldOwners: undefined,\n      ignoreType: undefined,\n      counter: undefined,\n    },\n    fields: undefined,\n  })\n}\n\nif (!process.env.BLUEBIRD_DEBUG && !process.env.BLUEBIRD_LONG_STACK_TRACES) {\n  // Unless specified - disable longStackTraces\n  // as this have severe perf penalty ( http://bluebirdjs.com/docs/api/promise.longstacktraces.html )\n  // This is mainly for `gatsby develop` due to NODE_ENV being set to development\n  // which cause bluebird to enable longStackTraces\n  // `gatsby build` (with NODE_ENV=production) already doesn't enable longStackTraces\n  Promise.config({ longStackTraces: false })\n}\n\nconst nodeMutationsWrappers = {\n  getNode(id) {\n    return wrapNode(getNode(id))\n  },\n  getNodes() {\n    return wrapNodes(getNodes())\n  },\n  getNodesByType(type) {\n    return wrapNodes(getNodesByType(type))\n  },\n  getNodeAndSavePathDependency(id) {\n    return wrapNode(getNodeAndSavePathDependency(id))\n  },\n}\n\n// Bind action creators per plugin so we can auto-add\n// metadata to actions they create.\nconst boundPluginActionCreators = {}\nconst doubleBind = (boundActionCreators, api, plugin, actionOptions) => {\n  const { traceId, deferNodeMutation } = actionOptions\n  const defer = deferNodeMutation ? `defer-node-mutation` : ``\n  const actionKey = plugin.name + api + traceId + defer\n  if (boundPluginActionCreators[actionKey]) {\n    return boundPluginActionCreators[actionKey]\n  } else {\n    const keys = Object.keys(boundActionCreators)\n    const doubleBoundActionCreators = {}\n    for (let i = 0; i < keys.length; i++) {\n      const key = keys[i]\n      const boundActionCreator = boundActionCreators[key]\n      if (typeof boundActionCreator === `function`) {\n        doubleBoundActionCreators[key] = (...args) => {\n          // Let action callers override who the plugin is. Shouldn't be\n          // used that often.\n          if (args.length === 1) {\n            return boundActionCreator(args[0], plugin, actionOptions)\n          } else if (args.length === 2) {\n            return boundActionCreator(args[0], args[1], actionOptions)\n          }\n          return undefined\n        }\n      }\n    }\n    boundPluginActionCreators[actionKey] = doubleBoundActionCreators\n    return doubleBoundActionCreators\n  }\n}\n\nconst initAPICallTracing = parentSpan => {\n  const startSpan = (spanName, spanArgs = {}) => {\n    const defaultSpanArgs = { childOf: parentSpan }\n\n    return tracer.startSpan(spanName, _.merge(defaultSpanArgs, spanArgs))\n  }\n\n  return {\n    tracer,\n    parentSpan,\n    startSpan,\n  }\n}\n\nconst deferredAction =\n  type =>\n  (...args) => {\n    // Regular createNode returns a Promise, but when deferred we need\n    // to wrap it in another which we resolve when it's actually called\n    if (type === `createNode`) {\n      return new Promise(resolve => {\n        emitter.emit(`ENQUEUE_NODE_MUTATION`, {\n          type,\n          payload: args,\n          resolve,\n        })\n      })\n    }\n    return emitter.emit(`ENQUEUE_NODE_MUTATION`, {\n      type,\n      payload: args,\n    })\n  }\n\nconst NODE_MUTATION_ACTIONS = [\n  `createNode`,\n  `deleteNode`,\n  `touchNode`,\n  `createParentChildLink`,\n  `createNodeField`,\n]\n\nconst deferActions = actions => {\n  const deferred = { ...actions }\n  NODE_MUTATION_ACTIONS.forEach(action => {\n    deferred[action] = deferredAction(action)\n  })\n  return deferred\n}\n\n/**\n * Create a local reporter\n * Used to override reporter methods with activity methods\n */\nfunction getLocalReporter({ activity, reporter }) {\n  // If we have an activity, bind panicOnBuild to the activities method to\n  // join them\n  if (activity) {\n    return { ...reporter, panicOnBuild: activity.panicOnBuild.bind(activity) }\n  }\n\n  return reporter\n}\n\nfunction getErrorMapWithPluginName(pluginName, errorMap) {\n  const entries = Object.entries(errorMap)\n\n  return entries.reduce((memo, [key, val]) => {\n    memo[`${pluginName}_${key}`] = val\n\n    return memo\n  }, {})\n}\n\nfunction extendLocalReporterToCatchPluginErrors({\n  reporter,\n  pluginName,\n  runningActivities,\n}) {\n  let setErrorMap\n\n  let error = reporter.error\n  let panic = reporter.panic\n  let panicOnBuild = reporter.panicOnBuild\n\n  if (pluginName && reporter?.setErrorMap) {\n    setErrorMap = errorMap =>\n      reporter.setErrorMap(getErrorMapWithPluginName(pluginName, errorMap))\n\n    error = (errorMeta, error) => {\n      reporter.error(errorMeta, error, pluginName)\n    }\n\n    panic = (errorMeta, error) => {\n      reporter.panic(errorMeta, error, pluginName)\n    }\n\n    panicOnBuild = (errorMeta, error) => {\n      reporter.panicOnBuild(errorMeta, error, pluginName)\n    }\n  }\n\n  return {\n    ...reporter,\n    setErrorMap,\n    error,\n    panic,\n    panicOnBuild,\n    activityTimer: (...args) => {\n      // eslint-disable-next-line prefer-spread\n      const activity = reporter.activityTimer.apply(reporter, args)\n\n      const originalStart = activity.start\n      const originalEnd = activity.end\n\n      activity.start = () => {\n        originalStart.apply(activity)\n        runningActivities.add(activity)\n      }\n\n      activity.end = () => {\n        originalEnd.apply(activity)\n        runningActivities.delete(activity)\n      }\n\n      return activity\n    },\n\n    createProgress: (...args) => {\n      // eslint-disable-next-line prefer-spread\n      const activity = reporter.createProgress.apply(reporter, args)\n\n      const originalStart = activity.start\n      const originalEnd = activity.end\n      const originalDone = activity.done\n\n      activity.start = () => {\n        originalStart.apply(activity)\n        runningActivities.add(activity)\n      }\n\n      activity.end = () => {\n        originalEnd.apply(activity)\n        runningActivities.delete(activity)\n      }\n\n      activity.done = () => {\n        originalDone.apply(activity)\n        runningActivities.delete(activity)\n      }\n\n      return activity\n    },\n  }\n}\n\nconst getUninitializedCache = plugin => {\n  const message =\n    `Usage of \"cache\" instance in \"onPreInit\" API is not supported as ` +\n    `this API runs before cache initialization` +\n    (plugin && plugin !== `default-site-plugin` ? ` (called in ${plugin})` : ``)\n\n  return {\n    // GatsbyCache\n    async get() {\n      throw new Error(message)\n    },\n    async set() {\n      throw new Error(message)\n    },\n    async del() {\n      throw new Error(message)\n    },\n  }\n}\n\nconst availableActionsCache = new Map()\nlet publicPath\nconst runAPI = async (plugin, api, args, activity) => {\n  const gatsbyNode = requireGatsbyPlugin(plugin, `gatsby-node`)\n\n  if (gatsbyNode[api]) {\n    const parentSpan = args && args.parentSpan\n    const spanOptions = parentSpan ? { childOf: parentSpan } : {}\n    const pluginSpan = tracer.startSpan(`run-plugin`, spanOptions)\n\n    pluginSpan.setTag(`api`, api)\n    pluginSpan.setTag(`plugin`, plugin.name)\n    const {\n      publicActions,\n      restrictedActionsAvailableInAPI,\n    } = require(`../redux/actions`)\n\n    let availableActions\n    if (availableActionsCache.has(api)) {\n      availableActions = availableActionsCache.get(api)\n    } else {\n      availableActions = {\n        ...publicActions,\n        ...(restrictedActionsAvailableInAPI[api] || {}),\n      }\n\n      availableActionsCache.set(api, availableActions)\n    }\n\n    let boundActionCreators = bindActionCreators(\n      availableActions,\n      store.dispatch\n    )\n\n    if (args.deferNodeMutation) {\n      boundActionCreators = deferActions(boundActionCreators)\n    }\n\n    const doubleBoundActionCreators = doubleBind(\n      boundActionCreators,\n      api,\n      plugin,\n      { ...args, parentSpan: pluginSpan, activity }\n    )\n\n    const { config, program } = store.getState()\n\n    const pathPrefix = (program.prefixPaths && config.pathPrefix) || ``\n\n    if (typeof publicPath === `undefined`) {\n      publicPath = getPublicPath({ ...config, ...program }, ``)\n    }\n\n    const namespacedCreateNodeId = id => createNodeId(id, plugin.name)\n\n    const tracing = initAPICallTracing(pluginSpan)\n\n    // See https://github.com/gatsbyjs/gatsby/issues/11369\n    const cache =\n      api === `onPreInit`\n        ? getUninitializedCache(plugin.name)\n        : getCache(plugin.name)\n\n    // Ideally this would be more abstracted and applied to more situations, but right now\n    // this can be potentially breaking so targeting `createPages` API and `createPage` action\n    let actions = doubleBoundActionCreators\n    let apiFinished = false\n    if (api === `createPages`) {\n      let alreadyDisplayed = false\n      const createPageAction = actions.createPage\n      // create new actions object with wrapped createPage action\n      // doubleBoundActionCreators is memoized, so we can't just\n      // reassign createPage field as this would cause this extra logic\n      // to be used in subsequent APIs and we only want to target this `createPages` call.\n      actions = {\n        ...actions,\n        createPage: (...args) => {\n          createPageAction(...args)\n          if (apiFinished && !alreadyDisplayed) {\n            const warning = [\n              reporter.stripIndent(`\n              Action ${chalk.bold(\n                `createPage`\n              )} was called outside of its expected asynchronous lifecycle ${chalk.bold(\n                `createPages`\n              )} in ${chalk.bold(plugin.name)}.\n              Ensure that you return a Promise from ${chalk.bold(\n                `createPages`\n              )} and are awaiting any asynchronous method invocations (like ${chalk.bold(\n                `graphql`\n              )} or http requests).\n              For more info and debugging tips: see ${chalk.bold(\n                `https://gatsby.dev/sync-actions`\n              )}\n            `),\n            ]\n\n            const possiblyCodeFrame = getNonGatsbyCodeFrameFormatted()\n            if (possiblyCodeFrame) {\n              warning.push(possiblyCodeFrame)\n            }\n\n            reporter.warn(warning.join(`\\n\\n`))\n            alreadyDisplayed = true\n          }\n        },\n      }\n    }\n\n    const localReporter = getLocalReporter({ activity, reporter })\n\n    const runningActivities = new Set()\n\n    const extendedLocalReporter = extendLocalReporterToCatchPluginErrors({\n      reporter: localReporter,\n      pluginName: plugin.name,\n      runningActivities,\n    })\n\n    const endInProgressActivitiesCreatedByThisRun = () => {\n      runningActivities.forEach(activity => activity.end())\n    }\n\n    const shouldDetectNodeMutations = [\n      `sourceNodes`,\n      `onCreateNode`,\n      `createResolvers`,\n      `createSchemaCustomization`,\n      `setFieldsOnGraphQLNodeType`,\n    ].includes(api)\n\n    const apiCallArgs = [\n      {\n        ...args,\n        parentSpan: pluginSpan,\n        basePath: pathPrefix,\n        pathPrefix: publicPath,\n        actions,\n        loadNodeContent,\n        store,\n        emitter,\n        getCache,\n        getNodes: shouldDetectNodeMutations\n          ? nodeMutationsWrappers.getNodes\n          : getNodes,\n        getNode: shouldDetectNodeMutations\n          ? nodeMutationsWrappers.getNode\n          : getNode,\n        getNodesByType: shouldDetectNodeMutations\n          ? nodeMutationsWrappers.getNodesByType\n          : getNodesByType,\n        reporter: extendedLocalReporter,\n        getNodeAndSavePathDependency: shouldDetectNodeMutations\n          ? nodeMutationsWrappers.getNodeAndSavePathDependency\n          : getNodeAndSavePathDependency,\n        cache,\n        createNodeId: namespacedCreateNodeId,\n        createContentDigest,\n        tracing,\n        schema: {\n          buildObjectType,\n          buildUnionType,\n          buildInterfaceType,\n          buildInputObjectType,\n          buildEnumType,\n          buildScalarType,\n        },\n      },\n      plugin.pluginOptions,\n    ]\n\n    // If the plugin is using a callback use that otherwise\n    // expect a Promise to be returned.\n    if (gatsbyNode[api].length === 3) {\n      return Promise.fromCallback(callback => {\n        const cb = (err, val) => {\n          pluginSpan.finish()\n          apiFinished = true\n          endInProgressActivitiesCreatedByThisRun()\n          callback(err, val)\n        }\n\n        try {\n          gatsbyNode[api](...apiCallArgs, cb)\n        } catch (e) {\n          trackBuildError(api, {\n            error: e,\n            pluginName: `${plugin.name}@${plugin.version}`,\n          })\n          throw e\n        }\n      })\n    } else {\n      try {\n        return await gatsbyNode[api](...apiCallArgs)\n      } finally {\n        pluginSpan.finish()\n        apiFinished = true\n        endInProgressActivitiesCreatedByThisRun()\n      }\n    }\n  }\n\n  return null\n}\n\nconst apisRunningById = new Map()\nconst apisRunningByTraceId = new Map()\nlet waitingForCasacadeToFinish = []\n\nfunction apiRunnerNode(api, args = {}, { pluginSource, activity } = {}) {\n  const plugins = store.getState().flattenedPlugins\n\n  // Get the list of plugins that implement this API.\n  // Also: Break infinite loops. Sometimes a plugin will implement an API and\n  // call an action which will trigger the same API being called.\n  // `onCreatePage` is the only example right now. In these cases, we should\n  // avoid calling the originating plugin again.\n  let implementingPlugins = plugins.filter(\n    plugin => plugin.nodeAPIs.includes(api) && plugin.name !== pluginSource\n  )\n\n  if (api === `sourceNodes` && args.pluginName) {\n    implementingPlugins = implementingPlugins.filter(\n      plugin => plugin.name === args.pluginName\n    )\n  }\n\n  // If there's no implementing plugins, return early.\n  if (implementingPlugins.length === 0) {\n    return null\n  }\n\n  return new Promise(resolve => {\n    const { parentSpan, traceId, traceTags, waitForCascadingActions } = args\n    const apiSpanArgs = parentSpan ? { childOf: parentSpan } : {}\n    const apiSpan = tracer.startSpan(`run-api`, apiSpanArgs)\n\n    apiSpan.setTag(`api`, api)\n    _.forEach(traceTags, (value, key) => {\n      apiSpan.setTag(key, value)\n    })\n\n    const apiRunInstance = {\n      api,\n      args,\n      pluginSource,\n      resolve,\n      span: apiSpan,\n      startTime: new Date().toJSON(),\n      traceId,\n    }\n\n    // Generate IDs for api runs. Most IDs we generate from the args\n    // but some API calls can have very large argument objects so we\n    // have special ways of generating IDs for those to avoid stringifying\n    // large objects.\n    let id\n    if (api === `setFieldsOnGraphQLNodeType`) {\n      id = `${api}${apiRunInstance.startTime}${args.type.name}${traceId}`\n    } else if (api === `onCreateNode`) {\n      id = `${api}${apiRunInstance.startTime}${args.node.internal.contentDigest}${traceId}`\n    } else if (api === `preprocessSource`) {\n      id = `${api}${apiRunInstance.startTime}${args.filename}${traceId}`\n    } else if (api === `onCreatePage`) {\n      id = `${api}${apiRunInstance.startTime}${args.page.path}${traceId}`\n    } else {\n      // When tracing is turned on, the `args` object will have a\n      // `parentSpan` field that can be quite large. So we omit it\n      // before calling stringify\n      const argsJson = JSON.stringify(_.omit(args, `parentSpan`))\n      id = `${api}|${apiRunInstance.startTime}|${apiRunInstance.traceId}|${argsJson}`\n    }\n    apiRunInstance.id = id\n\n    if (waitForCascadingActions) {\n      waitingForCasacadeToFinish.push(apiRunInstance)\n    }\n\n    if (apisRunningById.size === 0) {\n      emitter.emit(`API_RUNNING_START`)\n    }\n\n    apisRunningById.set(apiRunInstance.id, apiRunInstance)\n    if (apisRunningByTraceId.has(apiRunInstance.traceId)) {\n      const currentCount = apisRunningByTraceId.get(apiRunInstance.traceId)\n      apisRunningByTraceId.set(apiRunInstance.traceId, currentCount + 1)\n    } else {\n      apisRunningByTraceId.set(apiRunInstance.traceId, 1)\n    }\n\n    let stopQueuedApiRuns = false\n    let onAPIRunComplete = null\n    if (api === `onCreatePage`) {\n      const path = args.page.path\n      const actionHandler = action => {\n        if (action.payload.path === path) {\n          stopQueuedApiRuns = true\n        }\n      }\n      emitter.on(`DELETE_PAGE`, actionHandler)\n      onAPIRunComplete = () => {\n        emitter.off(`DELETE_PAGE`, actionHandler)\n      }\n    }\n\n    let apiRunPromiseOptions = {}\n    let runPromise\n    if (\n      api === `sourceNodes` &&\n      process.env.GATSBY_EXPERIMENTAL_PARALLEL_SOURCING\n    ) {\n      runPromise = Promise.map\n      apiRunPromiseOptions.concurrency = 20\n    } else {\n      runPromise = Promise.mapSeries\n      apiRunPromiseOptions = undefined\n    }\n\n    runPromise(\n      implementingPlugins,\n      plugin => {\n        if (stopQueuedApiRuns) {\n          return null\n        }\n\n        const gatsbyNode = requireGatsbyPlugin(plugin, `gatsby-node`)\n        const pluginName =\n          plugin.name === `default-site-plugin` ? `gatsby-node.js` : plugin.name\n\n        // TODO: rethink createNode API to handle this better\n        if (\n          api === `onCreateNode` &&\n          gatsbyNode?.unstable_shouldOnCreateNode && // Don't bail if this api is not exported\n          !gatsbyNode.unstable_shouldOnCreateNode(\n            { node: args.node },\n            plugin.pluginOptions\n          )\n        ) {\n          // Do not try to schedule an async event for this node for this plugin\n          return null\n        }\n\n        return new Promise(resolve => {\n          resolve(\n            runAPI(plugin, api, { ...args, parentSpan: apiSpan }, activity)\n          )\n        }).catch(err => {\n          decorateEvent(`BUILD_PANIC`, {\n            pluginName: `${plugin.name}@${plugin.version}`,\n          })\n\n          const localReporter = getLocalReporter({ activity, reporter })\n\n          const file = stackTrace\n            .parse(err)\n            .find(file => /gatsby-node/.test(file.fileName))\n\n          let codeFrame = ``\n          const structuredError = errorParser({ err })\n\n          if (file) {\n            const { fileName, lineNumber: line, columnNumber: column } = file\n            const trimmedFileName = fileName.match(/^(async )?(.*)/)[2]\n\n            try {\n              const code = fs.readFileSync(trimmedFileName, {\n                encoding: `utf-8`,\n              })\n              codeFrame = codeFrameColumns(\n                code,\n                {\n                  start: {\n                    line,\n                    column,\n                  },\n                },\n                {\n                  highlightCode: true,\n                }\n              )\n            } catch (_e) {\n              // sometimes stack trace point to not existing file\n              // particularly when file is transpiled and path actually changes\n              // (like pointing to not existing `src` dir or original typescript file)\n            }\n\n            structuredError.location = {\n              start: { line: line, column: column },\n            }\n            structuredError.filePath = fileName\n          }\n\n          structuredError.context = {\n            ...structuredError.context,\n            pluginName,\n            api,\n            codeFrame,\n          }\n\n          localReporter.panicOnBuild(structuredError)\n\n          return null\n        })\n      },\n      apiRunPromiseOptions\n    ).then(results => {\n      if (onAPIRunComplete) {\n        onAPIRunComplete()\n      }\n      // Remove runner instance\n      apisRunningById.delete(apiRunInstance.id)\n      const currentCount = apisRunningByTraceId.get(apiRunInstance.traceId)\n      apisRunningByTraceId.set(apiRunInstance.traceId, currentCount - 1)\n\n      if (apisRunningById.size === 0) {\n        emitter.emit(`API_RUNNING_QUEUE_EMPTY`)\n      }\n\n      // Filter empty results\n      apiRunInstance.results = results.filter(result => !_.isEmpty(result))\n\n      // Filter out empty responses and return if the\n      // api caller isn't waiting for cascading actions to finish.\n      if (!waitForCascadingActions) {\n        apiSpan.finish()\n        resolve(apiRunInstance.results)\n      }\n\n      // Check if any of our waiters are done.\n      waitingForCasacadeToFinish = waitingForCasacadeToFinish.filter(\n        instance => {\n          // If none of its trace IDs are running, it's done.\n          const apisByTraceIdCount = apisRunningByTraceId.get(instance.traceId)\n          if (apisByTraceIdCount === 0) {\n            instance.span.finish()\n            instance.resolve(instance.results)\n            return false\n          } else {\n            return true\n          }\n        }\n      )\n      return\n    })\n  })\n}\n\nmodule.exports = apiRunnerNode\n"],"mappings":"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"}