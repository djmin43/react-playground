{"version":3,"file":"schema.js","names":["setInferenceMetadata","setState","buildSchema","workerStore","store","getState","config","pathPrefix","Error","schemaSnapshotPath","path","join","program","directory","fs","pathExists","schemaSnapshot","readFile","dispatch","actions","createTypes","apiRunnerNode","build","fullMetadataBuild","parentSpan"],"sources":["../../../../src/utils/worker/child/schema.ts"],"sourcesContent":["import * as path from \"path\"\nimport * as fs from \"fs-extra\"\n\nimport { store } from \"../../../redux\"\nimport { actions } from \"../../../redux/actions\"\nimport { build } from \"../../../schema\"\nimport apiRunnerNode from \"../../api-runner-node\"\nimport { setState } from \"./state\"\n\nexport function setInferenceMetadata(): void {\n  setState([`inferenceMetadata`])\n}\n\nexport async function buildSchema(): Promise<void> {\n  const workerStore = store.getState()\n\n  // pathPrefix: '' will at least be defined when config is loaded\n  if ((workerStore?.config?.pathPrefix ?? null) === null) {\n    throw Error(\n      `Config loading didn't finish before attempting to build schema in worker`\n    )\n  }\n\n  const schemaSnapshotPath = path.join(\n    workerStore.program.directory,\n    `.cache`,\n    `schema.gql`\n  )\n\n  if (await fs.pathExists(schemaSnapshotPath)) {\n    const schemaSnapshot = await fs.readFile(schemaSnapshotPath, `utf-8`)\n    store.dispatch(actions.createTypes(schemaSnapshot))\n  }\n\n  setInferenceMetadata()\n\n  await apiRunnerNode(`createSchemaCustomization`)\n\n  // build() runs other lifecycles like \"createResolvers\" or \"setFieldsOnGraphQLNodeType\" internally\n  await build({ fullMetadataBuild: false, parentSpan: {} })\n}\n"],"mappings":";;;;;;;;AAAA;;AACA;;AAEA;;AACA;;AACA;;AACA;;AACA;;;;;;AAEO,SAASA,oBAAT,GAAsC;EAC3C,IAAAC,eAAA,EAAS,CAAE,mBAAF,CAAT;AACD;;AAEM,eAAeC,WAAf,GAA4C;EAAA;;EACjD,MAAMC,WAAW,GAAGC,YAAA,CAAMC,QAAN,EAApB,CADiD,CAGjD;;;EACA,IAAI,0BAACF,WAAD,aAACA,WAAD,8CAACA,WAAW,CAAEG,MAAd,wDAAC,oBAAqBC,UAAtB,yEAAoC,IAApC,MAA8C,IAAlD,EAAwD;IACtD,MAAMC,KAAK,CACR,0EADQ,CAAX;EAGD;;EAED,MAAMC,kBAAkB,GAAGC,IAAI,CAACC,IAAL,CACzBR,WAAW,CAACS,OAAZ,CAAoBC,SADK,EAExB,QAFwB,EAGxB,YAHwB,CAA3B;;EAMA,IAAI,MAAMC,EAAE,CAACC,UAAH,CAAcN,kBAAd,CAAV,EAA6C;IAC3C,MAAMO,cAAc,GAAG,MAAMF,EAAE,CAACG,QAAH,CAAYR,kBAAZ,EAAiC,OAAjC,CAA7B;;IACAL,YAAA,CAAMc,QAAN,CAAeC,gBAAA,CAAQC,WAAR,CAAoBJ,cAApB,CAAf;EACD;;EAEDhB,oBAAoB;EAEpB,MAAM,IAAAqB,sBAAA,EAAe,2BAAf,CAAN,CAvBiD,CAyBjD;;EACA,MAAM,IAAAC,aAAA,EAAM;IAAEC,iBAAiB,EAAE,KAArB;IAA4BC,UAAU,EAAE;EAAxC,CAAN,CAAN;AACD"}