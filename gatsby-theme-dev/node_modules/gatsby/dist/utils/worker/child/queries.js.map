{"version":3,"file":"queries.js","names":["setComponents","setState","saveQueriesDependencies","pickNecessaryQueryState","state","queries","queryNodes","Map","savePartialStateToDisk","process","env","GATSBY_WORKER_ID","waitUntilPageQueryResultsAreStored","gqlRunner","getGraphqlRunner","GraphQLRunner","store","collectStats","graphqlTracing","getState","program","runQueries","queryIds","actionsToReplay","unsubscribe","subscribe","action","lastAction","type","push","doRunQueries","workerStore","schemaCustomization","composer","buildSchema","graphqlRunner","runStaticQueries","runPageQueries","getDataStore","ready"],"sources":["../../../../src/utils/worker/child/queries.ts"],"sourcesContent":["import {\n  IGroupedQueryIds,\n  runPageQueries,\n  runStaticQueries,\n} from \"../../../services\"\nimport { savePartialStateToDisk, store } from \"../../../redux\"\nimport { GraphQLRunner } from \"../../../query/graphql-runner\"\nimport { getDataStore } from \"../../../datastore\"\nimport { setState } from \"./state\"\nimport { buildSchema } from \"./schema\"\nimport {\n  IAddPendingPageDataWriteAction,\n  ICreatePageDependencyAction,\n  IGatsbyState,\n  IPageQueryRunAction,\n  IQueryStartAction,\n} from \"../../../redux/types\"\nimport { DeepPartial } from \"redux\"\nimport { waitUntilPageQueryResultsAreStored } from \"../../page-data\"\n\nexport function setComponents(): void {\n  setState([`components`, `staticQueryComponents`])\n}\n\nexport async function saveQueriesDependencies(): Promise<void> {\n  // Drop `queryNodes` from query state - it can be restored from other pieces of state\n  // and is there only as a perf optimization\n  const pickNecessaryQueryState = <T extends DeepPartial<IGatsbyState>>(\n    state: T\n  ): T => {\n    if (!state?.queries?.queryNodes) return state\n    return { ...state, queries: { ...state.queries, queryNodes: new Map() } }\n  }\n  savePartialStateToDisk(\n    [`queries`, `telemetry`],\n    process.env.GATSBY_WORKER_ID,\n    pickNecessaryQueryState\n  )\n\n  // make sure page query results we put in lmdb-store are flushed\n  await waitUntilPageQueryResultsAreStored()\n}\n\nlet gqlRunner\n\nfunction getGraphqlRunner(): GraphQLRunner {\n  if (!gqlRunner) {\n    gqlRunner = new GraphQLRunner(store, {\n      collectStats: true,\n      graphqlTracing: store.getState().program.graphqlTracing,\n    })\n  }\n  return gqlRunner\n}\n\ntype ActionsToReplay = Array<\n  | IQueryStartAction\n  | IPageQueryRunAction\n  | IAddPendingPageDataWriteAction\n  | ICreatePageDependencyAction\n>\n\nexport async function runQueries(\n  queryIds: IGroupedQueryIds\n): Promise<ActionsToReplay> {\n  const actionsToReplay: ActionsToReplay = []\n\n  const unsubscribe = store.subscribe(() => {\n    const action = store.getState().lastAction\n    if (\n      action.type === `QUERY_START` ||\n      action.type === `PAGE_QUERY_RUN` ||\n      action.type === `ADD_PENDING_PAGE_DATA_WRITE`\n      // Note: Instead of saving/replaying `CREATE_COMPONENT_DEPENDENCY` action\n      // we do state merging once at the end of the query running (replaying this action is expensive)\n    ) {\n      actionsToReplay.push(action)\n    }\n  })\n\n  try {\n    await doRunQueries(queryIds)\n    return actionsToReplay\n  } finally {\n    unsubscribe()\n  }\n}\n\nasync function doRunQueries(queryIds: IGroupedQueryIds): Promise<void> {\n  const workerStore = store.getState()\n\n  // If buildSchema() didn't run yet, execute it\n  if (workerStore.schemaCustomization.composer === null) {\n    await buildSchema()\n  }\n\n  const graphqlRunner = getGraphqlRunner()\n\n  await runStaticQueries({\n    queryIds,\n    store,\n    graphqlRunner,\n  })\n\n  await runPageQueries({\n    queryIds,\n    store,\n    graphqlRunner,\n  })\n\n  await getDataStore().ready()\n}\n"],"mappings":";;;;;;;AAAA;;AAKA;;AACA;;AACA;;AACA;;AACA;;AASA;;AAEO,SAASA,aAAT,GAA+B;EACpC,IAAAC,eAAA,EAAS,CAAE,YAAF,EAAgB,uBAAhB,CAAT;AACD;;AAEM,eAAeC,uBAAf,GAAwD;EAC7D;EACA;EACA,MAAMC,uBAAuB,GAC3BC,KAD8B,IAExB;IAAA;;IACN,IAAI,EAACA,KAAD,aAACA,KAAD,iCAACA,KAAK,CAAEC,OAAR,2CAAC,eAAgBC,UAAjB,CAAJ,EAAiC,OAAOF,KAAP;IACjC,OAAO,EAAE,GAAGA,KAAL;MAAYC,OAAO,EAAE,EAAE,GAAGD,KAAK,CAACC,OAAX;QAAoBC,UAAU,EAAE,IAAIC,GAAJ;MAAhC;IAArB,CAAP;EACD,CALD;;EAMA,IAAAC,6BAAA,EACE,CAAE,SAAF,EAAa,WAAb,CADF,EAEEC,OAAO,CAACC,GAAR,CAAYC,gBAFd,EAGER,uBAHF,EAT6D,CAe7D;;EACA,MAAM,IAAAS,4CAAA,GAAN;AACD;;AAED,IAAIC,SAAJ;;AAEA,SAASC,gBAAT,GAA2C;EACzC,IAAI,CAACD,SAAL,EAAgB;IACdA,SAAS,GAAG,IAAIE,4BAAJ,CAAkBC,YAAlB,EAAyB;MACnCC,YAAY,EAAE,IADqB;MAEnCC,cAAc,EAAEF,YAAA,CAAMG,QAAN,GAAiBC,OAAjB,CAAyBF;IAFN,CAAzB,CAAZ;EAID;;EACD,OAAOL,SAAP;AACD;;AASM,eAAeQ,UAAf,CACLC,QADK,EAEqB;EAC1B,MAAMC,eAAgC,GAAG,EAAzC;;EAEA,MAAMC,WAAW,GAAGR,YAAA,CAAMS,SAAN,CAAgB,MAAM;IACxC,MAAMC,MAAM,GAAGV,YAAA,CAAMG,QAAN,GAAiBQ,UAAhC;;IACA,IACED,MAAM,CAACE,IAAP,KAAiB,aAAjB,IACAF,MAAM,CAACE,IAAP,KAAiB,gBADjB,IAEAF,MAAM,CAACE,IAAP,KAAiB,6BAHnB,CAIE;IACA;IALF,EAME;MACAL,eAAe,CAACM,IAAhB,CAAqBH,MAArB;IACD;EACF,CAXmB,CAApB;;EAaA,IAAI;IACF,MAAMI,YAAY,CAACR,QAAD,CAAlB;IACA,OAAOC,eAAP;EACD,CAHD,SAGU;IACRC,WAAW;EACZ;AACF;;AAED,eAAeM,YAAf,CAA4BR,QAA5B,EAAuE;EACrE,MAAMS,WAAW,GAAGf,YAAA,CAAMG,QAAN,EAApB,CADqE,CAGrE;;;EACA,IAAIY,WAAW,CAACC,mBAAZ,CAAgCC,QAAhC,KAA6C,IAAjD,EAAuD;IACrD,MAAM,IAAAC,mBAAA,GAAN;EACD;;EAED,MAAMC,aAAa,GAAGrB,gBAAgB,EAAtC;EAEA,MAAM,IAAAsB,0BAAA,EAAiB;IACrBd,QADqB;IAErBN,KAAK,EAALA,YAFqB;IAGrBmB;EAHqB,CAAjB,CAAN;EAMA,MAAM,IAAAE,wBAAA,EAAe;IACnBf,QADmB;IAEnBN,KAAK,EAALA,YAFmB;IAGnBmB;EAHmB,CAAf,CAAN;EAMA,MAAM,IAAAG,uBAAA,IAAeC,KAAf,EAAN;AACD"}