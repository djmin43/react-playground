{"version":3,"file":"feedback.js","names":["feedbackKey","lastDateKey","firstDateKey","sevenDayKey","setFeedbackDisabledValue","enabled","getConfigStore","set","showFeedbackRequest","Date","now","trackCli","name","report","log","showSevenDayFeedbackRequest","randomChanceToBeTrue","currentQuarter","Math","floor","getMonth","randomNumber","random","randomNumberWithinQuarter","getDayOfYear","userPassesFeedbackRequestHeuristic","randomlyPassingHeuristic","isFeedbackDisabled","lastDateValue","get","lastDate","threeMonthsAgo","setMonth","sevenDayFeedback","sevenDayDate","versionPoints","getGatsbyVersion","split","latestVersionPoints","latestVersion","e","versionsMatchOnMajorAndMinor","isCI","process","env","GATSBY_FEEDBACK_DISABLED","userGetsSevenDayFeedback","firstDateValue","sevenDaysAgo","setDate","getDate"],"sources":["../../src/utils/feedback.ts"],"sourcesContent":["import report from \"gatsby-cli/lib/reporter\"\nimport { getConfigStore, getGatsbyVersion, isCI } from \"gatsby-core-utils\"\nimport { trackCli } from \"gatsby-telemetry\"\nimport latestVersion from \"latest-version\"\nimport getDayOfYear from \"date-fns/getDayOfYear\"\n\nconst feedbackKey = `feedback.disabled`\nconst lastDateKey = `feedback.lastRequestDate`\nconst firstDateKey = `feedback.firstCheckDate`\nconst sevenDayKey = `feedback.sevenDayFeedbackDate`\n\n// This function is designed to be used by `gatsby feedback --disable`\n// and `gatsby feedback --enable`. This key is used to determine\n// if a user is allowed to be solicited for feedback\nexport function setFeedbackDisabledValue(enabled: boolean): void {\n  getConfigStore().set(feedbackKey, enabled)\n}\n\n// Print the feedback request to the user\nexport function showFeedbackRequest(): void {\n  getConfigStore().set(lastDateKey, Date.now())\n  trackCli(`SHOW_FEEDBACK_LINK`, {\n    name: `https://gatsby.dev/feedback`,\n  })\n  report.log(\n    `\\n\\nHello! Will you help Gatsby improve by taking a four question survey?\\nIt takes less than five minutes and your ideas and feedback will be very helpful.`\n  )\n  report.log(`\\nGive us your feedback here: https://gatsby.dev/feedback\\n\\n`)\n}\n\nexport function showSevenDayFeedbackRequest(): void {\n  getConfigStore().set(sevenDayKey, Date.now())\n  trackCli(`SHOW_SEVEN_DAY_FEEDBACK_LINK`, {\n    name: `https://gatsby.dev/feedback-survey`,\n  })\n  report.log(\n    `\\n\\nHi there! Will you tell us about how you're learning Gatsby? \\nIt takes less than 5 minutes and your feedback will help us make installing and using Gatsby so much better.`\n  )\n  report.log(\n    `\\nGive us your feedback here: https://gatsby.dev/feedback-survey\\n\\n`\n  )\n}\n\nconst randomChanceToBeTrue = (): boolean => {\n  // This is spreading the request volume over the quarter.\n  // We are grabbing a randomNumber within the spread of a first day\n  // of a quarter, to the last day\n  const currentQuarter = Math.floor((new Date().getMonth() + 3) / 3)\n  const randomNumber = Math.floor(\n    Math.random() *\n      // One quarter year in days (roughly)\n      (30 * 3)\n  )\n  const randomNumberWithinQuarter = randomNumber + 30 * 3 * (currentQuarter - 1)\n\n  return randomNumberWithinQuarter === getDayOfYear(new Date())\n}\n\n// We are only showing feedback requests to users in if they pass a few checks:\n// 1. They pass a Math.random() check. This is a skateboard version of not sending out all requests in one day.\n// 2. Gatsby is not running in CI\n// 3. They don't have the environment variable to disable feedback present\n// 4. They haven't disabled the feedback mechanism\n// 5. It's been at least 3 months since the last feedback request\n// 6. They are on the most recent version of Gatsby\nexport async function userPassesFeedbackRequestHeuristic(): Promise<boolean> {\n  // Heuristic 1\n  // We originally wrote this to have a single chance of hitting.\n  // We wanted to up the chance by 5x, so this is our crude - temporary -\n  // way of giving the user 5 chances to passing.\n  const randomlyPassingHeuristic =\n    randomChanceToBeTrue() ||\n    randomChanceToBeTrue() ||\n    randomChanceToBeTrue() ||\n    randomChanceToBeTrue() ||\n    randomChanceToBeTrue()\n\n  if (!randomlyPassingHeuristic) {\n    return false\n  }\n\n  if (isFeedbackDisabled()) {\n    return false\n  }\n\n  // Heuristic 5\n  const lastDateValue = getConfigStore().get(lastDateKey)\n  // 5.a if the user has never received the feedback request, this is undefined\n  //     Which is effectively a pass, because it's been ~infinity~ since they last\n  //     received a request from us.\n  if (lastDateValue) {\n    const lastDate = new Date(lastDateValue)\n    const threeMonthsAgo = new Date()\n    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3)\n\n    if (lastDate > threeMonthsAgo) {\n      return false\n    }\n  }\n\n  // 5.b\n  // we don't want to give them this survey right after the seven day feedback survey\n  const sevenDayFeedback = getConfigStore().get(sevenDayKey)\n  if (sevenDayFeedback) {\n    const sevenDayDate = new Date(sevenDayFeedback)\n    const threeMonthsAgo = new Date()\n    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3)\n\n    if (sevenDayDate > threeMonthsAgo) {\n      return false\n    }\n  }\n\n  // Heuristic 6\n  const versionPoints = getGatsbyVersion().split(`.`)\n  let latestVersionPoints: Array<string> = []\n  try {\n    latestVersionPoints = (await latestVersion(`gatsby`)).split(`.`)\n  } catch (e) {\n    // do nothing.\n    // if the request fails, then we should just not show the feedback request\n    // because this in theory could happen often and we don't want to be spammy.\n    // In this case, we are guaranteed to have `versionsMatchOnMajorAndMinor` === false\n  }\n\n  // Since we push versions very frequently. So thinking that users will\n  // be on the latest patch is potentially unrealistic. So we are just\n  // comparing on major and minor version points.\n  const versionsMatchOnMajorAndMinor =\n    versionPoints[0] === latestVersionPoints[0] &&\n    versionPoints[1] === latestVersionPoints[1]\n\n  if (versionsMatchOnMajorAndMinor === false) {\n    return false\n  }\n\n  // If all of the above passed, then the user is able to be prompted\n  // for feedback\n  return true\n}\n\nfunction isFeedbackDisabled(): boolean {\n  // Reasoning for this order: Checking for CI fixes issues like\n  // https://github.com/gatsbyjs/gatsby/issues/30647\n  // TODO: Additionally prevent getConfigStore from erroring\n\n  // Heuristic 2\n  if (isCI()) {\n    return true\n  }\n\n  // Heuristic 3\n  if (process.env.GATSBY_FEEDBACK_DISABLED === `1`) {\n    return true\n  }\n\n  // Heuristic 4\n  if (getConfigStore().get(feedbackKey) === true) {\n    return true\n  }\n\n  return false\n}\n\nexport async function userGetsSevenDayFeedback(): Promise<boolean> {\n  if (isFeedbackDisabled()) return false\n\n  if (getConfigStore().get(sevenDayKey)) return false\n\n  const firstDateValue = getConfigStore().get(firstDateKey)\n\n  if (!firstDateValue) {\n    getConfigStore().set(firstDateKey, Date.now()) // set this for the first time\n    return false\n  } else {\n    const lastDate = new Date(firstDateValue)\n    const sevenDaysAgo = new Date()\n    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7)\n\n    if (lastDate > sevenDaysAgo) {\n      return false\n    }\n  }\n  return true\n}\n"],"mappings":";;;;;;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AAEA,MAAMA,WAAW,GAAI,mBAArB;AACA,MAAMC,WAAW,GAAI,0BAArB;AACA,MAAMC,YAAY,GAAI,yBAAtB;AACA,MAAMC,WAAW,GAAI,+BAArB,C,CAEA;AACA;AACA;;AACO,SAASC,wBAAT,CAAkCC,OAAlC,EAA0D;EAC/D,IAAAC,+BAAA,IAAiBC,GAAjB,CAAqBP,WAArB,EAAkCK,OAAlC;AACD,C,CAED;;;AACO,SAASG,mBAAT,GAAqC;EAC1C,IAAAF,+BAAA,IAAiBC,GAAjB,CAAqBN,WAArB,EAAkCQ,IAAI,CAACC,GAAL,EAAlC;EACA,IAAAC,yBAAA,EAAU,oBAAV,EAA+B;IAC7BC,IAAI,EAAG;EADsB,CAA/B;;EAGAC,iBAAA,CAAOC,GAAP,CACG,8JADH;;EAGAD,iBAAA,CAAOC,GAAP,CAAY,+DAAZ;AACD;;AAEM,SAASC,2BAAT,GAA6C;EAClD,IAAAT,+BAAA,IAAiBC,GAAjB,CAAqBJ,WAArB,EAAkCM,IAAI,CAACC,GAAL,EAAlC;EACA,IAAAC,yBAAA,EAAU,8BAAV,EAAyC;IACvCC,IAAI,EAAG;EADgC,CAAzC;;EAGAC,iBAAA,CAAOC,GAAP,CACG,iLADH;;EAGAD,iBAAA,CAAOC,GAAP,CACG,sEADH;AAGD;;AAED,MAAME,oBAAoB,GAAG,MAAe;EAC1C;EACA;EACA;EACA,MAAMC,cAAc,GAAGC,IAAI,CAACC,KAAL,CAAW,CAAC,IAAIV,IAAJ,GAAWW,QAAX,KAAwB,CAAzB,IAA8B,CAAzC,CAAvB;EACA,MAAMC,YAAY,GAAGH,IAAI,CAACC,KAAL,CACnBD,IAAI,CAACI,MAAL,OACE;EACC,KAAK,CAFR,CADmB,CAArB;EAKA,MAAMC,yBAAyB,GAAGF,YAAY,GAAG,KAAK,CAAL,IAAUJ,cAAc,GAAG,CAA3B,CAAjD;EAEA,OAAOM,yBAAyB,KAAK,IAAAC,qBAAA,EAAa,IAAIf,IAAJ,EAAb,CAArC;AACD,CAbD,C,CAeA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACO,eAAegB,kCAAf,GAAsE;EAC3E;EACA;EACA;EACA;EACA,MAAMC,wBAAwB,GAC5BV,oBAAoB,MACpBA,oBAAoB,EADpB,IAEAA,oBAAoB,EAFpB,IAGAA,oBAAoB,EAHpB,IAIAA,oBAAoB,EALtB;;EAOA,IAAI,CAACU,wBAAL,EAA+B;IAC7B,OAAO,KAAP;EACD;;EAED,IAAIC,kBAAkB,EAAtB,EAA0B;IACxB,OAAO,KAAP;EACD,CAlB0E,CAoB3E;;;EACA,MAAMC,aAAa,GAAG,IAAAtB,+BAAA,IAAiBuB,GAAjB,CAAqB5B,WAArB,CAAtB,CArB2E,CAsB3E;EACA;EACA;;EACA,IAAI2B,aAAJ,EAAmB;IACjB,MAAME,QAAQ,GAAG,IAAIrB,IAAJ,CAASmB,aAAT,CAAjB;IACA,MAAMG,cAAc,GAAG,IAAItB,IAAJ,EAAvB;IACAsB,cAAc,CAACC,QAAf,CAAwBD,cAAc,CAACX,QAAf,KAA4B,CAApD;;IAEA,IAAIU,QAAQ,GAAGC,cAAf,EAA+B;MAC7B,OAAO,KAAP;IACD;EACF,CAjC0E,CAmC3E;EACA;;;EACA,MAAME,gBAAgB,GAAG,IAAA3B,+BAAA,IAAiBuB,GAAjB,CAAqB1B,WAArB,CAAzB;;EACA,IAAI8B,gBAAJ,EAAsB;IACpB,MAAMC,YAAY,GAAG,IAAIzB,IAAJ,CAASwB,gBAAT,CAArB;IACA,MAAMF,cAAc,GAAG,IAAItB,IAAJ,EAAvB;IACAsB,cAAc,CAACC,QAAf,CAAwBD,cAAc,CAACX,QAAf,KAA4B,CAApD;;IAEA,IAAIc,YAAY,GAAGH,cAAnB,EAAmC;MACjC,OAAO,KAAP;IACD;EACF,CA9C0E,CAgD3E;;;EACA,MAAMI,aAAa,GAAG,IAAAC,iCAAA,IAAmBC,KAAnB,CAA0B,GAA1B,CAAtB;EACA,IAAIC,mBAAkC,GAAG,EAAzC;;EACA,IAAI;IACFA,mBAAmB,GAAG,CAAC,MAAM,IAAAC,sBAAA,EAAe,QAAf,CAAP,EAAgCF,KAAhC,CAAuC,GAAvC,CAAtB;EACD,CAFD,CAEE,OAAOG,CAAP,EAAU,CACV;IACA;IACA;IACA;EACD,CA1D0E,CA4D3E;EACA;EACA;;;EACA,MAAMC,4BAA4B,GAChCN,aAAa,CAAC,CAAD,CAAb,KAAqBG,mBAAmB,CAAC,CAAD,CAAxC,IACAH,aAAa,CAAC,CAAD,CAAb,KAAqBG,mBAAmB,CAAC,CAAD,CAF1C;;EAIA,IAAIG,4BAA4B,KAAK,KAArC,EAA4C;IAC1C,OAAO,KAAP;EACD,CArE0E,CAuE3E;EACA;;;EACA,OAAO,IAAP;AACD;;AAED,SAASd,kBAAT,GAAuC;EACrC;EACA;EACA;EAEA;EACA,IAAI,IAAAe,qBAAA,GAAJ,EAAY;IACV,OAAO,IAAP;EACD,CARoC,CAUrC;;;EACA,IAAIC,OAAO,CAACC,GAAR,CAAYC,wBAAZ,KAA0C,GAA9C,EAAkD;IAChD,OAAO,IAAP;EACD,CAboC,CAerC;;;EACA,IAAI,IAAAvC,+BAAA,IAAiBuB,GAAjB,CAAqB7B,WAArB,MAAsC,IAA1C,EAAgD;IAC9C,OAAO,IAAP;EACD;;EAED,OAAO,KAAP;AACD;;AAEM,eAAe8C,wBAAf,GAA4D;EACjE,IAAInB,kBAAkB,EAAtB,EAA0B,OAAO,KAAP;EAE1B,IAAI,IAAArB,+BAAA,IAAiBuB,GAAjB,CAAqB1B,WAArB,CAAJ,EAAuC,OAAO,KAAP;EAEvC,MAAM4C,cAAc,GAAG,IAAAzC,+BAAA,IAAiBuB,GAAjB,CAAqB3B,YAArB,CAAvB;;EAEA,IAAI,CAAC6C,cAAL,EAAqB;IACnB,IAAAzC,+BAAA,IAAiBC,GAAjB,CAAqBL,YAArB,EAAmCO,IAAI,CAACC,GAAL,EAAnC,EADmB,CAC4B;;IAC/C,OAAO,KAAP;EACD,CAHD,MAGO;IACL,MAAMoB,QAAQ,GAAG,IAAIrB,IAAJ,CAASsC,cAAT,CAAjB;IACA,MAAMC,YAAY,GAAG,IAAIvC,IAAJ,EAArB;IACAuC,YAAY,CAACC,OAAb,CAAqBD,YAAY,CAACE,OAAb,KAAyB,CAA9C;;IAEA,IAAIpB,QAAQ,GAAGkB,YAAf,EAA6B;MAC3B,OAAO,KAAP;IACD;EACF;;EACD,OAAO,IAAP;AACD"}