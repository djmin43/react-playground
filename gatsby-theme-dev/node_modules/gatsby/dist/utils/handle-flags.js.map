{"version":3,"file":"handle-flags.js","names":["handleFlags","flags","configFlags","executingCommand","process","env","gatsby_executing_command","availableFlags","Map","forEach","flag","set","name","unknownConfigFlags","unfitConfigFlags","flagName","has","flagWithMinDistance","minDistance","availableFlag","distanceToFlag","distance","push","didYouMean","unknownFlagMessage","length","commaListsAnd","enabledConfigFlags","Object","keys","filter","map","get","optedInFlags","applicableFlags","lockedInFlags","lockedInFlagsThatAreInConfig","command","noCI","isCI","fitness","testFitness","flagIsSetInConfig","includes","requires","unfitFlagMessage","join","addIncluded","includedFlags","includedName","incExp","find","e","flagIsDisabledByUser","generateFlagLine","message","experimental","chalk","black","bgYellow","bold","umbrellaIssue","description","size","otherFlagSuggestionLines","enabledFlagsSet","Set","f","add"],"sources":["../../src/utils/handle-flags.ts"],"sourcesContent":["import _ from \"lodash\"\nimport { isCI } from \"gatsby-core-utils\"\nimport { IFlag } from \"./flags\"\nimport chalk from \"chalk\"\nimport { commaListsAnd } from \"common-tags\"\nimport { distance } from \"fastest-levenshtein\"\n\nconst handleFlags = (\n  flags: Array<IFlag>,\n  configFlags: Record<string, boolean> = {},\n  executingCommand = process.env.gatsby_executing_command\n): {\n  enabledConfigFlags: Array<IFlag>\n  unknownFlagMessage: string\n  unfitFlagMessage: string\n  message: string\n} => {\n  // Prepare config flags.\n  // Filter out any flags that are set to false.\n  const availableFlags = new Map<string, IFlag>()\n  flags.forEach(flag => {\n    availableFlags.set(flag.name, flag)\n  })\n\n  // Find unknown flags someone has in their config to warn them about.\n  const unknownConfigFlags: Array<{ flag: string; didYouMean: string }> = []\n  const unfitConfigFlags: Array<{ flag: string; requires: string }> = []\n  for (const flagName in configFlags) {\n    if (availableFlags.has(flagName)) {\n      continue\n    }\n    let flagWithMinDistance\n    let minDistance\n    for (const availableFlag of flags) {\n      if (availableFlag.name !== flagName) {\n        const distanceToFlag = distance(flagName, availableFlag.name)\n        if (!flagWithMinDistance || distanceToFlag < minDistance) {\n          flagWithMinDistance = availableFlag.name\n          minDistance = distanceToFlag\n        }\n      }\n    }\n\n    if (flagName) {\n      unknownConfigFlags.push({\n        flag: flagName,\n        didYouMean:\n          flagWithMinDistance && minDistance < 4 ? flagWithMinDistance : ``,\n      })\n    }\n  }\n\n  let unknownFlagMessage = ``\n  if (unknownConfigFlags.length > 0) {\n    unknownFlagMessage = commaListsAnd`The following flag(s) found in your gatsby-config.js are not known:`\n    unknownConfigFlags.forEach(\n      flag =>\n        (unknownFlagMessage += `\\n- ${flag.flag}${\n          flag.didYouMean ? ` (did you mean: ${flag.didYouMean})` : ``\n        }`)\n    )\n  }\n\n  let enabledConfigFlags: Array<IFlag> = Object.keys(configFlags)\n    .filter(name => configFlags[name] && availableFlags.has(name))\n    .map(flagName => availableFlags.get(flagName)!)\n\n  // Test flags to see if it wants opted in.\n  const optedInFlags = new Map<string, IFlag>()\n  const applicableFlags = new Map<string, IFlag>()\n  const lockedInFlags = new Map<string, IFlag>()\n  const lockedInFlagsThatAreInConfig = new Map<string, IFlag>()\n  availableFlags.forEach(flag => {\n    if (flag.command !== `all` && flag.command !== executingCommand) {\n      // if flag is not for all commands and current command doesn't match command flag is for - skip\n      return\n    }\n\n    if (flag.noCI && isCI()) {\n      // If we're in CI and flag is not available for CI - skip\n      return\n    }\n\n    const fitness = flag.testFitness(flag)\n\n    const flagIsSetInConfig = typeof configFlags[flag.name] !== `undefined`\n\n    if (fitness === `LOCKED_IN`) {\n      enabledConfigFlags.push(flag)\n      lockedInFlags.set(flag.name, flag)\n      if (flagIsSetInConfig) {\n        lockedInFlagsThatAreInConfig.set(flag.name, flag)\n      }\n    } else if (!flagIsSetInConfig && fitness === `OPT_IN`) {\n      // if user didn't explicitly set a flag (either true or false)\n      // and it qualifies for auto opt-in - add it to optedInFlags\n      enabledConfigFlags.push(flag)\n      optedInFlags.set(flag.name, flag)\n    }\n\n    if (fitness === true || fitness === `OPT_IN`) {\n      applicableFlags.set(flag.name, flag)\n    }\n\n    if (fitness === false && enabledConfigFlags.includes(flag)) {\n      unfitConfigFlags.push({ flag: flag.name, requires: flag.requires ?? `` })\n    }\n  })\n\n  let unfitFlagMessage = ``\n  if (unfitConfigFlags.length > 0) {\n    unfitFlagMessage =\n      `The following flag(s) found in your gatsby-config.js are not supported in your environment and will have no effect:\\n` +\n      unfitConfigFlags\n        .map(\n          flag => `- ${flag.flag}${flag.requires ? `: ${flag.requires}` : ``}`\n        )\n        .join(`\\n`)\n  }\n\n  // Filter enabledConfigFlags against various tests\n  enabledConfigFlags = enabledConfigFlags.filter(flag => {\n    if (flag.command !== `all` && flag.command !== executingCommand) {\n      // if flag is not for all commands and current command doesn't match command flag is for - skip\n      return false\n    }\n\n    if (flag.noCI && isCI()) {\n      // If we're in CI and flag is not available for CI - skip\n      return false\n    }\n\n    // finally check if flag passes fitness check\n    return flag.testFitness(flag)\n  })\n\n  const addIncluded = (flag): void => {\n    if (flag.includedFlags) {\n      flag.includedFlags.forEach(includedName => {\n        const incExp = flags.find(e => e.name == includedName)\n        if (incExp) {\n          const flagIsDisabledByUser =\n            typeof configFlags[includedName] !== `undefined` &&\n            !configFlags[includedName]\n\n          if (!flagIsDisabledByUser) {\n            enabledConfigFlags.push(incExp)\n            addIncluded(incExp)\n          }\n        }\n      })\n    }\n  }\n  // Add to enabledConfigFlags any includedFlags\n  enabledConfigFlags.forEach(flag => {\n    addIncluded(flag)\n  })\n\n  enabledConfigFlags = _.uniq(enabledConfigFlags)\n\n  // TODO remove flags that longer exist.\n  //  w/ message of thanks\n\n  const generateFlagLine = (flag): string => {\n    let message = ``\n    message += `\\n- ${flag.name}`\n    if (flag.experimental) {\n      message += ` · ${chalk.black.bgYellow.bold(`EXPERIMENTAL`)}`\n    }\n    if (flag.umbrellaIssue) {\n      message += ` · (Umbrella Issue (${flag.umbrellaIssue}))`\n    }\n    message += ` · ${flag.description}`\n\n    return message\n  }\n\n  let message = ``\n  //  Create message about what flags are active.\n  if (enabledConfigFlags.length > 0) {\n    if (\n      enabledConfigFlags.length - optedInFlags.size - lockedInFlags.size >\n      0\n    ) {\n      message = `The following flags are active:`\n      enabledConfigFlags.forEach(flag => {\n        if (!optedInFlags.has(flag.name) && !lockedInFlags.has(flag.name)) {\n          message += generateFlagLine(flag)\n        }\n      })\n    }\n\n    if (lockedInFlagsThatAreInConfig.size > 0) {\n      if (message.length > 0) {\n        message += `\\n\\n`\n      }\n      message += `Some features you configured with flags are used natively now.\nThose flags no longer have any effect and you can remove them from config:`\n      lockedInFlagsThatAreInConfig.forEach(flag => {\n        message += generateFlagLine(flag)\n      })\n    }\n\n    if (optedInFlags.size > 0) {\n      if (message.length > 0) {\n        message += `\\n\\n`\n      }\n      message += `We're shipping new features! For final testing, we're rolling them out first to a small % of Gatsby users\nand your site was automatically chosen as one of them. With your help, we'll then release them to everyone in the next minor release.\n\nWe greatly appreciate your help testing the change. Please report any feedback good or bad in the umbrella issue. If you do encounter problems, please disable the flag by setting it to false in your gatsby-config.js like:\n\nflags: {\n  THE_FLAG: false\n}\n\nThe following flags were automatically enabled on your site:`\n      optedInFlags.forEach(flag => {\n        message += generateFlagLine(flag)\n      })\n    }\n\n    if (message.length > 0) {\n      // if we will print anything about flags, let's try to suggest other available ones\n      const otherFlagSuggestionLines: Array<string> = []\n      const enabledFlagsSet = new Set()\n      enabledConfigFlags.forEach(f => enabledFlagsSet.add(f.name))\n      applicableFlags.forEach(flag => {\n        if (\n          !enabledFlagsSet.has(flag.name) &&\n          typeof configFlags[flag.name] === `undefined`\n        ) {\n          // we want to suggest flag when it's not enabled and user specifically didn't use it in config\n          // we don't want to suggest flag user specifically wanted to disable\n          otherFlagSuggestionLines.push(generateFlagLine(flag))\n        }\n      })\n\n      if (otherFlagSuggestionLines.length > 0) {\n        message += `\\n\\nThere ${\n          otherFlagSuggestionLines.length === 1\n            ? `is one other flag`\n            : `are ${otherFlagSuggestionLines.length} other flags`\n        } available that you might be interested in:${otherFlagSuggestionLines.join(\n          ``\n        )}`\n      }\n    }\n\n    if (message.length > 0) {\n      message += `\\n`\n    }\n  }\n\n  return {\n    enabledConfigFlags,\n    message,\n    unknownFlagMessage,\n    unfitFlagMessage,\n  }\n}\n\nexport default handleFlags\n"],"mappings":"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"}