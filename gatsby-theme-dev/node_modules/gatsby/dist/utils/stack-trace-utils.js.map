{"version":3,"file":"stack-trace-utils.js","names":["fs","require","path","chalk","isNodeInternalModulePath","getDirName","arg","dirname","gatsbyLocation","resolve","reduxThunkLocation","reduxLocation","getNonGatsbyCallSite","stackTrace","get","find","callSite","getFileName","includes","getNonGatsbyCodeFrame","highlightCode","stack","parse","name","message","fileName","line","getLineNumber","column","getColumnNumber","code","readFileSync","encoding","codeFrame","codeFrameColumns","start","getNonGatsbyCodeFrameFormatted","possibleCodeFrame","bold","findOriginalSourcePositionAndContent","webpackSource","position","tracer","TraceMap","sourcePosition","originalPositionFor","source","sourceContent","sourceContentFor"],"sources":["../../src/utils/stack-trace-utils.ts"],"sourcesContent":["import stackTrace, { StackFrame } from \"stack-trace\"\nimport { codeFrameColumns } from \"@babel/code-frame\"\nimport {\n  TraceMap,\n  originalPositionFor,\n  OriginalMapping,\n  SourceMapInput,\n  sourceContentFor,\n} from \"@jridgewell/trace-mapping\"\n\nconst fs = require(`fs-extra`)\nconst path = require(`path`)\nconst chalk = require(`chalk`)\nconst { isNodeInternalModulePath } = require(`gatsby-core-utils`)\n\nconst getDirName = (arg: unknown): string => {\n  // Caveat related to executing in engines:\n  // After webpack bundling we would get number here (webpack module id) and that would crash when doing\n  // path.dirname(number).\n  if (typeof arg === `string`) {\n    return path.dirname(arg)\n  }\n  return `-cant-resolve-`\n}\n\nconst gatsbyLocation = getDirName(require.resolve(`gatsby/package.json`))\nconst reduxThunkLocation = getDirName(\n  require.resolve(`redux-thunk/package.json`)\n)\nconst reduxLocation = getDirName(require.resolve(`redux/package.json`))\n\nconst getNonGatsbyCallSite = (): StackFrame | undefined =>\n  stackTrace\n    .get()\n    .find(\n      callSite =>\n        callSite &&\n        callSite.getFileName() &&\n        !callSite.getFileName().includes(gatsbyLocation) &&\n        !callSite.getFileName().includes(reduxLocation) &&\n        !callSite.getFileName().includes(reduxThunkLocation) &&\n        !isNodeInternalModulePath(callSite.getFileName())\n    )\n\ninterface ICodeFrame {\n  fileName: string\n  line: number\n  column: number\n  codeFrame: string\n}\n\nexport const getNonGatsbyCodeFrame = ({\n  highlightCode = true,\n  stack,\n}: {\n  highlightCode?: boolean\n  stack?: string\n} = {}): null | ICodeFrame => {\n  let callSite\n  if (stack) {\n    callSite = stackTrace.parse({ stack, name: ``, message: `` })[0]\n  } else {\n    callSite = getNonGatsbyCallSite()\n  }\n\n  if (!callSite) {\n    return null\n  }\n\n  const fileName = callSite.getFileName()\n  const line = callSite.getLineNumber()\n  const column = callSite.getColumnNumber()\n\n  const code = fs.readFileSync(fileName, { encoding: `utf-8` })\n  return {\n    fileName,\n    line,\n    column,\n    codeFrame: codeFrameColumns(\n      code,\n      {\n        start: {\n          line,\n          column,\n        },\n      },\n      {\n        highlightCode,\n      }\n    ),\n  }\n}\n\nexport const getNonGatsbyCodeFrameFormatted = ({\n  highlightCode = true,\n  stack,\n}: {\n  highlightCode?: boolean\n  stack?: string\n} = {}): null | string => {\n  const possibleCodeFrame = getNonGatsbyCodeFrame({\n    highlightCode,\n    stack,\n  })\n\n  if (!possibleCodeFrame) {\n    return null\n  }\n\n  const { fileName, line, column, codeFrame } = possibleCodeFrame\n  return `File ${chalk.bold(`${fileName}:${line}:${column}`)}\\n${codeFrame}`\n}\n\ninterface IOriginalSourcePositionAndContent {\n  sourcePosition: OriginalMapping | null\n  sourceContent: string | null\n}\n\nexport function findOriginalSourcePositionAndContent(\n  webpackSource: SourceMapInput | string,\n  position: { line: number; column: number | null }\n): IOriginalSourcePositionAndContent {\n  const tracer = new TraceMap(webpackSource)\n  const sourcePosition = originalPositionFor(tracer, {\n    line: position.line,\n    column: position.column ?? 0,\n  })\n\n  if (!sourcePosition.source) {\n    return {\n      sourcePosition: null,\n      sourceContent: null,\n    }\n  }\n\n  const sourceContent = sourceContentFor(tracer, sourcePosition.source)\n\n  return {\n    sourcePosition,\n    sourceContent,\n  }\n}\n"],"mappings":";;;;;;;;AAAA;;AACA;;AACA;;AAQA,MAAMA,EAAE,GAAGC,OAAO,CAAE,UAAF,CAAlB;;AACA,MAAMC,IAAI,GAAGD,OAAO,CAAE,MAAF,CAApB;;AACA,MAAME,KAAK,GAAGF,OAAO,CAAE,OAAF,CAArB;;AACA,MAAM;EAAEG;AAAF,IAA+BH,OAAO,CAAE,mBAAF,CAA5C;;AAEA,MAAMI,UAAU,GAAIC,GAAD,IAA0B;EAC3C;EACA;EACA;EACA,IAAI,OAAOA,GAAP,KAAgB,QAApB,EAA6B;IAC3B,OAAOJ,IAAI,CAACK,OAAL,CAAaD,GAAb,CAAP;EACD;;EACD,OAAQ,gBAAR;AACD,CARD;;AAUA,MAAME,cAAc,GAAGH,UAAU,CAACJ,OAAO,CAACQ,OAAR,CAAiB,qBAAjB,CAAD,CAAjC;AACA,MAAMC,kBAAkB,GAAGL,UAAU,CACnCJ,OAAO,CAACQ,OAAR,CAAiB,0BAAjB,CADmC,CAArC;AAGA,MAAME,aAAa,GAAGN,UAAU,CAACJ,OAAO,CAACQ,OAAR,CAAiB,oBAAjB,CAAD,CAAhC;;AAEA,MAAMG,oBAAoB,GAAG,MAC3BC,mBAAA,CACGC,GADH,GAEGC,IAFH,CAGIC,QAAQ,IACNA,QAAQ,IACRA,QAAQ,CAACC,WAAT,EADA,IAEA,CAACD,QAAQ,CAACC,WAAT,GAAuBC,QAAvB,CAAgCV,cAAhC,CAFD,IAGA,CAACQ,QAAQ,CAACC,WAAT,GAAuBC,QAAvB,CAAgCP,aAAhC,CAHD,IAIA,CAACK,QAAQ,CAACC,WAAT,GAAuBC,QAAvB,CAAgCR,kBAAhC,CAJD,IAKA,CAACN,wBAAwB,CAACY,QAAQ,CAACC,WAAT,EAAD,CAT/B,CADF;;AAoBO,MAAME,qBAAqB,GAAG,CAAC;EACpCC,aAAa,GAAG,IADoB;EAEpCC;AAFoC,IAMlC,EANiC,KAMP;EAC5B,IAAIL,QAAJ;;EACA,IAAIK,KAAJ,EAAW;IACTL,QAAQ,GAAGH,mBAAA,CAAWS,KAAX,CAAiB;MAAED,KAAF;MAASE,IAAI,EAAG,EAAhB;MAAmBC,OAAO,EAAG;IAA7B,CAAjB,EAAmD,CAAnD,CAAX;EACD,CAFD,MAEO;IACLR,QAAQ,GAAGJ,oBAAoB,EAA/B;EACD;;EAED,IAAI,CAACI,QAAL,EAAe;IACb,OAAO,IAAP;EACD;;EAED,MAAMS,QAAQ,GAAGT,QAAQ,CAACC,WAAT,EAAjB;EACA,MAAMS,IAAI,GAAGV,QAAQ,CAACW,aAAT,EAAb;EACA,MAAMC,MAAM,GAAGZ,QAAQ,CAACa,eAAT,EAAf;EAEA,MAAMC,IAAI,GAAG9B,EAAE,CAAC+B,YAAH,CAAgBN,QAAhB,EAA0B;IAAEO,QAAQ,EAAG;EAAb,CAA1B,CAAb;EACA,OAAO;IACLP,QADK;IAELC,IAFK;IAGLE,MAHK;IAILK,SAAS,EAAE,IAAAC,2BAAA,EACTJ,IADS,EAET;MACEK,KAAK,EAAE;QACLT,IADK;QAELE;MAFK;IADT,CAFS,EAQT;MACER;IADF,CARS;EAJN,CAAP;AAiBD,CAxCM;;;;AA0CA,MAAMgB,8BAA8B,GAAG,CAAC;EAC7ChB,aAAa,GAAG,IAD6B;EAE7CC;AAF6C,IAM3C,EAN0C,KAMpB;EACxB,MAAMgB,iBAAiB,GAAGlB,qBAAqB,CAAC;IAC9CC,aAD8C;IAE9CC;EAF8C,CAAD,CAA/C;;EAKA,IAAI,CAACgB,iBAAL,EAAwB;IACtB,OAAO,IAAP;EACD;;EAED,MAAM;IAAEZ,QAAF;IAAYC,IAAZ;IAAkBE,MAAlB;IAA0BK;EAA1B,IAAwCI,iBAA9C;EACA,OAAQ,QAAOlC,KAAK,CAACmC,IAAN,CAAY,GAAEb,QAAS,IAAGC,IAAK,IAAGE,MAAO,EAAzC,CAA4C,KAAIK,SAAU,EAAzE;AACD,CAlBM;;;;AAyBA,SAASM,oCAAT,CACLC,aADK,EAELC,QAFK,EAG8B;EAAA;;EACnC,MAAMC,MAAM,GAAG,IAAIC,sBAAJ,CAAaH,aAAb,CAAf;EACA,MAAMI,cAAc,GAAG,IAAAC,iCAAA,EAAoBH,MAApB,EAA4B;IACjDhB,IAAI,EAAEe,QAAQ,CAACf,IADkC;IAEjDE,MAAM,sBAAEa,QAAQ,CAACb,MAAX,+DAAqB;EAFsB,CAA5B,CAAvB;;EAKA,IAAI,CAACgB,cAAc,CAACE,MAApB,EAA4B;IAC1B,OAAO;MACLF,cAAc,EAAE,IADX;MAELG,aAAa,EAAE;IAFV,CAAP;EAID;;EAED,MAAMA,aAAa,GAAG,IAAAC,8BAAA,EAAiBN,MAAjB,EAAyBE,cAAc,CAACE,MAAxC,CAAtB;EAEA,OAAO;IACLF,cADK;IAELG;EAFK,CAAP;AAID"}