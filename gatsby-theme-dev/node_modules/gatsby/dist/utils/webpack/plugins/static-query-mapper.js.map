{"version":3,"file":"static-query-mapper.js","names":["removeExportQueryParam","path","split","doesModuleMatchResourcePath","resourcePath","webpackModule","ConcatenatedModule","resource","modules","some","innerModule","getRealPath","cache","componentPath","has","set","resolve","get","getWebpackModulesByResourcePaths","staticQueries","components","realPathCache","Map","webpackModulesByStaticQueryId","webpackModulesByComponentId","forEach","id","staticQuery","staticQueryComponentPath","Set","add","component","componentComponentPath","getChunkGroupsDerivedFromEntrypoint","chunkGroup","entrypoint","hasParent","chunkGroups","parentChunkGroup","getParents","newChunkGroup","concat","StaticQueryMapper","constructor","store","name","apply","compiler","staticQueryComponents","getState","hooks","done","tap","stats","compilation","parentCompilation","chunkGraph","staticQueriesByChunkGroup","chunkGroupsWithPageComponents","chunkGroupsByComponentPath","appEntryPoint","entrypoints","staticQueryId","webpackModules","chunkGroupsDerivedFromEntrypoints","chunk","getModuleChunksIterable","groupsIterable","push","staticQueryHashes","hash","generateComponentChunkName","globalStaticQueries","allStaticQueries","Array","from","sort","staticQueriesByTemplate","dispatch","type","payload","pages","hasErrors","watchMode","enqueueFlush"],"sources":["../../../../src/utils/webpack/plugins/static-query-mapper.ts"],"sourcesContent":["import path from \"path\"\nimport { Store } from \"redux\"\nimport { Compiler, Module, NormalModule, Compilation } from \"webpack\"\nimport ConcatenatedModule from \"webpack/lib/optimize/ConcatenatedModule\"\nimport { isEqual } from \"lodash\"\nimport { generateComponentChunkName } from \"../../js-chunk-names\"\nimport { enqueueFlush } from \"../../page-data\"\nimport type {\n  IGatsbyState,\n  IGatsbyPageComponent,\n  IGatsbyStaticQueryComponents,\n} from \"../../../redux/types\"\n\ntype ChunkGroup = Compilation[\"chunkGroups\"][0]\ntype EntryPoint = Compilation[\"asyncEntrypoints\"][0]\n\nconst removeExportQueryParam = (path: string | undefined): string | undefined =>\n  path?.split(`?`)[0]\n\n/**\n * Checks if a module matches a resourcePath\n */\nfunction doesModuleMatchResourcePath(\n  resourcePath: string,\n  webpackModule: Module | NormalModule | ConcatenatedModule\n): boolean {\n  if (!(webpackModule instanceof ConcatenatedModule)) {\n    return (\n      removeExportQueryParam((webpackModule as NormalModule).resource) ===\n      resourcePath\n    )\n  }\n\n  // ConcatenatedModule is a collection of modules so we have to go deeper to actually get it\n  return webpackModule.modules.some(\n    innerModule =>\n      removeExportQueryParam((innerModule as NormalModule).resource) ===\n      resourcePath\n  )\n}\n\n/**\n * A helper to set/get path resolving\n */\nfunction getRealPath(\n  cache: Map<string, string>,\n  componentPath: string\n): string {\n  if (!cache.has(componentPath)) {\n    cache.set(componentPath, path.resolve(componentPath))\n  }\n\n  return cache.get(componentPath) as string\n}\n\n/**\n * Grab the actual webpackModule from the resourcePath\n * We return staticQueries and componentPaths cause that's what we care about\n */\nfunction getWebpackModulesByResourcePaths(\n  modules: Set<Module>,\n  staticQueries: IGatsbyState[\"staticQueryComponents\"],\n  components: IGatsbyState[\"components\"]\n): {\n  webpackModulesByStaticQueryId: Map<string, Set<Module>>\n  webpackModulesByComponentId: Map<string, Set<Module>>\n} {\n  const realPathCache = new Map<string, string>()\n  const webpackModulesByStaticQueryId = new Map<string, Set<Module>>()\n  const webpackModulesByComponentId = new Map<string, Set<Module>>()\n\n  modules.forEach(webpackModule => {\n    for (const [id, staticQuery] of staticQueries) {\n      const staticQueryComponentPath = getRealPath(\n        realPathCache,\n        staticQuery.componentPath\n      )\n\n      if (\n        !doesModuleMatchResourcePath(staticQueryComponentPath, webpackModule)\n      ) {\n        continue\n      }\n\n      let set = webpackModulesByStaticQueryId.get(id)\n\n      if (!set) {\n        set = new Set()\n      }\n\n      set.add(webpackModule)\n\n      webpackModulesByStaticQueryId.set(id, set)\n    }\n\n    for (const [id, component] of components) {\n      const componentComponentPath = getRealPath(\n        realPathCache,\n        component.componentPath\n      )\n      if (!doesModuleMatchResourcePath(componentComponentPath, webpackModule)) {\n        continue\n      }\n\n      let set = webpackModulesByComponentId.get(id)\n\n      if (!set) {\n        set = new Set()\n      }\n\n      set.add(webpackModule)\n\n      webpackModulesByComponentId.set(id, set)\n    }\n  })\n\n  return { webpackModulesByStaticQueryId, webpackModulesByComponentId }\n}\n\n/**\n * Chunks can be async so the group might not represent a pageComponent group\n * We'll need to search for it.\n */\nfunction getChunkGroupsDerivedFromEntrypoint(\n  chunkGroup: ChunkGroup,\n  entrypoint: EntryPoint\n): Array<ChunkGroup> {\n  // when it's imported by any globals or async-requires we know we have the correct chunkgroups.\n  // Async modules won't have hasParent listed\n  if (chunkGroup.hasParent(entrypoint)) {\n    return [chunkGroup]\n  }\n\n  let chunkGroups: Array<ChunkGroup> = []\n  for (const parentChunkGroup of chunkGroup.getParents()) {\n    const newChunkGroup = getChunkGroupsDerivedFromEntrypoint(\n      parentChunkGroup,\n      entrypoint\n    )\n    chunkGroups = chunkGroups.concat(newChunkGroup)\n  }\n\n  return chunkGroups\n}\n\nexport class StaticQueryMapper {\n  private store: Store<IGatsbyState>\n  private name: string\n\n  constructor(store) {\n    this.store = store\n    this.name = `StaticQueryMapper`\n  }\n\n  apply(compiler: Compiler): void {\n    const { components, staticQueryComponents } = this.store.getState()\n\n    compiler.hooks.done.tap(this.name, stats => {\n      const compilation = stats.compilation\n      // We only care about the main compilation\n      // Chunkgraph should always be available when it's done but you know typescript.\n      if (compilation.compiler.parentCompilation || !compilation.chunkGraph) {\n        return\n      }\n\n      const staticQueriesByChunkGroup = new Map<ChunkGroup, Array<string>>()\n      const chunkGroupsWithPageComponents = new Set<ChunkGroup>()\n      const chunkGroupsByComponentPath = new Map<\n        IGatsbyPageComponent[\"componentPath\"],\n        ChunkGroup\n      >()\n\n      const { webpackModulesByStaticQueryId, webpackModulesByComponentId } =\n        getWebpackModulesByResourcePaths(\n          compilation.modules,\n          staticQueryComponents,\n          components\n        )\n\n      const appEntryPoint = (\n        compilation.entrypoints.has(`app`)\n          ? compilation.entrypoints.get(`app`)\n          : compilation.entrypoints.get(`commons`)\n      ) as EntryPoint\n\n      // group hashes by chunkGroup for ease of use\n      for (const [\n        staticQueryId,\n        webpackModules,\n      ] of webpackModulesByStaticQueryId) {\n        let chunkGroupsDerivedFromEntrypoints: Array<ChunkGroup> = []\n\n        for (const webpackModule of webpackModules) {\n          for (const chunk of compilation.chunkGraph.getModuleChunksIterable(\n            webpackModule\n          )) {\n            for (const chunkGroup of chunk.groupsIterable) {\n              if (chunkGroup === appEntryPoint) {\n                chunkGroupsDerivedFromEntrypoints.push(chunkGroup)\n              } else {\n                chunkGroupsDerivedFromEntrypoints =\n                  chunkGroupsDerivedFromEntrypoints.concat(\n                    getChunkGroupsDerivedFromEntrypoint(\n                      chunkGroup,\n                      appEntryPoint\n                    )\n                  )\n              }\n            }\n          }\n        }\n\n        // loop over all component chunkGroups or global ones\n        chunkGroupsDerivedFromEntrypoints.forEach(chunkGroup => {\n          const staticQueryHashes =\n            staticQueriesByChunkGroup.get(chunkGroup) ?? []\n\n          staticQueryHashes.push(\n            (\n              staticQueryComponents.get(\n                staticQueryId\n              ) as IGatsbyStaticQueryComponents\n            ).hash\n          )\n\n          staticQueriesByChunkGroup.set(chunkGroup, staticQueryHashes)\n        })\n      }\n\n      // group chunkGroups by componentPaths for ease of use\n      for (const [\n        componentPath,\n        webpackModules,\n      ] of webpackModulesByComponentId) {\n        for (const webpackModule of webpackModules) {\n          for (const chunk of compilation.chunkGraph.getModuleChunksIterable(\n            webpackModule\n          )) {\n            for (const chunkGroup of chunk.groupsIterable) {\n              // When it's a direct import from app entrypoint (async-requires) we know we have the correct chunkGroup\n              if (\n                chunkGroup.name === generateComponentChunkName(componentPath)\n              ) {\n                chunkGroupsWithPageComponents.add(chunkGroup)\n                chunkGroupsByComponentPath.set(componentPath, chunkGroup)\n              }\n            }\n          }\n        }\n      }\n\n      let globalStaticQueries: Array<string> = []\n      for (const [chunkGroup, staticQueryHashes] of staticQueriesByChunkGroup) {\n        // When a chunkgroup is not part of a pageComponent we know it's part of a global group.\n        if (!chunkGroupsWithPageComponents.has(chunkGroup)) {\n          globalStaticQueries = globalStaticQueries.concat(staticQueryHashes)\n        }\n      }\n\n      components.forEach(component => {\n        const allStaticQueries = new Set(globalStaticQueries)\n        if (chunkGroupsByComponentPath.has(component.componentPath)) {\n          const chunkGroup = chunkGroupsByComponentPath.get(\n            component.componentPath\n          )\n          if (chunkGroup && staticQueriesByChunkGroup.has(chunkGroup)) {\n            ;(\n              staticQueriesByChunkGroup.get(chunkGroup) as Array<string>\n            ).forEach(staticQuery => {\n              allStaticQueries.add(staticQuery)\n            })\n          }\n        }\n\n        // modules, chunks, chunkgroups can all have not-deterministic orders so\n        // just sort array of static queries we produced to ensure final result is deterministic\n        const staticQueryHashes = Array.from(allStaticQueries).sort()\n\n        if (\n          !isEqual(\n            this.store\n              .getState()\n              .staticQueriesByTemplate.get(component.componentPath),\n            staticQueryHashes\n          )\n        ) {\n          this.store.dispatch({\n            type: `ADD_PENDING_TEMPLATE_DATA_WRITE`,\n            payload: {\n              componentPath: component.componentPath,\n              pages: component.pages,\n            },\n          })\n\n          this.store.dispatch({\n            type: `SET_STATIC_QUERIES_BY_TEMPLATE`,\n            payload: {\n              componentPath: component.componentPath,\n              staticQueryHashes,\n            },\n          })\n        }\n      })\n\n      // In dev mode we want to write page-data when compilation succeeds\n      if (!stats.hasErrors() && compiler.watchMode) {\n        enqueueFlush()\n      }\n    })\n  }\n}\n"],"mappings":"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"}