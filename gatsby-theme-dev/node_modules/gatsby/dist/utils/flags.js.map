{"version":3,"file":"flags.js","names":["satisfiesSemvers","semverConstraints","result","every","packageName","semverConstraint","packageVersion","require","version","e","semver","satisfies","includePrerelease","activeFlags","name","env","command","telemetryId","experimental","description","includedFlags","testFitness","umbrellaIssue","noCI","requires","major","minor","process","versions","node","split","Number"],"sources":["../../src/utils/flags.ts"],"sourcesContent":["import _ from \"lodash\"\nimport semver from \"semver\"\n\n// Does this experiment run for only builds\ntype executingCommand = \"build\" | \"develop\" | \"all\"\n\nexport const satisfiesSemvers = (\n  semverConstraints: Record<string, string>\n): boolean => {\n  // Check each semver check for the flag.\n  // If any are false, then the flag doesn't pass\n  const result = _.toPairs(semverConstraints).every(\n    ([packageName, semverConstraint]) => {\n      let packageVersion: string\n      try {\n        packageVersion = require(`${packageName}/package.json`).version\n      } catch (e) {\n        return false\n      }\n\n      // We care if the semver check doesn't pass.\n      return semver.satisfies(packageVersion, semverConstraint, {\n        includePrerelease: true,\n      })\n    }\n  )\n\n  return result\n}\n\nexport type fitnessEnum = true | false | \"OPT_IN\" | \"LOCKED_IN\"\n\nexport interface IFlag {\n  name: string\n  env: string\n  description: string\n  command: executingCommand\n  /**\n   * Use string identifier to track enabled flag or false to disable any tracking (useful when flag becomes new defaults)\n   */\n  telemetryId: string | false\n  // Heuristics for deciding if a flag is experimental:\n  // - there are known bugs most people will encounter and that block being\n  // able to use Gatsby normally\n  // - very few people have tested the feature so we're not sure if we've\n  // uncovered even common problems.\n  //\n  // Flags should start as experimental but once all serious known bugs are\n  // resolved and ~50+ people have tested it, experimental should be set to\n  // false.\n  experimental: boolean\n  /**\n   * True means conditions for the feature are met and can be opted in by user.\n   *\n   * False means it'll be disabled despite the user setting it true e.g.\n   * it just won't work e.g. it doesn't have new enough version for something.\n   *\n   * OPT_IN means the gatsby will enable the flag (unless the user explicitly\n   * disables it.\n   *\n   * LOCKED_IN means that feature is enabled always (unless `noCI` condition is met).\n   * This is mostly to provide more meaningful terminal messages instead of removing\n   * flag from the flag list when users has the flag set in configuration\n   * (avoids showing unknown flag message and shows \"no longer needed\" message).\n   */\n  testFitness: (flag: IFlag) => fitnessEnum\n  /**\n   * Human-readable text explaining requirements for this feature to be available\n   * (e.g. requires Node 14+)\n   *\n   * It is shown to users when testFitness() returns `false` but flag is set in gatsby-config.js\n   */\n  requires?: string\n  includedFlags?: Array<string>\n  umbrellaIssue?: string\n  noCI?: boolean\n}\n\nconst activeFlags: Array<IFlag> = [\n  {\n    name: `FAST_DEV`,\n    env: `GATSBY_EXPERIMENTAL_FAST_DEV`,\n    command: `develop`,\n    telemetryId: `FastDev`,\n    experimental: false,\n    description: `Enable all experiments aimed at improving develop server start time.`,\n    includedFlags: [\n      `DEV_SSR`,\n      `PRESERVE_FILE_DOWNLOAD_CACHE`,\n      `DEV_WEBPACK_CACHE`,\n    ],\n    testFitness: (): fitnessEnum => true,\n  },\n  {\n    name: `DEV_SSR`,\n    env: `GATSBY_EXPERIMENTAL_DEV_SSR`,\n    command: `develop`,\n    telemetryId: `DevSsr`,\n    experimental: false,\n    description: `Server Side Render (SSR) pages on full reloads during develop. Helps you detect SSR bugs and fix them without needing to do full builds.`,\n    umbrellaIssue: `https://gatsby.dev/dev-ssr-feedback`,\n    testFitness: (): fitnessEnum => true,\n  },\n  {\n    name: `QUERY_ON_DEMAND`,\n    env: `GATSBY_EXPERIMENTAL_QUERY_ON_DEMAND`,\n    command: `develop`,\n    telemetryId: false,\n    experimental: false,\n    description: `Only run queries when needed instead of running all queries upfront. Speeds starting the develop server.`,\n    umbrellaIssue: `https://gatsby.dev/query-on-demand-feedback`,\n    noCI: true,\n    testFitness: (): fitnessEnum => `LOCKED_IN`,\n  },\n  {\n    name: `LAZY_IMAGES`,\n    env: `GATSBY_EXPERIMENTAL_LAZY_IMAGES`,\n    command: `develop`,\n    telemetryId: false,\n    experimental: false,\n    description: `Don't process images during development until they're requested from the browser. Speeds starting the develop server. Requires gatsby-plugin-sharp@2.10.0 or above.`,\n    umbrellaIssue: `https://gatsby.dev/lazy-images-feedback`,\n    noCI: true,\n    testFitness: (): fitnessEnum => {\n      const semverConstraints = {\n        // Because of this, this flag will never show up\n        \"gatsby-plugin-sharp\": `>=2.10.0`,\n      }\n      if (satisfiesSemvers(semverConstraints)) {\n        return `LOCKED_IN`\n      } else {\n        // gatsby-plugin-sharp is either not installed or not new enough so\n        // just disable â€” it won't work anyways.\n        return false\n      }\n    },\n    requires: `Requires gatsby-plugin-sharp@2.10.0 or above.`,\n  },\n  {\n    name: `PRESERVE_WEBPACK_CACHE`,\n    env: `GATSBY_EXPERIMENTAL_PRESERVE_WEBPACK_CACHE`,\n    command: `all`,\n    telemetryId: `PreserveWebpackCache`,\n    experimental: false,\n    description: `Use webpack's persistent caching and don't delete webpack's cache when changing gatsby-node.js & gatsby-config.js files.`,\n    umbrellaIssue: `https://gatsby.dev/cache-clearing-feedback`,\n    testFitness: (): fitnessEnum => `LOCKED_IN`,\n  },\n  {\n    name: `DEV_WEBPACK_CACHE`,\n    env: `GATSBY_EXPERIMENTAL_DEV_WEBPACK_CACHE`,\n    command: `develop`,\n    telemetryId: `DevWebackCache`,\n    experimental: false,\n    description: `Enable webpack's persistent caching during development. Speeds up the start of the development server.`,\n    umbrellaIssue: `https://gatsby.dev/cache-clearing-feedback`,\n    testFitness: (): fitnessEnum => `LOCKED_IN`,\n  },\n  {\n    name: `PRESERVE_FILE_DOWNLOAD_CACHE`,\n    env: `GATSBY_EXPERIMENTAL_PRESERVE_FILE_DOWNLOAD_CACHE`,\n    command: `all`,\n    telemetryId: `PreserveFileDownloadCache`,\n    experimental: false,\n    description: `Don't delete the downloaded files cache when changing gatsby-node.js & gatsby-config.js files.`,\n    umbrellaIssue: `https://gatsby.dev/cache-clearing-feedback`,\n    testFitness: (): fitnessEnum => true,\n  },\n  {\n    name: `PARALLEL_SOURCING`,\n    env: `GATSBY_EXPERIMENTAL_PARALLEL_SOURCING`,\n    command: `all`,\n    telemetryId: `ParallelSourcing`,\n    experimental: true,\n    description: `Run all source plugins at the same time instead of serially. For sites with multiple source plugins, this can speedup sourcing and transforming considerably.`,\n    umbrellaIssue: `https://gatsby.dev/parallel-sourcing-feedback`,\n    testFitness: (): fitnessEnum => true,\n  },\n  {\n    name: `LMDB_STORE`,\n    env: `GATSBY_EXPERIMENTAL_LMDB_STORE`,\n    command: `all`,\n    telemetryId: `LmdbStore`,\n    experimental: true,\n    umbrellaIssue: `https://gatsby.dev/lmdb-feedback`,\n    description: `Store nodes in a persistent embedded database (vs in-memory). Lowers peak memory usage. Requires Node v14.10 or above.`,\n    testFitness: (): fitnessEnum => {\n      if (_CFLAGS_.GATSBY_MAJOR === `4`) {\n        return `LOCKED_IN`\n      }\n\n      const [major, minor] = process.versions.node.split(`.`)\n      return (Number(major) === 14 && Number(minor) >= 10) || Number(major) > 14\n    },\n    requires: `Requires Node v14.10 or above.`,\n  },\n  {\n    name: `PARALLEL_QUERY_RUNNING`,\n    env: `GATSBY_EXPERIMENTAL_PARALLEL_QUERY_RUNNING`,\n    command: `build`,\n    telemetryId: `PQR`,\n    experimental: true,\n    umbrellaIssue: `https://gatsby.dev/pqr-feedback`,\n    description: `Parallelize running page queries in order to better saturate all available cores. Improves time it takes to run queries during gatsby build. Requires Node v14.10 or above.`,\n    includedFlags: [`LMDB_STORE`],\n    testFitness: (): fitnessEnum => {\n      if (_CFLAGS_.GATSBY_MAJOR === `4`) {\n        return `LOCKED_IN`\n      }\n\n      const [major, minor] = process.versions.node.split(`.`)\n      return (Number(major) === 14 && Number(minor) >= 10) || Number(major) > 14\n    },\n    requires: `Requires Node v14.10 or above.`,\n  },\n  {\n    name: `DETECT_NODE_MUTATIONS`,\n    env: `GATSBY_DETECT_NODE_MUTATIONS`,\n    command: `all`,\n    telemetryId: `DetectNodeMutations`,\n    description: `Diagnostic mode to log any attempts to mutate node directly. Helpful when debugging missing data problems. See https://gatsby.dev/debugging-missing-data for more details.`,\n    experimental: false,\n    testFitness: (): fitnessEnum => true,\n  },\n  {\n    name: `GRAPHQL_TYPEGEN`,\n    env: `GATSBY_GRAPHQL_TYPEGEN`,\n    command: `develop`,\n    telemetryId: `GraphQLTypegen`,\n    description: `More easily incorporate content into your pages through automatic TypeScript type generation and better GraphQL IntelliSense.`,\n    umbrellaIssue: `https://github.com/gatsbyjs/gatsby/discussions/35420`,\n    experimental: false,\n    noCI: true,\n    testFitness: (): fitnessEnum => false,\n    requires: `As of gatsby@4.15.0 this feature is available as a config option inside gatsby-config. Learn more at https://gatsby.dev/graphql-typegen`,\n  },\n]\n\nexport default activeFlags\n"],"mappings":"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"}