{"version":3,"file":"gatsby-webpack-stats-extractor.js","names":["GatsbyWebpackStatsExtractor","constructor","plugin","name","apply","compiler","previousChunkMapJson","previousWebpackStatsJson","hooks","done","tapAsync","stats","assets","assetsMap","childAssets","chunkGroup","compilation","chunkGroups","files","chunk","chunks","push","filter","f","slice","length","map","filename","rel","childChunkGroups","Object","entries","getChildrenByOrders","moduleGraph","chunkGraph","childFiles","childChunkGroup","webpackStats","toJson","all","assetsByChunkName","childAssetsByChunkName","newChunkMapJson","JSON","stringify","fs","writeFile","path","join","newWebpackStatsJson"],"sources":["../../src/utils/gatsby-webpack-stats-extractor.ts"],"sourcesContent":["import fs from \"fs-extra\"\nimport path from \"path\"\nimport { Compiler } from \"webpack\"\n\nexport class GatsbyWebpackStatsExtractor {\n  private plugin: { name: string }\n  constructor() {\n    this.plugin = { name: `GatsbyWebpackStatsExtractor` }\n  }\n  apply(compiler: Compiler): void {\n    let previousChunkMapJson: string | undefined\n    let previousWebpackStatsJson: string | undefined\n    compiler.hooks.done.tapAsync(this.plugin.name, async (stats, done) => {\n      const assets = {}\n      const assetsMap = {}\n      const childAssets = {}\n      for (const chunkGroup of stats.compilation.chunkGroups) {\n        if (chunkGroup.name) {\n          const files: Array<string> = []\n          for (const chunk of chunkGroup.chunks) {\n            files.push(...chunk.files)\n          }\n          assets[chunkGroup.name] = files.filter(f => f.slice(-4) !== `.map`)\n          assetsMap[chunkGroup.name] = files\n            .filter(\n              f =>\n                f.slice(-4) !== `.map` &&\n                f.slice(0, chunkGroup.name?.length) === chunkGroup.name\n            )\n            .map(filename => `/${filename}`)\n\n          for (const [rel, childChunkGroups] of Object.entries(\n            chunkGroup.getChildrenByOrders(\n              stats.compilation.moduleGraph,\n              stats.compilation.chunkGraph\n            )\n          )) {\n            if (!(chunkGroup.name in childAssets)) {\n              childAssets[chunkGroup.name] = {}\n            }\n\n            const childFiles: Array<string> = []\n            for (const childChunkGroup of childChunkGroups) {\n              for (const chunk of childChunkGroup.chunks) {\n                childFiles.push(...chunk.files)\n              }\n            }\n\n            childAssets[chunkGroup.name][rel] = childFiles\n          }\n        }\n      }\n\n      const webpackStats = {\n        ...stats.toJson({ all: false, chunkGroups: true }),\n        assetsByChunkName: assets,\n        childAssetsByChunkName: childAssets,\n      }\n\n      const newChunkMapJson = JSON.stringify(assetsMap)\n      if (newChunkMapJson !== previousChunkMapJson) {\n        await fs.writeFile(\n          path.join(`public`, `chunk-map.json`),\n          newChunkMapJson\n        )\n        previousChunkMapJson = newChunkMapJson\n      }\n\n      const newWebpackStatsJson = JSON.stringify(webpackStats)\n      if (newWebpackStatsJson !== previousWebpackStatsJson) {\n        await fs.writeFile(\n          path.join(`public`, `webpack.stats.json`),\n          newWebpackStatsJson\n        )\n        previousWebpackStatsJson = newWebpackStatsJson\n      }\n\n      done()\n    })\n  }\n}\n"],"mappings":";;;;;;;AAAA;;AACA;;AAGO,MAAMA,2BAAN,CAAkC;EAEvCC,WAAW,GAAG;IACZ,KAAKC,MAAL,GAAc;MAAEC,IAAI,EAAG;IAAT,CAAd;EACD;;EACDC,KAAK,CAACC,QAAD,EAA2B;IAC9B,IAAIC,oBAAJ;IACA,IAAIC,wBAAJ;IACAF,QAAQ,CAACG,KAAT,CAAeC,IAAf,CAAoBC,QAApB,CAA6B,KAAKR,MAAL,CAAYC,IAAzC,EAA+C,OAAOQ,KAAP,EAAcF,IAAd,KAAuB;MACpE,MAAMG,MAAM,GAAG,EAAf;MACA,MAAMC,SAAS,GAAG,EAAlB;MACA,MAAMC,WAAW,GAAG,EAApB;;MACA,KAAK,MAAMC,UAAX,IAAyBJ,KAAK,CAACK,WAAN,CAAkBC,WAA3C,EAAwD;QACtD,IAAIF,UAAU,CAACZ,IAAf,EAAqB;UACnB,MAAMe,KAAoB,GAAG,EAA7B;;UACA,KAAK,MAAMC,KAAX,IAAoBJ,UAAU,CAACK,MAA/B,EAAuC;YACrCF,KAAK,CAACG,IAAN,CAAW,GAAGF,KAAK,CAACD,KAApB;UACD;;UACDN,MAAM,CAACG,UAAU,CAACZ,IAAZ,CAAN,GAA0Be,KAAK,CAACI,MAAN,CAAaC,CAAC,IAAIA,CAAC,CAACC,KAAF,CAAQ,CAAC,CAAT,MAAiB,MAAnC,CAA1B;UACAX,SAAS,CAACE,UAAU,CAACZ,IAAZ,CAAT,GAA6Be,KAAK,CAC/BI,MAD0B,CAEzBC,CAAC;YAAA;;YAAA,OACCA,CAAC,CAACC,KAAF,CAAQ,CAAC,CAAT,MAAiB,MAAjB,IACAD,CAAC,CAACC,KAAF,CAAQ,CAAR,sBAAWT,UAAU,CAACZ,IAAtB,qDAAW,iBAAiBsB,MAA5B,MAAwCV,UAAU,CAACZ,IAFpD;UAAA,CAFwB,EAM1BuB,GAN0B,CAMtBC,QAAQ,IAAK,IAAGA,QAAS,EANH,CAA7B;;UAQA,KAAK,MAAM,CAACC,GAAD,EAAMC,gBAAN,CAAX,IAAsCC,MAAM,CAACC,OAAP,CACpChB,UAAU,CAACiB,mBAAX,CACErB,KAAK,CAACK,WAAN,CAAkBiB,WADpB,EAEEtB,KAAK,CAACK,WAAN,CAAkBkB,UAFpB,CADoC,CAAtC,EAKG;YACD,IAAI,EAAEnB,UAAU,CAACZ,IAAX,IAAmBW,WAArB,CAAJ,EAAuC;cACrCA,WAAW,CAACC,UAAU,CAACZ,IAAZ,CAAX,GAA+B,EAA/B;YACD;;YAED,MAAMgC,UAAyB,GAAG,EAAlC;;YACA,KAAK,MAAMC,eAAX,IAA8BP,gBAA9B,EAAgD;cAC9C,KAAK,MAAMV,KAAX,IAAoBiB,eAAe,CAAChB,MAApC,EAA4C;gBAC1Ce,UAAU,CAACd,IAAX,CAAgB,GAAGF,KAAK,CAACD,KAAzB;cACD;YACF;;YAEDJ,WAAW,CAACC,UAAU,CAACZ,IAAZ,CAAX,CAA6ByB,GAA7B,IAAoCO,UAApC;UACD;QACF;MACF;;MAED,MAAME,YAAY,GAAG,EACnB,GAAG1B,KAAK,CAAC2B,MAAN,CAAa;UAAEC,GAAG,EAAE,KAAP;UAActB,WAAW,EAAE;QAA3B,CAAb,CADgB;QAEnBuB,iBAAiB,EAAE5B,MAFA;QAGnB6B,sBAAsB,EAAE3B;MAHL,CAArB;MAMA,MAAM4B,eAAe,GAAGC,IAAI,CAACC,SAAL,CAAe/B,SAAf,CAAxB;;MACA,IAAI6B,eAAe,KAAKpC,oBAAxB,EAA8C;QAC5C,MAAMuC,gBAAA,CAAGC,SAAH,CACJC,aAAA,CAAKC,IAAL,CAAW,QAAX,EAAqB,gBAArB,CADI,EAEJN,eAFI,CAAN;QAIApC,oBAAoB,GAAGoC,eAAvB;MACD;;MAED,MAAMO,mBAAmB,GAAGN,IAAI,CAACC,SAAL,CAAeP,YAAf,CAA5B;;MACA,IAAIY,mBAAmB,KAAK1C,wBAA5B,EAAsD;QACpD,MAAMsC,gBAAA,CAAGC,SAAH,CACJC,aAAA,CAAKC,IAAL,CAAW,QAAX,EAAqB,oBAArB,CADI,EAEJC,mBAFI,CAAN;QAIA1C,wBAAwB,GAAG0C,mBAA3B;MACD;;MAEDxC,IAAI;IACL,CAlED;EAmED;;AA3EsC"}