{"version":3,"file":"middleware.js","names":["expressBuiltinMiddleware","urlencoded","text","json","raw","createSetContextFunctionMiddleware","getFunctions","prepareFn","showDebugMessageInResponse","executeFunction","req","res","next","functions","pathFragment","params","functionObj","find","functionRoute","some","f","matchPath","matchResult","reachMatch","userConfig","pathToFunction","absoluteCompiledFilePath","fnToExecute","require","cache","resolve","fn","config","default","e","message","includes","originalAbsoluteFilePath","undefined","reporter","error","headersSent","status","send","sendStatus","context","createConfig","setCookies","_res","cookies","headers","cookie","parse","bodyParserMiddlewareWithConfig","type","bodyParser","bodyParserConfig","verbose","start","Date","now","Promise","end","log","functionMiddlewares","middlewareConfig","setContext","multer","any"],"sources":["../../../src/internal-plugins/functions/middleware.ts"],"sourcesContent":["import { match as reachMatch } from \"@gatsbyjs/reach-router/lib/utils\"\nimport cookie from \"cookie\"\nimport { urlencoded, text, json, raw } from \"express\"\nimport type { RequestHandler, Request, Response, NextFunction } from \"express\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport multer from \"multer\"\n\nimport {\n  createConfig,\n  IGatsbyFunctionConfigProcessed,\n  IGatsbyBodyParserConfigProcessed,\n} from \"./config\"\nimport type { IGatsbyFunction } from \"../../redux/types\"\n\nconst expressBuiltinMiddleware = {\n  urlencoded,\n  text,\n  json,\n  raw,\n}\n\ninterface IGatsbyRequestContext {\n  functionObj: IGatsbyFunction\n  fnToExecute: (req: Request, res: Response) => void | Promise<void>\n  // we massage params early in setContext middleware, but apparently other middlewares\n  // reset it, so we will store those on our context and restore later\n  params: Request[\"params\"]\n  config: IGatsbyFunctionConfigProcessed\n  showDebugMessageInResponse: boolean\n}\n\ninterface IGatsbyInternalRequest extends Request {\n  context?: IGatsbyRequestContext\n}\n\ntype IGatsbyMiddleware = (\n  req: IGatsbyInternalRequest,\n  res: Response,\n  next: NextFunction\n) => Promise<void> | void\n\ninterface ICreateMiddlewareConfig {\n  getFunctions: () => Array<IGatsbyFunction>\n  prepareFn?: (functionObj: IGatsbyFunction) => Promise<void> | void\n  showDebugMessageInResponse?: boolean\n}\n\nfunction createSetContextFunctionMiddleware({\n  getFunctions,\n  prepareFn,\n  showDebugMessageInResponse,\n}: ICreateMiddlewareConfig): IGatsbyMiddleware {\n  return async function executeFunction(\n    req: IGatsbyInternalRequest,\n    res: Response,\n    next: NextFunction\n  ): Promise<void> {\n    const functions = getFunctions()\n    const { \"0\": pathFragment } = req.params\n\n    // Check first for exact matches.\n    let functionObj = functions.find(\n      ({ functionRoute }) => functionRoute === pathFragment\n    )\n\n    if (!functionObj) {\n      // Check if there's any matchPaths that match.\n      // We loop until we find the first match.\n      functions.some(f => {\n        if (f.matchPath) {\n          const matchResult = reachMatch(f.matchPath, pathFragment)\n          if (matchResult) {\n            req.params = matchResult.params\n            if (req.params[`*`]) {\n              // Backwards compatability for v3\n              // TODO remove in v5\n              req.params[`0`] = req.params[`*`]\n            }\n            functionObj = f\n\n            return true\n          }\n        }\n\n        return false\n      })\n    }\n\n    if (functionObj) {\n      let userConfig\n      if (prepareFn) {\n        await prepareFn(functionObj)\n      }\n\n      const pathToFunction = functionObj.absoluteCompiledFilePath\n      let fnToExecute\n      try {\n        delete require.cache[require.resolve(pathToFunction)]\n        const fn = require(pathToFunction)\n        userConfig = fn?.config\n\n        fnToExecute = (fn && fn.default) || fn\n      } catch (e) {\n        if (e?.message?.includes(`fnToExecute is not a function`)) {\n          e.message = `${functionObj.originalAbsoluteFilePath} does not export a function.`\n        }\n\n        fnToExecute = undefined\n        reporter.error(e)\n        if (!res.headersSent) {\n          if (showDebugMessageInResponse) {\n            res\n              .status(500)\n              .send(\n                `Error when executing function \"${functionObj.originalAbsoluteFilePath}\":<br /><br />${e.message}`\n              )\n          } else {\n            res.sendStatus(500)\n          }\n        }\n        return\n      }\n\n      if (fnToExecute) {\n        req.context = {\n          functionObj,\n          fnToExecute,\n          params: req.params,\n          config: createConfig(userConfig, functionObj),\n          showDebugMessageInResponse: showDebugMessageInResponse ?? false,\n        }\n      }\n    }\n\n    next()\n  }\n}\n\nfunction setCookies(\n  req: IGatsbyInternalRequest,\n  _res: Response,\n  next: NextFunction\n): void {\n  const cookies = req.headers.cookie\n\n  if (!cookies) {\n    return next()\n  }\n\n  req.cookies = cookie.parse(cookies)\n\n  return next()\n}\n\nfunction bodyParserMiddlewareWithConfig(\n  type: keyof IGatsbyBodyParserConfigProcessed\n): IGatsbyMiddleware {\n  return function (\n    req: IGatsbyInternalRequest,\n    res: Response,\n    next: NextFunction\n  ): void {\n    if (req.context && req.context.config.bodyParser) {\n      const bodyParserConfig = req.context.config.bodyParser[type]\n      expressBuiltinMiddleware[type](bodyParserConfig)(req, res, next)\n    } else {\n      next()\n    }\n  }\n}\n\nasync function executeFunction(\n  req: IGatsbyInternalRequest,\n  res: Response,\n  next: NextFunction\n): Promise<void> {\n  if (req.context) {\n    reporter.verbose(`Running ${req.context.functionObj.functionRoute}`)\n    req.params = req.context.params\n    const start = Date.now()\n    const context = req.context\n    // we don't want to leak internal context to actual request handler\n    delete req.context\n    try {\n      await Promise.resolve(context.fnToExecute(req, res))\n    } catch (e) {\n      if (e?.message?.includes(`fnToExecute is not a function`)) {\n        e.message = `${context.functionObj.originalAbsoluteFilePath} does not export a function.`\n      }\n\n      reporter.error(e)\n      // Don't send the error if that would cause another error.\n      if (!res.headersSent) {\n        if (context.showDebugMessageInResponse) {\n          res\n            .status(500)\n            .send(\n              `Error when executing function \"${context.functionObj.originalAbsoluteFilePath}\":<br /><br />${e.message}`\n            )\n        } else {\n          res.sendStatus(500)\n        }\n      }\n    }\n\n    const end = Date.now()\n    reporter.log(\n      `Executed function \"/api/${context.functionObj.functionRoute}\" in ${\n        end - start\n      }ms`\n    )\n  } else {\n    next()\n  }\n}\n\nexport function functionMiddlewares(\n  middlewareConfig: ICreateMiddlewareConfig\n): Array<RequestHandler> {\n  const setContext = createSetContextFunctionMiddleware(middlewareConfig)\n\n  return [\n    setCookies,\n    setContext,\n    multer().any(),\n    bodyParserMiddlewareWithConfig(`raw`),\n    bodyParserMiddlewareWithConfig(`text`),\n    bodyParserMiddlewareWithConfig(`urlencoded`),\n    bodyParserMiddlewareWithConfig(`json`),\n    executeFunction,\n  ]\n}\n"],"mappings":"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"}