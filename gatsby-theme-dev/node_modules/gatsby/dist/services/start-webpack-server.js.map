{"version":3,"file":"start-webpack-server.js","names":["startWebpackServer","program","app","workerPool","store","report","panic","compiler","webpackActivity","websocketManager","webpackWatching","startServer","hooks","invalid","tap","pendingActivity","id","markWebpackStatusAsPending","watchRun","tapAsync","_","done","activityTimer","start","isFirstCompile","Promise","resolve","stats","suspend","urls","prepareUrls","https","host","port","isSuccessful","hasErrors","showExperimentNotices","printInstructions","sitePackageJson","name","open","openurl","localUrlForBrowser","console","log","chalk","yellow","hasWarnings","rawMessages","toJson","all","warnings","reportWebpackWarnings","errors","structureWebpackErrors","Stage","Develop","compilation","panicOnBuild","end","markWebpackStatusAsDone","emitter","emit"],"sources":["../../src/services/start-webpack-server.ts"],"sourcesContent":["import openurl from \"better-opn\"\nimport report from \"gatsby-cli/lib/reporter\"\nimport chalk from \"chalk\"\nimport { Compiler } from \"webpack\"\nimport { Stage } from \"../commands/types\"\n\nimport {\n  reportWebpackWarnings,\n  structureWebpackErrors,\n} from \"../utils/webpack-error-utils\"\n\nimport { showExperimentNotices } from \"../utils/show-experiment-notice\"\nimport { printInstructions } from \"../utils/print-instructions\"\nimport { prepareUrls } from \"../utils/prepare-urls\"\nimport { startServer, IWebpackWatchingPauseResume } from \"../utils/start-server\"\nimport { WebsocketManager } from \"../utils/websocket-manager\"\nimport { IBuildContext } from \"./\"\nimport {\n  markWebpackStatusAsPending,\n  markWebpackStatusAsDone,\n} from \"../utils/webpack-status\"\nimport { emitter } from \"../redux\"\n\nexport async function startWebpackServer({\n  program,\n  app,\n  workerPool,\n  store,\n}: Partial<IBuildContext>): Promise<{\n  compiler: Compiler\n  websocketManager: WebsocketManager\n  webpackWatching: IWebpackWatchingPauseResume\n}> {\n  if (!program || !app || !store) {\n    report.panic(`Missing required params`)\n  }\n  let { compiler, webpackActivity, websocketManager, webpackWatching } =\n    await startServer(program, app, workerPool)\n\n  compiler.hooks.invalid.tap(`log compiling`, function () {\n    if (!webpackActivity) {\n      // mark webpack as pending if we are not in the middle of compilation already\n      // when input is invalidated during compilation, webpack will automatically\n      // run another compilation round before triggering `done` event\n      report.pendingActivity({ id: `webpack-develop` })\n      markWebpackStatusAsPending()\n    }\n  })\n\n  compiler.hooks.watchRun.tapAsync(`log compiling`, function (_, done) {\n    if (!webpackActivity) {\n      // there can be multiple `watchRun` events before receiving single `done` event\n      // webpack will not emit assets or `done` event until all pending invalidated\n      // inputs were compiled\n      webpackActivity = report.activityTimer(`Re-building development bundle`, {\n        id: `webpack-develop`,\n      })\n      webpackActivity.start()\n    }\n\n    done()\n  })\n\n  let isFirstCompile = true\n\n  return new Promise(resolve => {\n    compiler.hooks.done.tapAsync(\n      `print gatsby instructions`,\n      async function (stats, done) {\n        if (isFirstCompile) {\n          webpackWatching.suspend()\n        }\n\n        const urls = prepareUrls(\n          program.https ? `https` : `http`,\n          program.host,\n          program.port\n        )\n        const isSuccessful = !stats.hasErrors()\n\n        if (isSuccessful && isFirstCompile) {\n          // Show notices to users about potential experiments/feature flags they could\n          // try.\n          showExperimentNotices()\n          printInstructions(\n            program.sitePackageJson.name || `(Unnamed package)`,\n            urls\n          )\n\n          if (program.open) {\n            try {\n              await openurl(urls.localUrlForBrowser)\n            } catch {\n              console.log(\n                `${chalk.yellow(\n                  `warn`\n                )} Browser not opened because no browser was found`\n              )\n            }\n          }\n        }\n\n        isFirstCompile = false\n\n        if (webpackActivity) {\n          if (stats.hasWarnings()) {\n            const rawMessages = stats.toJson({ all: false, warnings: true })\n            reportWebpackWarnings(rawMessages.warnings, report)\n          }\n\n          if (!isSuccessful) {\n            const errors = structureWebpackErrors(\n              Stage.Develop,\n              stats.compilation.errors\n            )\n            webpackActivity.panicOnBuild(errors)\n          }\n          webpackActivity.end()\n          webpackActivity = null\n        }\n\n        markWebpackStatusAsDone()\n        done()\n        emitter.emit(`COMPILATION_DONE`, stats)\n        resolve({ compiler, websocketManager, webpackWatching })\n      }\n    )\n  })\n}\n"],"mappings":"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"}