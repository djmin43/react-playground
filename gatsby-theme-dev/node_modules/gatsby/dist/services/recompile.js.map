{"version":3,"file":"recompile.js","names":["recompile","context","stats","Promise","all","recompileDevBundle","recompileSSRBundle","webpackWatching","reporter","panic","resolve","finish","emitter","off","on","resume","suspend","program","websocketManager","recompiledFiles","Set","includesSSRComponent","verbose","close","rendererPath","buildRenderer","Stage","DevelopHTML","clearRequireCacheRecursively","emitStaleServerData","result","Array","from","map","path","isSSRPageComponent","some","isSSR","filename","fs","pathExists","lstat","isFile","text","readFile","includes"],"sources":["../../src/services/recompile.ts"],"sourcesContent":["/* eslint-disable no-unused-expressions */\nimport { IBuildContext } from \"./types\"\nimport * as fs from \"fs-extra\"\nimport { Stats } from \"webpack\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport { emitter } from \"../redux\"\nimport { buildRenderer } from \"../commands/build-html\"\nimport { Stage } from \"../commands/types\"\nimport { clearRequireCacheRecursively } from \"../utils/clear-require-cache\"\n\nexport async function recompile(context: IBuildContext): Promise<Stats> {\n  const [stats] = await Promise.all([\n    recompileDevBundle(context),\n    recompileSSRBundle(context),\n  ])\n  return stats\n}\n\nasync function recompileDevBundle({\n  webpackWatching,\n}: IBuildContext): Promise<Stats> {\n  if (!webpackWatching) {\n    reporter.panic(`Missing compiler`)\n  }\n  return new Promise<Stats>(resolve => {\n    function finish(stats: Stats): void {\n      emitter.off(`COMPILATION_DONE`, finish)\n      resolve(stats)\n    }\n    emitter.on(`COMPILATION_DONE`, finish)\n    webpackWatching.resume()\n    // Suspending is just a flag, so it's safe to re-suspend right away\n    webpackWatching.suspend()\n  })\n}\n\nasync function recompileSSRBundle({\n  program,\n  websocketManager,\n  recompiledFiles = new Set(),\n}: IBuildContext): Promise<void> {\n  if (!(await includesSSRComponent(recompiledFiles))) {\n    return\n  }\n  reporter.verbose(`Recompiling SSR bundle`)\n\n  const { close, rendererPath } = await buildRenderer(\n    program,\n    Stage.DevelopHTML\n  )\n\n  clearRequireCacheRecursively(rendererPath)\n\n  if (websocketManager) {\n    websocketManager.emitStaleServerData()\n  }\n\n  await close()\n}\n\nasync function includesSSRComponent(\n  recompiledFiles: Set<string>\n): Promise<boolean> {\n  const result = await Promise.all(\n    Array.from(recompiledFiles).map(path => isSSRPageComponent(path))\n  )\n  return result.some(isSSR => isSSR === true)\n}\n\nasync function isSSRPageComponent(filename: string): Promise<boolean> {\n  if (\n    !(await fs.pathExists(filename)) ||\n    !(await fs.lstat(filename)).isFile()\n  ) {\n    return false\n  }\n  const text = await fs.readFile(filename, `utf8`)\n  return text.includes(`getServerData`)\n}\n"],"mappings":";;;;;;;AAEA;;AAEA;;AACA;;AACA;;AACA;;AACA;;;;;;AARA;AAUO,eAAeA,SAAf,CAAyBC,OAAzB,EAAiE;EACtE,MAAM,CAACC,KAAD,IAAU,MAAMC,OAAO,CAACC,GAAR,CAAY,CAChCC,kBAAkB,CAACJ,OAAD,CADc,EAEhCK,kBAAkB,CAACL,OAAD,CAFc,CAAZ,CAAtB;EAIA,OAAOC,KAAP;AACD;;AAED,eAAeG,kBAAf,CAAkC;EAChCE;AADgC,CAAlC,EAEkC;EAChC,IAAI,CAACA,eAAL,EAAsB;IACpBC,iBAAA,CAASC,KAAT,CAAgB,kBAAhB;EACD;;EACD,OAAO,IAAIN,OAAJ,CAAmBO,OAAO,IAAI;IACnC,SAASC,MAAT,CAAgBT,KAAhB,EAAoC;MAClCU,cAAA,CAAQC,GAAR,CAAa,kBAAb,EAAgCF,MAAhC;;MACAD,OAAO,CAACR,KAAD,CAAP;IACD;;IACDU,cAAA,CAAQE,EAAR,CAAY,kBAAZ,EAA+BH,MAA/B;;IACAJ,eAAe,CAACQ,MAAhB,GANmC,CAOnC;;IACAR,eAAe,CAACS,OAAhB;EACD,CATM,CAAP;AAUD;;AAED,eAAeV,kBAAf,CAAkC;EAChCW,OADgC;EAEhCC,gBAFgC;EAGhCC,eAAe,GAAG,IAAIC,GAAJ;AAHc,CAAlC,EAIiC;EAC/B,IAAI,EAAE,MAAMC,oBAAoB,CAACF,eAAD,CAA5B,CAAJ,EAAoD;IAClD;EACD;;EACDX,iBAAA,CAASc,OAAT,CAAkB,wBAAlB;;EAEA,MAAM;IAAEC,KAAF;IAASC;EAAT,IAA0B,MAAM,IAAAC,wBAAA,EACpCR,OADoC,EAEpCS,YAAA,CAAMC,WAF8B,CAAtC;EAKA,IAAAC,+CAAA,EAA6BJ,YAA7B;;EAEA,IAAIN,gBAAJ,EAAsB;IACpBA,gBAAgB,CAACW,mBAAjB;EACD;;EAED,MAAMN,KAAK,EAAX;AACD;;AAED,eAAeF,oBAAf,CACEF,eADF,EAEoB;EAClB,MAAMW,MAAM,GAAG,MAAM3B,OAAO,CAACC,GAAR,CACnB2B,KAAK,CAACC,IAAN,CAAWb,eAAX,EAA4Bc,GAA5B,CAAgCC,IAAI,IAAIC,kBAAkB,CAACD,IAAD,CAA1D,CADmB,CAArB;EAGA,OAAOJ,MAAM,CAACM,IAAP,CAAYC,KAAK,IAAIA,KAAK,KAAK,IAA/B,CAAP;AACD;;AAED,eAAeF,kBAAf,CAAkCG,QAAlC,EAAsE;EACpE,IACE,EAAE,MAAMC,EAAE,CAACC,UAAH,CAAcF,QAAd,CAAR,KACA,CAAC,CAAC,MAAMC,EAAE,CAACE,KAAH,CAASH,QAAT,CAAP,EAA2BI,MAA3B,EAFH,EAGE;IACA,OAAO,KAAP;EACD;;EACD,MAAMC,IAAI,GAAG,MAAMJ,EAAE,CAACK,QAAH,CAAYN,QAAZ,EAAuB,MAAvB,CAAnB;EACA,OAAOK,IAAI,CAACE,QAAL,CAAe,eAAf,CAAP;AACD"}