{"version":3,"file":"calculate-dirty-queries.js","names":["calculateDirtyQueries","store","websocketManager","currentlyHandledPendingQueryRuns","assertStore","state","getState","queryIds","calcDirtyQueryIds","queriesToRun","process","env","gatsby_executing_command","GATSBY_EXPERIMENTAL_QUERY_ON_DEMAND","pagePathFilter","Set","activePaths","activePath","add","pendingQuery","filter","queryId","startsWith","has","groupQueryIds"],"sources":["../../src/services/calculate-dirty-queries.ts"],"sourcesContent":["import { calcDirtyQueryIds, groupQueryIds } from \"../query\"\nimport { IGroupedQueryIds } from \"./\"\nimport { IQueryRunningContext } from \"../state-machines/query-running/types\"\nimport { assertStore } from \"../utils/assert-store\"\n\nexport async function calculateDirtyQueries({\n  store,\n  websocketManager,\n  currentlyHandledPendingQueryRuns,\n}: Partial<IQueryRunningContext>): Promise<{\n  queryIds: IGroupedQueryIds\n}> {\n  assertStore(store)\n  const state = store.getState()\n  const queryIds: Array<string> = calcDirtyQueryIds(state)\n\n  let queriesToRun = queryIds\n\n  if (\n    process.env.gatsby_executing_command === `develop` &&\n    process.env.GATSBY_EXPERIMENTAL_QUERY_ON_DEMAND\n  ) {\n    // 404 are special cases in our runtime that ideally use\n    // generic things to work, but for now they have special handling\n    const pagePathFilter = new Set([`/404.html`, `/dev-404-page/`])\n\n    // we want to make sure we run queries for pages that user currently\n    // view in the browser\n    if (websocketManager?.activePaths) {\n      for (const activePath of websocketManager.activePaths) {\n        pagePathFilter.add(activePath)\n      }\n    }\n\n    // we also want to make sure we include pages that were requested from\n    // via `page-data` fetches or websocket requests\n    if (currentlyHandledPendingQueryRuns) {\n      for (const pendingQuery of currentlyHandledPendingQueryRuns) {\n        pagePathFilter.add(pendingQuery)\n      }\n    }\n\n    // static queries are also not on demand\n    queriesToRun = queryIds.filter(\n      queryId => queryId.startsWith(`sq--`) || pagePathFilter.has(queryId)\n    )\n  }\n\n  return {\n    queryIds: groupQueryIds(queriesToRun),\n  }\n}\n"],"mappings":";;;;;AAAA;;AAGA;;AAEO,eAAeA,qBAAf,CAAqC;EAC1CC,KAD0C;EAE1CC,gBAF0C;EAG1CC;AAH0C,CAArC,EAMJ;EACD,IAAAC,wBAAA,EAAYH,KAAZ;EACA,MAAMI,KAAK,GAAGJ,KAAK,CAACK,QAAN,EAAd;EACA,MAAMC,QAAuB,GAAG,IAAAC,wBAAA,EAAkBH,KAAlB,CAAhC;EAEA,IAAII,YAAY,GAAGF,QAAnB;;EAEA,IACEG,OAAO,CAACC,GAAR,CAAYC,wBAAZ,KAA0C,SAA1C,IACAF,OAAO,CAACC,GAAR,CAAYE,mCAFd,EAGE;IACA;IACA;IACA,MAAMC,cAAc,GAAG,IAAIC,GAAJ,CAAQ,CAAE,WAAF,EAAe,gBAAf,CAAR,CAAvB,CAHA,CAKA;IACA;;IACA,IAAIb,gBAAJ,aAAIA,gBAAJ,eAAIA,gBAAgB,CAAEc,WAAtB,EAAmC;MACjC,KAAK,MAAMC,UAAX,IAAyBf,gBAAgB,CAACc,WAA1C,EAAuD;QACrDF,cAAc,CAACI,GAAf,CAAmBD,UAAnB;MACD;IACF,CAXD,CAaA;IACA;;;IACA,IAAId,gCAAJ,EAAsC;MACpC,KAAK,MAAMgB,YAAX,IAA2BhB,gCAA3B,EAA6D;QAC3DW,cAAc,CAACI,GAAf,CAAmBC,YAAnB;MACD;IACF,CAnBD,CAqBA;;;IACAV,YAAY,GAAGF,QAAQ,CAACa,MAAT,CACbC,OAAO,IAAIA,OAAO,CAACC,UAAR,CAAoB,MAApB,KAA8BR,cAAc,CAACS,GAAf,CAAmBF,OAAnB,CAD5B,CAAf;EAGD;;EAED,OAAO;IACLd,QAAQ,EAAE,IAAAiB,oBAAA,EAAcf,YAAd;EADL,CAAP;AAGD"}