{"version":3,"file":"html.js","names":["FLAG_DIRTY_CLEARED_CACHE","FLAG_DIRTY_NEW_PAGE","FLAG_DIRTY_PAGE_DATA_CHANGED","FLAG_DIRTY_STATIC_QUERY_FIRST_RUN","FLAG_DIRTY_STATIC_QUERY_RESULT_CHANGED","FLAG_DIRTY_BROWSER_COMPILATION_HASH","FLAG_DIRTY_SSR_COMPILATION_HASH","initialState","trackedHtmlFiles","Map","browserCompilationHash","ssrCompilationHash","trackedStaticQueryResults","unsafeBuiltinWasUsedInSSR","htmlReducer","state","action","type","cacheIsCorrupt","clear","forEach","htmlFile","isDeleted","dirty","path","payload","get","pageDataHash","set","Error","isPage","staticQueryResult","queryHash","staticQueryResultHash","resultHash","pagePath","delete","pages","staticQueryHash","staticQueryHashes"],"sources":["../../../src/redux/reducers/html.ts"],"sourcesContent":["import {\n  ActionsUnion,\n  IGatsbyState,\n  IHtmlFileState,\n  IStaticQueryResultState,\n} from \"../types\"\n\nconst FLAG_DIRTY_CLEARED_CACHE = 0b0000001\nconst FLAG_DIRTY_NEW_PAGE = 0b0000010\nconst FLAG_DIRTY_PAGE_DATA_CHANGED = 0b0000100\nconst FLAG_DIRTY_STATIC_QUERY_FIRST_RUN = 0b0001000\nconst FLAG_DIRTY_STATIC_QUERY_RESULT_CHANGED = 0b0010000\nconst FLAG_DIRTY_BROWSER_COMPILATION_HASH = 0b0100000\nconst FLAG_DIRTY_SSR_COMPILATION_HASH = 0b1000000\n\ntype PagePath = string\n\nfunction initialState(): IGatsbyState[\"html\"] {\n  return {\n    trackedHtmlFiles: new Map<PagePath, IHtmlFileState>(),\n    browserCompilationHash: ``,\n    ssrCompilationHash: ``,\n    trackedStaticQueryResults: new Map<string, IStaticQueryResultState>(),\n    unsafeBuiltinWasUsedInSSR: false,\n  }\n}\n\nexport function htmlReducer(\n  state: IGatsbyState[\"html\"] = initialState(),\n  action: ActionsUnion\n): IGatsbyState[\"html\"] {\n  switch (action.type) {\n    case `DELETE_CACHE`: {\n      if (action.cacheIsCorrupt) {\n        // `public` doesn't exist so we can start fresh\n        return initialState()\n      } else {\n        // we can't just clear the cache here - we want to keep track of pages, so we mark them all as \"deleted\"\n        // if they are recreated \"isDeleted\" flag will be removed\n        state.browserCompilationHash = ``\n        state.ssrCompilationHash = ``\n        state.trackedStaticQueryResults.clear()\n        state.unsafeBuiltinWasUsedInSSR = false\n        state.trackedHtmlFiles.forEach(htmlFile => {\n          htmlFile.isDeleted = true\n          // there was a change somewhere, so just in case we mark those files are dirty as well\n          htmlFile.dirty |= FLAG_DIRTY_CLEARED_CACHE\n        })\n        return state\n      }\n    }\n\n    case `CREATE_PAGE`: {\n      // CREATE_PAGE can be called even if page already exist, so we only want to do anything\n      // if we don't track given page yet or if page is marked as deleted\n      const { path } = action.payload\n\n      let htmlFile = state.trackedHtmlFiles.get(path)\n      if (!htmlFile) {\n        htmlFile = {\n          dirty: FLAG_DIRTY_NEW_PAGE,\n          isDeleted: false,\n          pageDataHash: ``,\n        }\n        state.trackedHtmlFiles.set(path, htmlFile)\n      } else if (htmlFile.isDeleted) {\n        // page was recreated so we remove `isDeleted` flag\n        // TBD if dirtiness need to change\n        htmlFile.isDeleted = false\n      }\n\n      return state\n    }\n\n    case `DELETE_PAGE`: {\n      const { path } = action.payload\n      const htmlFile = state.trackedHtmlFiles.get(path)\n\n      if (!htmlFile) {\n        // invariant\n        throw new Error(\n          `[html reducer] how can I delete page that wasn't created (?)`\n        )\n      }\n\n      htmlFile.isDeleted = true\n      // TBD if dirtiness need to change\n      return state\n    }\n\n    case `PAGE_QUERY_RUN`: {\n      // Despite action name, this action is actually emitted for both page and static queries.\n      // In here we actually only care about static query result (particularly its hash).\n      // We don't care about page query result because we don't actually use page query result\n      // directly when generating html. We care about page-data (which contains page query result).\n      // Handling of page-data that transitively handles page query result is done in handler for\n      // `ADD_PAGE_DATA_STATS` action.\n      if (!action.payload.isPage) {\n        // static query case\n        let staticQueryResult = state.trackedStaticQueryResults.get(\n          action.payload.queryHash\n        )\n        if (!staticQueryResult) {\n          staticQueryResult = {\n            dirty: FLAG_DIRTY_STATIC_QUERY_FIRST_RUN,\n            staticQueryResultHash: action.payload.resultHash,\n          }\n          state.trackedStaticQueryResults.set(\n            action.payload.queryHash,\n            staticQueryResult\n          )\n        } else if (\n          staticQueryResult.staticQueryResultHash !== action.payload.resultHash\n        ) {\n          staticQueryResult.dirty |= FLAG_DIRTY_STATIC_QUERY_RESULT_CHANGED\n          staticQueryResult.staticQueryResultHash = action.payload.resultHash\n        }\n      }\n\n      return state\n    }\n    case `ADD_PAGE_DATA_STATS`: {\n      const htmlFile = state.trackedHtmlFiles.get(action.payload.pagePath)\n      if (!htmlFile) {\n        // invariant\n        throw new Error(\n          `[html reducer] I received event that query for a page finished running, but I'm not aware of the page it ran for (?)`\n        )\n      }\n\n      if (htmlFile.pageDataHash !== action.payload.pageDataHash) {\n        htmlFile.pageDataHash = action.payload.pageDataHash\n        htmlFile.dirty |= FLAG_DIRTY_PAGE_DATA_CHANGED\n      }\n      return state\n    }\n\n    case `SET_WEBPACK_COMPILATION_HASH`: {\n      if (state.browserCompilationHash !== action.payload) {\n        state.browserCompilationHash = action.payload\n        state.trackedHtmlFiles.forEach(htmlFile => {\n          htmlFile.dirty |= FLAG_DIRTY_BROWSER_COMPILATION_HASH\n        })\n      }\n      return state\n    }\n\n    case `SET_SSR_WEBPACK_COMPILATION_HASH`: {\n      if (state.ssrCompilationHash !== action.payload) {\n        state.ssrCompilationHash = action.payload\n        // we will mark every html file as dirty, so we can safely reset\n        // unsafeBuiltinWasUsedInSSR flag, which might be set again if\n        // ssr bundle continue to use those\n        state.unsafeBuiltinWasUsedInSSR = false\n        state.trackedHtmlFiles.forEach(htmlFile => {\n          htmlFile.dirty |= FLAG_DIRTY_SSR_COMPILATION_HASH\n        })\n      }\n      return state\n    }\n\n    case `HTML_REMOVED`: {\n      state.trackedHtmlFiles.delete(action.payload)\n      return state\n    }\n\n    case `HTML_TRACKED_PAGES_CLEANUP`: {\n      // this is to cleanup variants of page paths that don't result in artifacts deletion\n      // but page path should be pruned for cases like page changing path from \"/foo\" to \"/foo/\" (or vice versa)\n      // where produced artifacts filenames are the same and we don't want to delete them after building,\n      // but we still want to cleanup state here.\n      for (const path of action.payload) {\n        state.trackedHtmlFiles.delete(path)\n      }\n      return state\n    }\n\n    case `HTML_GENERATED`: {\n      for (const path of action.payload) {\n        const htmlFile = state.trackedHtmlFiles.get(path)\n        if (htmlFile) {\n          htmlFile.dirty = 0\n        }\n      }\n\n      return state\n    }\n\n    case `HTML_MARK_DIRTY_BECAUSE_STATIC_QUERY_RESULT_CHANGED`: {\n      // mark pages as dirty\n      for (const path of action.payload.pages) {\n        const htmlFile = state.trackedHtmlFiles.get(path)\n        if (htmlFile) {\n          htmlFile.dirty |= FLAG_DIRTY_STATIC_QUERY_RESULT_CHANGED\n        }\n      }\n\n      // mark static queries as not dirty anymore (we flushed their dirtiness into pages)\n      for (const staticQueryHash of action.payload.staticQueryHashes) {\n        const staticQueryResult =\n          state.trackedStaticQueryResults.get(staticQueryHash)\n        if (staticQueryResult) {\n          staticQueryResult.dirty = 0\n        }\n      }\n      return state\n    }\n\n    case `SSR_USED_UNSAFE_BUILTIN`: {\n      state.unsafeBuiltinWasUsedInSSR = true\n      return state\n    }\n  }\n  return state\n}\n"],"mappings":";;;;AAOA,MAAMA,wBAAwB,GAAG,SAAjC;AACA,MAAMC,mBAAmB,GAAG,SAA5B;AACA,MAAMC,4BAA4B,GAAG,SAArC;AACA,MAAMC,iCAAiC,GAAG,SAA1C;AACA,MAAMC,sCAAsC,GAAG,SAA/C;AACA,MAAMC,mCAAmC,GAAG,SAA5C;AACA,MAAMC,+BAA+B,GAAG,SAAxC;;AAIA,SAASC,YAAT,GAA8C;EAC5C,OAAO;IACLC,gBAAgB,EAAE,IAAIC,GAAJ,EADb;IAELC,sBAAsB,EAAG,EAFpB;IAGLC,kBAAkB,EAAG,EAHhB;IAILC,yBAAyB,EAAE,IAAIH,GAAJ,EAJtB;IAKLI,yBAAyB,EAAE;EALtB,CAAP;AAOD;;AAEM,SAASC,WAAT,CACLC,KAA2B,GAAGR,YAAY,EADrC,EAELS,MAFK,EAGiB;EACtB,QAAQA,MAAM,CAACC,IAAf;IACE,KAAM,cAAN;MAAqB;QACnB,IAAID,MAAM,CAACE,cAAX,EAA2B;UACzB;UACA,OAAOX,YAAY,EAAnB;QACD,CAHD,MAGO;UACL;UACA;UACAQ,KAAK,CAACL,sBAAN,GAAgC,EAAhC;UACAK,KAAK,CAACJ,kBAAN,GAA4B,EAA5B;UACAI,KAAK,CAACH,yBAAN,CAAgCO,KAAhC;UACAJ,KAAK,CAACF,yBAAN,GAAkC,KAAlC;UACAE,KAAK,CAACP,gBAAN,CAAuBY,OAAvB,CAA+BC,QAAQ,IAAI;YACzCA,QAAQ,CAACC,SAAT,GAAqB,IAArB,CADyC,CAEzC;;YACAD,QAAQ,CAACE,KAAT,IAAkBvB,wBAAlB;UACD,CAJD;UAKA,OAAOe,KAAP;QACD;MACF;;IAED,KAAM,aAAN;MAAoB;QAClB;QACA;QACA,MAAM;UAAES;QAAF,IAAWR,MAAM,CAACS,OAAxB;QAEA,IAAIJ,QAAQ,GAAGN,KAAK,CAACP,gBAAN,CAAuBkB,GAAvB,CAA2BF,IAA3B,CAAf;;QACA,IAAI,CAACH,QAAL,EAAe;UACbA,QAAQ,GAAG;YACTE,KAAK,EAAEtB,mBADE;YAETqB,SAAS,EAAE,KAFF;YAGTK,YAAY,EAAG;UAHN,CAAX;UAKAZ,KAAK,CAACP,gBAAN,CAAuBoB,GAAvB,CAA2BJ,IAA3B,EAAiCH,QAAjC;QACD,CAPD,MAOO,IAAIA,QAAQ,CAACC,SAAb,EAAwB;UAC7B;UACA;UACAD,QAAQ,CAACC,SAAT,GAAqB,KAArB;QACD;;QAED,OAAOP,KAAP;MACD;;IAED,KAAM,aAAN;MAAoB;QAClB,MAAM;UAAES;QAAF,IAAWR,MAAM,CAACS,OAAxB;QACA,MAAMJ,QAAQ,GAAGN,KAAK,CAACP,gBAAN,CAAuBkB,GAAvB,CAA2BF,IAA3B,CAAjB;;QAEA,IAAI,CAACH,QAAL,EAAe;UACb;UACA,MAAM,IAAIQ,KAAJ,CACH,8DADG,CAAN;QAGD;;QAEDR,QAAQ,CAACC,SAAT,GAAqB,IAArB,CAXkB,CAYlB;;QACA,OAAOP,KAAP;MACD;;IAED,KAAM,gBAAN;MAAuB;QACrB;QACA;QACA;QACA;QACA;QACA;QACA,IAAI,CAACC,MAAM,CAACS,OAAP,CAAeK,MAApB,EAA4B;UAC1B;UACA,IAAIC,iBAAiB,GAAGhB,KAAK,CAACH,yBAAN,CAAgCc,GAAhC,CACtBV,MAAM,CAACS,OAAP,CAAeO,SADO,CAAxB;;UAGA,IAAI,CAACD,iBAAL,EAAwB;YACtBA,iBAAiB,GAAG;cAClBR,KAAK,EAAEpB,iCADW;cAElB8B,qBAAqB,EAAEjB,MAAM,CAACS,OAAP,CAAeS;YAFpB,CAApB;YAIAnB,KAAK,CAACH,yBAAN,CAAgCgB,GAAhC,CACEZ,MAAM,CAACS,OAAP,CAAeO,SADjB,EAEED,iBAFF;UAID,CATD,MASO,IACLA,iBAAiB,CAACE,qBAAlB,KAA4CjB,MAAM,CAACS,OAAP,CAAeS,UADtD,EAEL;YACAH,iBAAiB,CAACR,KAAlB,IAA2BnB,sCAA3B;YACA2B,iBAAiB,CAACE,qBAAlB,GAA0CjB,MAAM,CAACS,OAAP,CAAeS,UAAzD;UACD;QACF;;QAED,OAAOnB,KAAP;MACD;;IACD,KAAM,qBAAN;MAA4B;QAC1B,MAAMM,QAAQ,GAAGN,KAAK,CAACP,gBAAN,CAAuBkB,GAAvB,CAA2BV,MAAM,CAACS,OAAP,CAAeU,QAA1C,CAAjB;;QACA,IAAI,CAACd,QAAL,EAAe;UACb;UACA,MAAM,IAAIQ,KAAJ,CACH,sHADG,CAAN;QAGD;;QAED,IAAIR,QAAQ,CAACM,YAAT,KAA0BX,MAAM,CAACS,OAAP,CAAeE,YAA7C,EAA2D;UACzDN,QAAQ,CAACM,YAAT,GAAwBX,MAAM,CAACS,OAAP,CAAeE,YAAvC;UACAN,QAAQ,CAACE,KAAT,IAAkBrB,4BAAlB;QACD;;QACD,OAAOa,KAAP;MACD;;IAED,KAAM,8BAAN;MAAqC;QACnC,IAAIA,KAAK,CAACL,sBAAN,KAAiCM,MAAM,CAACS,OAA5C,EAAqD;UACnDV,KAAK,CAACL,sBAAN,GAA+BM,MAAM,CAACS,OAAtC;UACAV,KAAK,CAACP,gBAAN,CAAuBY,OAAvB,CAA+BC,QAAQ,IAAI;YACzCA,QAAQ,CAACE,KAAT,IAAkBlB,mCAAlB;UACD,CAFD;QAGD;;QACD,OAAOU,KAAP;MACD;;IAED,KAAM,kCAAN;MAAyC;QACvC,IAAIA,KAAK,CAACJ,kBAAN,KAA6BK,MAAM,CAACS,OAAxC,EAAiD;UAC/CV,KAAK,CAACJ,kBAAN,GAA2BK,MAAM,CAACS,OAAlC,CAD+C,CAE/C;UACA;UACA;;UACAV,KAAK,CAACF,yBAAN,GAAkC,KAAlC;UACAE,KAAK,CAACP,gBAAN,CAAuBY,OAAvB,CAA+BC,QAAQ,IAAI;YACzCA,QAAQ,CAACE,KAAT,IAAkBjB,+BAAlB;UACD,CAFD;QAGD;;QACD,OAAOS,KAAP;MACD;;IAED,KAAM,cAAN;MAAqB;QACnBA,KAAK,CAACP,gBAAN,CAAuB4B,MAAvB,CAA8BpB,MAAM,CAACS,OAArC;QACA,OAAOV,KAAP;MACD;;IAED,KAAM,4BAAN;MAAmC;QACjC;QACA;QACA;QACA;QACA,KAAK,MAAMS,IAAX,IAAmBR,MAAM,CAACS,OAA1B,EAAmC;UACjCV,KAAK,CAACP,gBAAN,CAAuB4B,MAAvB,CAA8BZ,IAA9B;QACD;;QACD,OAAOT,KAAP;MACD;;IAED,KAAM,gBAAN;MAAuB;QACrB,KAAK,MAAMS,IAAX,IAAmBR,MAAM,CAACS,OAA1B,EAAmC;UACjC,MAAMJ,QAAQ,GAAGN,KAAK,CAACP,gBAAN,CAAuBkB,GAAvB,CAA2BF,IAA3B,CAAjB;;UACA,IAAIH,QAAJ,EAAc;YACZA,QAAQ,CAACE,KAAT,GAAiB,CAAjB;UACD;QACF;;QAED,OAAOR,KAAP;MACD;;IAED,KAAM,qDAAN;MAA4D;QAC1D;QACA,KAAK,MAAMS,IAAX,IAAmBR,MAAM,CAACS,OAAP,CAAeY,KAAlC,EAAyC;UACvC,MAAMhB,QAAQ,GAAGN,KAAK,CAACP,gBAAN,CAAuBkB,GAAvB,CAA2BF,IAA3B,CAAjB;;UACA,IAAIH,QAAJ,EAAc;YACZA,QAAQ,CAACE,KAAT,IAAkBnB,sCAAlB;UACD;QACF,CAPyD,CAS1D;;;QACA,KAAK,MAAMkC,eAAX,IAA8BtB,MAAM,CAACS,OAAP,CAAec,iBAA7C,EAAgE;UAC9D,MAAMR,iBAAiB,GACrBhB,KAAK,CAACH,yBAAN,CAAgCc,GAAhC,CAAoCY,eAApC,CADF;;UAEA,IAAIP,iBAAJ,EAAuB;YACrBA,iBAAiB,CAACR,KAAlB,GAA0B,CAA1B;UACD;QACF;;QACD,OAAOR,KAAP;MACD;;IAED,KAAM,yBAAN;MAAgC;QAC9BA,KAAK,CAACF,yBAAN,GAAkC,IAAlC;QACA,OAAOE,KAAP;MACD;EApLH;;EAsLA,OAAOA,KAAP;AACD"}