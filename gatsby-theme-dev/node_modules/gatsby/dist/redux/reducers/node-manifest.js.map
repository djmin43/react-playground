{"version":3,"file":"node-manifest.js","names":["ONE_DAY","DEFAULT_MAX_DAYS_OLD","nodeManifestReducer","state","action","type","manifestId","pluginName","node","updatedAtUTC","payload","maxDaysOld","Number","process","env","NODE_MANIFEST_MAX_DAYS_OLD","nodeLastUpdatedAtUTC","Date","getTime","isNaN","reporter","warn","shouldCreateNodeManifest","now","id","push"],"sources":["../../../src/redux/reducers/node-manifest.ts"],"sourcesContent":["import reporter from \"gatsby-cli/lib/reporter\"\n\nimport {\n  IGatsbyState,\n  ICreateNodeManifest,\n  IDeleteNodeManifests,\n} from \"../types\"\n\nconst ONE_DAY = 1000 * 60 * 60 * 24 // ms * sec * min * hr.\nconst DEFAULT_MAX_DAYS_OLD = 30\n\nexport const nodeManifestReducer = (\n  state: IGatsbyState[\"nodeManifests\"] = [],\n  action: ICreateNodeManifest | IDeleteNodeManifests\n): IGatsbyState[\"nodeManifests\"] => {\n  switch (action.type) {\n    case `CREATE_NODE_MANIFEST`: {\n      const { manifestId, pluginName, node, updatedAtUTC } = action.payload\n\n      const maxDaysOld =\n        Number(process.env.NODE_MANIFEST_MAX_DAYS_OLD) || DEFAULT_MAX_DAYS_OLD\n\n      if (updatedAtUTC) {\n        const nodeLastUpdatedAtUTC: number = new Date(updatedAtUTC).getTime()\n        if (\n          (nodeLastUpdatedAtUTC as any) instanceof Date &&\n          !isNaN(nodeLastUpdatedAtUTC)\n        ) {\n          reporter.warn(\n            `Plugin ${pluginName} called unstable_createNodeManifest with an updatedAtUTC that isn't a proper value to instantiate a Date.`\n          )\n\n          return state\n        }\n\n        const shouldCreateNodeManifest =\n          Date.now() - nodeLastUpdatedAtUTC <= maxDaysOld * ONE_DAY\n\n        if (!shouldCreateNodeManifest) {\n          return state\n        }\n      }\n\n      if (typeof manifestId !== `string`) {\n        reporter.warn(\n          `Plugin ${pluginName} called unstable_createNodeManifest with a manifestId that isn't a string.`\n        )\n\n        return state\n      }\n\n      if (!node?.id) {\n        reporter.warn(\n          `Plugin ${pluginName} called unstable_createNodeManifest but didn't provide a node.`\n        )\n\n        return state\n      }\n\n      state.push({\n        manifestId,\n        pluginName,\n        node: {\n          id: node.id,\n        },\n      })\n\n      return state\n    }\n\n    case `DELETE_NODE_MANIFESTS`: {\n      state = []\n\n      return state\n    }\n\n    default:\n      return state\n  }\n}\n"],"mappings":";;;;;;;AAAA;;AAQA,MAAMA,OAAO,GAAG,OAAO,EAAP,GAAY,EAAZ,GAAiB,EAAjC,C,CAAoC;;AACpC,MAAMC,oBAAoB,GAAG,EAA7B;;AAEO,MAAMC,mBAAmB,GAAG,CACjCC,KAAoC,GAAG,EADN,EAEjCC,MAFiC,KAGC;EAClC,QAAQA,MAAM,CAACC,IAAf;IACE,KAAM,sBAAN;MAA6B;QAC3B,MAAM;UAAEC,UAAF;UAAcC,UAAd;UAA0BC,IAA1B;UAAgCC;QAAhC,IAAiDL,MAAM,CAACM,OAA9D;QAEA,MAAMC,UAAU,GACdC,MAAM,CAACC,OAAO,CAACC,GAAR,CAAYC,0BAAb,CAAN,IAAkDd,oBADpD;;QAGA,IAAIQ,YAAJ,EAAkB;UAChB,MAAMO,oBAA4B,GAAG,IAAIC,IAAJ,CAASR,YAAT,EAAuBS,OAAvB,EAArC;;UACA,IACGF,oBAAD,YAAyCC,IAAzC,IACA,CAACE,KAAK,CAACH,oBAAD,CAFR,EAGE;YACAI,iBAAA,CAASC,IAAT,CACG,UAASd,UAAW,2GADvB;;YAIA,OAAOJ,KAAP;UACD;;UAED,MAAMmB,wBAAwB,GAC5BL,IAAI,CAACM,GAAL,KAAaP,oBAAb,IAAqCL,UAAU,GAAGX,OADpD;;UAGA,IAAI,CAACsB,wBAAL,EAA+B;YAC7B,OAAOnB,KAAP;UACD;QACF;;QAED,IAAI,OAAOG,UAAP,KAAuB,QAA3B,EAAoC;UAClCc,iBAAA,CAASC,IAAT,CACG,UAASd,UAAW,4EADvB;;UAIA,OAAOJ,KAAP;QACD;;QAED,IAAI,EAACK,IAAD,aAACA,IAAD,eAACA,IAAI,CAAEgB,EAAP,CAAJ,EAAe;UACbJ,iBAAA,CAASC,IAAT,CACG,UAASd,UAAW,gEADvB;;UAIA,OAAOJ,KAAP;QACD;;QAEDA,KAAK,CAACsB,IAAN,CAAW;UACTnB,UADS;UAETC,UAFS;UAGTC,IAAI,EAAE;YACJgB,EAAE,EAAEhB,IAAI,CAACgB;UADL;QAHG,CAAX;QAQA,OAAOrB,KAAP;MACD;;IAED,KAAM,uBAAN;MAA8B;QAC5BA,KAAK,GAAG,EAAR;QAEA,OAAOA,KAAP;MACD;;IAED;MACE,OAAOA,KAAP;EA9DJ;AAgED,CApEM"}