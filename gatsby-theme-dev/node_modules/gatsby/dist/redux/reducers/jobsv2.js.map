{"version":3,"file":"jobsv2.js","names":["initialState","incomplete","Map","complete","jobsByRequest","jobsV2Reducer","state","action","type","cleanState","cleanStateKeys","Object","keys","isOutdatedJobsState","length","some","key","prototype","hasOwnProperty","call","cacheIsCorrupt","job","payload","set","contentDigest","jobContentDigest","result","get","Error","delete","inputPaths","requestId","jobs","Set","add"],"sources":["../../../src/redux/reducers/jobsv2.ts"],"sourcesContent":["import {\n  ICreateJobV2Action,\n  IRemoveStaleJobV2Action,\n  IEndJobV2Action,\n  IGatsbyState,\n  IGatsbyIncompleteJobV2,\n  IGatsbyCompleteJobV2,\n  IDeleteCacheAction,\n  ISetJobV2Context,\n  IClearJobV2Context,\n} from \"../types\"\n\nconst initialState = (): IGatsbyState[\"jobsV2\"] => {\n  return {\n    incomplete: new Map(),\n    complete: new Map(),\n    jobsByRequest: new Map(),\n  }\n}\n\nexport const jobsV2Reducer = (\n  state = initialState(),\n  action:\n    | ICreateJobV2Action\n    | IRemoveStaleJobV2Action\n    | IEndJobV2Action\n    | ISetJobV2Context\n    | IClearJobV2Context\n    | IDeleteCacheAction\n): IGatsbyState[\"jobsV2\"] => {\n  switch (action.type) {\n    case `DELETE_CACHE`: {\n      // Wipe the cache if state shape doesn't match the initial shape\n      // It is possible when the old cache is loaded for the new version of this reducer\n      const cleanState = initialState()\n      const cleanStateKeys = Object.keys(cleanState)\n\n      const isOutdatedJobsState =\n        cleanStateKeys.length !== Object.keys(state).length ||\n        cleanStateKeys.some(\n          key => !Object.prototype.hasOwnProperty.call(state, key)\n        )\n\n      return action.cacheIsCorrupt || isOutdatedJobsState ? cleanState : state\n    }\n\n    case `CREATE_JOB_V2`: {\n      const { job } = action.payload\n\n      state.incomplete.set(job.contentDigest, {\n        job,\n      } as IGatsbyIncompleteJobV2)\n\n      return state\n    }\n\n    case `END_JOB_V2`: {\n      const { jobContentDigest, result } = action.payload\n      const { job } = state.incomplete.get(\n        jobContentDigest\n      ) as IGatsbyIncompleteJobV2\n\n      if (!job) {\n        throw new Error(\n          `If you encounter this error, it's probably a Gatsby internal bug. Please open an issue reporting us this.`\n        )\n      }\n\n      state.incomplete.delete(job.contentDigest)\n\n      // inputPaths is used to make sure the job is not stale\n      state.complete.set(job.contentDigest, {\n        result,\n        inputPaths: job.inputPaths,\n      } as IGatsbyCompleteJobV2)\n\n      return state\n    }\n\n    case `REMOVE_STALE_JOB_V2`: {\n      const { contentDigest } = action.payload\n      state.incomplete.delete(contentDigest)\n      state.complete.delete(contentDigest)\n\n      return state\n    }\n\n    case `SET_JOB_V2_CONTEXT`: {\n      const { requestId, job } = action.payload\n\n      let jobs = state.jobsByRequest.get(requestId)\n      if (!jobs) {\n        jobs = new Set<string>()\n        state.jobsByRequest.set(requestId, jobs)\n      }\n      jobs.add(job.contentDigest)\n\n      return state\n    }\n\n    case `CLEAR_JOB_V2_CONTEXT`: {\n      const { requestId } = action.payload\n      state.jobsByRequest.delete(requestId)\n    }\n  }\n\n  return state\n}\n"],"mappings":";;;;;AAYA,MAAMA,YAAY,GAAG,MAA8B;EACjD,OAAO;IACLC,UAAU,EAAE,IAAIC,GAAJ,EADP;IAELC,QAAQ,EAAE,IAAID,GAAJ,EAFL;IAGLE,aAAa,EAAE,IAAIF,GAAJ;EAHV,CAAP;AAKD,CAND;;AAQO,MAAMG,aAAa,GAAG,CAC3BC,KAAK,GAAGN,YAAY,EADO,EAE3BO,MAF2B,KASA;EAC3B,QAAQA,MAAM,CAACC,IAAf;IACE,KAAM,cAAN;MAAqB;QACnB;QACA;QACA,MAAMC,UAAU,GAAGT,YAAY,EAA/B;QACA,MAAMU,cAAc,GAAGC,MAAM,CAACC,IAAP,CAAYH,UAAZ,CAAvB;QAEA,MAAMI,mBAAmB,GACvBH,cAAc,CAACI,MAAf,KAA0BH,MAAM,CAACC,IAAP,CAAYN,KAAZ,EAAmBQ,MAA7C,IACAJ,cAAc,CAACK,IAAf,CACEC,GAAG,IAAI,CAACL,MAAM,CAACM,SAAP,CAAiBC,cAAjB,CAAgCC,IAAhC,CAAqCb,KAArC,EAA4CU,GAA5C,CADV,CAFF;QAMA,OAAOT,MAAM,CAACa,cAAP,IAAyBP,mBAAzB,GAA+CJ,UAA/C,GAA4DH,KAAnE;MACD;;IAED,KAAM,eAAN;MAAsB;QACpB,MAAM;UAAEe;QAAF,IAAUd,MAAM,CAACe,OAAvB;QAEAhB,KAAK,CAACL,UAAN,CAAiBsB,GAAjB,CAAqBF,GAAG,CAACG,aAAzB,EAAwC;UACtCH;QADsC,CAAxC;QAIA,OAAOf,KAAP;MACD;;IAED,KAAM,YAAN;MAAmB;QACjB,MAAM;UAAEmB,gBAAF;UAAoBC;QAApB,IAA+BnB,MAAM,CAACe,OAA5C;QACA,MAAM;UAAED;QAAF,IAAUf,KAAK,CAACL,UAAN,CAAiB0B,GAAjB,CACdF,gBADc,CAAhB;;QAIA,IAAI,CAACJ,GAAL,EAAU;UACR,MAAM,IAAIO,KAAJ,CACH,2GADG,CAAN;QAGD;;QAEDtB,KAAK,CAACL,UAAN,CAAiB4B,MAAjB,CAAwBR,GAAG,CAACG,aAA5B,EAZiB,CAcjB;;QACAlB,KAAK,CAACH,QAAN,CAAeoB,GAAf,CAAmBF,GAAG,CAACG,aAAvB,EAAsC;UACpCE,MADoC;UAEpCI,UAAU,EAAET,GAAG,CAACS;QAFoB,CAAtC;QAKA,OAAOxB,KAAP;MACD;;IAED,KAAM,qBAAN;MAA4B;QAC1B,MAAM;UAAEkB;QAAF,IAAoBjB,MAAM,CAACe,OAAjC;QACAhB,KAAK,CAACL,UAAN,CAAiB4B,MAAjB,CAAwBL,aAAxB;QACAlB,KAAK,CAACH,QAAN,CAAe0B,MAAf,CAAsBL,aAAtB;QAEA,OAAOlB,KAAP;MACD;;IAED,KAAM,oBAAN;MAA2B;QACzB,MAAM;UAAEyB,SAAF;UAAaV;QAAb,IAAqBd,MAAM,CAACe,OAAlC;QAEA,IAAIU,IAAI,GAAG1B,KAAK,CAACF,aAAN,CAAoBuB,GAApB,CAAwBI,SAAxB,CAAX;;QACA,IAAI,CAACC,IAAL,EAAW;UACTA,IAAI,GAAG,IAAIC,GAAJ,EAAP;UACA3B,KAAK,CAACF,aAAN,CAAoBmB,GAApB,CAAwBQ,SAAxB,EAAmCC,IAAnC;QACD;;QACDA,IAAI,CAACE,GAAL,CAASb,GAAG,CAACG,aAAb;QAEA,OAAOlB,KAAP;MACD;;IAED,KAAM,sBAAN;MAA6B;QAC3B,MAAM;UAAEyB;QAAF,IAAgBxB,MAAM,CAACe,OAA7B;QACAhB,KAAK,CAACF,aAAN,CAAoByB,MAApB,CAA2BE,SAA3B;MACD;EAzEH;;EA4EA,OAAOzB,KAAP;AACD,CAvFM"}