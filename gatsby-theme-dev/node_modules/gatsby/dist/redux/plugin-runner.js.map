{"version":3,"file":"plugin-runner.js","names":["startPluginRunner","plugins","store","getState","flattenedPlugins","pluginsImplementingOnCreatePage","filter","plugin","nodeAPIs","includes","pluginsImplementingOnCreateNode","length","emitter","on","action","page","payload","apiRunnerNode","traceId","parentSpan","pluginSource","name","activity","node","internal","type","traceTags","nodeId","id","nodeType"],"sources":["../../src/redux/plugin-runner.ts"],"sourcesContent":["import { Span } from \"opentracing\"\nimport { emitter, store } from \"./index\"\nimport apiRunnerNode from \"../utils/api-runner-node\"\nimport { ActivityTracker } from \"../../\"\nimport { ICreateNodeAction } from \"./types\"\n\ntype Plugin = any // TODO\n\n// This might make sense to live somewhere else\ninterface ICreatePageAction {\n  graphql<TData, TVariables = any>(\n    query: string,\n    variables?: TVariables\n  ): Promise<{\n    errors?: any\n    data?: TData\n  }>\n  traceId: \"initial-createPages\"\n  waitForCascadingActions: boolean\n  parentSpan: Span\n  activity: ActivityTracker\n  type: `CREATE_PAGE`\n  contextModified: boolean\n  plugin: Plugin\n  payload: {\n    internalComponentName: string\n    path: string\n    matchPath: string | undefined\n    component: string\n    componentChunkName: string\n    isCreatedByStatefulCreatePages: boolean\n    context: {\n      slug: string\n      id: string\n    }\n    updatedAt: number\n    // eslint-disable-next-line @typescript-eslint/naming-convention\n    pluginCreator___NODE: string\n    pluginCreatorId: string\n    componentPath: string\n  }\n}\n\nexport const startPluginRunner = (): void => {\n  const plugins = store.getState().flattenedPlugins\n  const pluginsImplementingOnCreatePage = plugins.filter(plugin =>\n    plugin.nodeAPIs.includes(`onCreatePage`)\n  )\n  const pluginsImplementingOnCreateNode = plugins.filter(plugin =>\n    plugin.nodeAPIs.includes(`onCreateNode`)\n  )\n  if (pluginsImplementingOnCreatePage.length > 0) {\n    emitter.on(`CREATE_PAGE`, (action: ICreatePageAction) => {\n      const page = action.payload\n      apiRunnerNode(\n        `onCreatePage`,\n        { page, traceId: action.traceId, parentSpan: action.parentSpan },\n        { pluginSource: action.plugin.name, activity: action.activity }\n      )\n    })\n  }\n\n  // We make page nodes outside of the normal action for speed so we manually\n  // call onCreateNode here for SitePage nodes.\n  if (pluginsImplementingOnCreateNode.length > 0) {\n    emitter.on(`CREATE_NODE`, (action: ICreateNodeAction) => {\n      const node = action.payload\n      if (node.internal.type === `SitePage`) {\n        apiRunnerNode(`onCreateNode`, {\n          node,\n          parentSpan: action.parentSpan,\n          traceTags: { nodeId: node.id, nodeType: node.internal.type },\n        })\n      }\n    })\n  }\n}\n"],"mappings":";;;;;;;AACA;;AACA;;AAyCO,MAAMA,iBAAiB,GAAG,MAAY;EAC3C,MAAMC,OAAO,GAAGC,YAAA,CAAMC,QAAN,GAAiBC,gBAAjC;;EACA,MAAMC,+BAA+B,GAAGJ,OAAO,CAACK,MAAR,CAAeC,MAAM,IAC3DA,MAAM,CAACC,QAAP,CAAgBC,QAAhB,CAA0B,cAA1B,CADsC,CAAxC;EAGA,MAAMC,+BAA+B,GAAGT,OAAO,CAACK,MAAR,CAAeC,MAAM,IAC3DA,MAAM,CAACC,QAAP,CAAgBC,QAAhB,CAA0B,cAA1B,CADsC,CAAxC;;EAGA,IAAIJ,+BAA+B,CAACM,MAAhC,GAAyC,CAA7C,EAAgD;IAC9CC,cAAA,CAAQC,EAAR,CAAY,aAAZ,EAA2BC,MAAD,IAA+B;MACvD,MAAMC,IAAI,GAAGD,MAAM,CAACE,OAApB;MACA,IAAAC,sBAAA,EACG,cADH,EAEE;QAAEF,IAAF;QAAQG,OAAO,EAAEJ,MAAM,CAACI,OAAxB;QAAiCC,UAAU,EAAEL,MAAM,CAACK;MAApD,CAFF,EAGE;QAAEC,YAAY,EAAEN,MAAM,CAACP,MAAP,CAAcc,IAA9B;QAAoCC,QAAQ,EAAER,MAAM,CAACQ;MAArD,CAHF;IAKD,CAPD;EAQD,CAjB0C,CAmB3C;EACA;;;EACA,IAAIZ,+BAA+B,CAACC,MAAhC,GAAyC,CAA7C,EAAgD;IAC9CC,cAAA,CAAQC,EAAR,CAAY,aAAZ,EAA2BC,MAAD,IAA+B;MACvD,MAAMS,IAAI,GAAGT,MAAM,CAACE,OAApB;;MACA,IAAIO,IAAI,CAACC,QAAL,CAAcC,IAAd,KAAwB,UAA5B,EAAuC;QACrC,IAAAR,sBAAA,EAAe,cAAf,EAA8B;UAC5BM,IAD4B;UAE5BJ,UAAU,EAAEL,MAAM,CAACK,UAFS;UAG5BO,SAAS,EAAE;YAAEC,MAAM,EAAEJ,IAAI,CAACK,EAAf;YAAmBC,QAAQ,EAAEN,IAAI,CAACC,QAAL,CAAcC;UAA3C;QAHiB,CAA9B;MAKD;IACF,CATD;EAUD;AACF,CAjCM"}