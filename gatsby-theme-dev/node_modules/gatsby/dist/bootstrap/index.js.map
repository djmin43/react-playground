{"version":3,"file":"index.js","names":["tracer","globalTracer","bootstrap","initialContext","spanArgs","parentSpan","childOf","startSpan","bootstrapContext","shouldRunCreatePagesStatefully","context","initialize","workerPool","process","env","GATSBY_EXPERIMENTAL_PARALLEL_QUERY_RUNNING","program","store","getState","directory","slash","all","loadConfigAndPlugins","siteDirectory","customizeSchema","sourceNodes","buildSchema","gatsbyNodeGraphQLFunction","createGraphQLRunner","reporter","createPages","handleStalePageData","savePartialStateToDisk","extractQueries","writeOutRedirects","startRedirectListener","postBootstrap","finish"],"sources":["../../src/bootstrap/index.ts"],"sourcesContent":["import reporter from \"gatsby-cli/lib/reporter\"\nimport { slash } from \"gatsby-core-utils\"\nimport { startRedirectListener } from \"./redirects-writer\"\nimport {\n  IBuildContext,\n  initialize,\n  customizeSchema,\n  sourceNodes,\n  buildSchema,\n  createPages,\n  extractQueries,\n  writeOutRedirects,\n  postBootstrap,\n} from \"../services\"\nimport { Runner, createGraphQLRunner } from \"./create-graphql-runner\"\nimport { globalTracer } from \"opentracing\"\nimport type { GatsbyWorkerPool } from \"../utils/worker/pool\"\nimport { handleStalePageData } from \"../utils/page-data\"\nimport { savePartialStateToDisk } from \"../redux\"\nimport { IProgram } from \"../commands/types\"\n\nconst tracer = globalTracer()\n\nexport async function bootstrap(\n  initialContext: Partial<IBuildContext> & { program: IProgram }\n): Promise<{\n  gatsbyNodeGraphQLFunction: Runner\n  workerPool: GatsbyWorkerPool\n}> {\n  const spanArgs = initialContext.parentSpan\n    ? { childOf: initialContext.parentSpan }\n    : {}\n\n  const parentSpan = tracer.startSpan(`bootstrap`, spanArgs)\n\n  const bootstrapContext: IBuildContext & {\n    shouldRunCreatePagesStatefully: boolean\n  } = {\n    ...initialContext,\n    parentSpan,\n    shouldRunCreatePagesStatefully: true,\n  }\n\n  const context = {\n    ...bootstrapContext,\n    ...(await initialize(bootstrapContext)),\n  }\n\n  const workerPool = context.workerPool\n\n  if (process.env.GATSBY_EXPERIMENTAL_PARALLEL_QUERY_RUNNING) {\n    const program = context.store.getState().program\n    const directory = slash(program.directory)\n\n    workerPool.all.loadConfigAndPlugins({ siteDirectory: directory, program })\n  }\n\n  await customizeSchema(context)\n  await sourceNodes(context)\n\n  await buildSchema(context)\n\n  context.gatsbyNodeGraphQLFunction = createGraphQLRunner(\n    context.store,\n    reporter\n  )\n\n  await createPages(context)\n\n  await handleStalePageData(parentSpan)\n\n  if (process.env.GATSBY_EXPERIMENTAL_PARALLEL_QUERY_RUNNING) {\n    savePartialStateToDisk([`inferenceMetadata`])\n\n    workerPool.all.buildSchema()\n  }\n\n  await extractQueries(context)\n\n  if (process.env.GATSBY_EXPERIMENTAL_PARALLEL_QUERY_RUNNING) {\n    savePartialStateToDisk([`components`, `staticQueryComponents`])\n  }\n\n  await writeOutRedirects(context)\n\n  startRedirectListener()\n\n  await postBootstrap(context)\n\n  parentSpan.finish()\n\n  return {\n    gatsbyNodeGraphQLFunction: context.gatsbyNodeGraphQLFunction,\n    workerPool,\n  }\n}\n"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;AACA;;AAWA;;AACA;;AAEA;;AACA;;AAGA,MAAMA,MAAM,GAAG,IAAAC,yBAAA,GAAf;;AAEO,eAAeC,SAAf,CACLC,cADK,EAKJ;EACD,MAAMC,QAAQ,GAAGD,cAAc,CAACE,UAAf,GACb;IAAEC,OAAO,EAAEH,cAAc,CAACE;EAA1B,CADa,GAEb,EAFJ;EAIA,MAAMA,UAAU,GAAGL,MAAM,CAACO,SAAP,CAAkB,WAAlB,EAA8BH,QAA9B,CAAnB;EAEA,MAAMI,gBAEL,GAAG,EACF,GAAGL,cADD;IAEFE,UAFE;IAGFI,8BAA8B,EAAE;EAH9B,CAFJ;EAQA,MAAMC,OAAO,GAAG,EACd,GAAGF,gBADW;IAEd,IAAI,MAAM,IAAAG,oBAAA,EAAWH,gBAAX,CAAV;EAFc,CAAhB;EAKA,MAAMI,UAAU,GAAGF,OAAO,CAACE,UAA3B;;EAEA,IAAIC,OAAO,CAACC,GAAR,CAAYC,0CAAhB,EAA4D;IAC1D,MAAMC,OAAO,GAAGN,OAAO,CAACO,KAAR,CAAcC,QAAd,GAAyBF,OAAzC;IACA,MAAMG,SAAS,GAAG,IAAAC,sBAAA,EAAMJ,OAAO,CAACG,SAAd,CAAlB;IAEAP,UAAU,CAACS,GAAX,CAAeC,oBAAf,CAAoC;MAAEC,aAAa,EAAEJ,SAAjB;MAA4BH;IAA5B,CAApC;EACD;;EAED,MAAM,IAAAQ,yBAAA,EAAgBd,OAAhB,CAAN;EACA,MAAM,IAAAe,qBAAA,EAAYf,OAAZ,CAAN;EAEA,MAAM,IAAAgB,qBAAA,EAAYhB,OAAZ,CAAN;EAEAA,OAAO,CAACiB,yBAAR,GAAoC,IAAAC,wCAAA,EAClClB,OAAO,CAACO,KAD0B,EAElCY,iBAFkC,CAApC;EAKA,MAAM,IAAAC,qBAAA,EAAYpB,OAAZ,CAAN;EAEA,MAAM,IAAAqB,6BAAA,EAAoB1B,UAApB,CAAN;;EAEA,IAAIQ,OAAO,CAACC,GAAR,CAAYC,0CAAhB,EAA4D;IAC1D,IAAAiB,6BAAA,EAAuB,CAAE,mBAAF,CAAvB;IAEApB,UAAU,CAACS,GAAX,CAAeK,WAAf;EACD;;EAED,MAAM,IAAAO,wBAAA,EAAevB,OAAf,CAAN;;EAEA,IAAIG,OAAO,CAACC,GAAR,CAAYC,0CAAhB,EAA4D;IAC1D,IAAAiB,6BAAA,EAAuB,CAAE,YAAF,EAAgB,uBAAhB,CAAvB;EACD;;EAED,MAAM,IAAAE,2BAAA,EAAkBxB,OAAlB,CAAN;EAEA,IAAAyB,sCAAA;EAEA,MAAM,IAAAC,uBAAA,EAAc1B,OAAd,CAAN;EAEAL,UAAU,CAACgC,MAAX;EAEA,OAAO;IACLV,yBAAyB,EAAEjB,OAAO,CAACiB,yBAD9B;IAELf;EAFK,CAAP;AAID"}