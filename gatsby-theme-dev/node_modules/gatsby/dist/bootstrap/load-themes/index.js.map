{"version":3,"file":"index.js","names":["createRequireFromPath","require","path","Promise","_","debug","reporter","resolveTheme","themeSpec","configFileThatDeclaredTheme","isMainConfig","rootDir","themeName","resolve","themeDir","scopedRequire","dirname","e","pathToLocalTheme","join","resolvePlugin","localErr","panic","nodeResolutionPaths","module","paths","map","p","id","context","configFilePath","configModule","getConfigFile","theme","preferDefault","themeConfig","isFunction","options","parentDir","processTheme","themesList","plugins","mapSeries","spec","themeObj","then","arr","concat","exports","config","themesA","flattenDeep","plugin","reduce","mergeGatsbyConfig","newConfig","themes"],"sources":["../../../src/bootstrap/load-themes/index.js"],"sourcesContent":["const { createRequireFromPath } = require(`gatsby-core-utils`)\nconst path = require(`path`)\nimport { mergeGatsbyConfig } from \"../../utils/merge-gatsby-config\"\nconst Promise = require(`bluebird`)\nconst _ = require(`lodash`)\nconst debug = require(`debug`)(`gatsby:load-themes`)\nimport { preferDefault } from \"../prefer-default\"\nimport { getConfigFile } from \"../get-config-file\"\nimport { resolvePlugin } from \"../load-plugins/resolve-plugin\"\nconst reporter = require(`gatsby-cli/lib/reporter`)\n\n// get the gatsby-config file for a theme\nconst resolveTheme = async (\n  themeSpec,\n  configFileThatDeclaredTheme,\n  isMainConfig = false,\n  rootDir\n) => {\n  const themeName = themeSpec.resolve || themeSpec\n  let themeDir\n  try {\n    const scopedRequire = createRequireFromPath(`${rootDir}/:internal:`)\n    // theme is an node-resolvable module\n    themeDir = path.dirname(scopedRequire.resolve(themeName))\n  } catch (e) {\n    let pathToLocalTheme\n\n    // only try to look for local theme in main site\n    // local themes nested in other themes is potential source of problems:\n    // because those are not hosted by npm, there is potential for multiple\n    // local themes with same name that do different things and name being\n    // main identifier that Gatsby uses right now, it's safer not to support it for now.\n    if (isMainConfig) {\n      pathToLocalTheme = path.join(rootDir, `plugins`, themeName)\n      // is a local plugin OR it doesn't exist\n      try {\n        const { resolve } = resolvePlugin(themeName, rootDir)\n        themeDir = resolve\n      } catch (localErr) {\n        reporter.panic(`Failed to resolve ${themeName}`, localErr)\n      }\n    }\n\n    if (!themeDir) {\n      const nodeResolutionPaths = module.paths.map(p => path.join(p, themeName))\n      reporter.panic({\n        id: `10226`,\n        context: {\n          themeName,\n          configFilePath: configFileThatDeclaredTheme,\n          pathToLocalTheme,\n          nodeResolutionPaths,\n        },\n      })\n    }\n  }\n\n  const { configModule, configFilePath } = await getConfigFile(\n    themeDir,\n    `gatsby-config`\n  )\n  const theme = preferDefault(configModule)\n\n  // if theme is a function, call it with the themeConfig\n  let themeConfig = theme\n  if (_.isFunction(theme)) {\n    themeConfig = theme(themeSpec.options || {})\n  }\n  return {\n    themeName,\n    themeConfig,\n    themeSpec,\n    themeDir,\n    parentDir: rootDir,\n    configFilePath,\n  }\n}\n\n// single iteration of a recursive function that resolve parent themes\n// It's recursive because we support child themes declaring parents and\n// have to resolve all the way `up the tree` of parent/children relationships\n//\n// Theoretically, there could be an infinite loop here but in practice there is\n// no use case for a loop so I expect that to only happen if someone is very\n// off track and creating their own set of themes\nconst processTheme = (\n  { themeName, themeConfig, themeSpec, themeDir, configFilePath },\n  { rootDir }\n) => {\n  const themesList = themeConfig && themeConfig.plugins\n  // Gatsby themes don't have to specify a gatsby-config.js (they might only use gatsby-node, etc)\n  // in this case they're technically plugins, but we should support it anyway\n  // because we can't guarantee which files theme creators create first\n  if (themeConfig && themesList) {\n    // for every parent theme a theme defines, resolve the parent's\n    // gatsby config and return it in order [parentA, parentB, child]\n    return Promise.mapSeries(themesList, async spec => {\n      const themeObj = await resolveTheme(spec, configFilePath, false, themeDir)\n      return processTheme(themeObj, { rootDir: themeDir })\n    }).then(arr =>\n      arr.concat([\n        { themeName, themeConfig, themeSpec, themeDir, parentDir: rootDir },\n      ])\n    )\n  } else {\n    // if a theme doesn't define additional themes, return the original theme\n    return [{ themeName, themeConfig, themeSpec, themeDir, parentDir: rootDir }]\n  }\n}\n\nmodule.exports = async (config, { configFilePath, rootDir }) => {\n  const themesA = await Promise.mapSeries(\n    config.plugins || [],\n    async themeSpec => {\n      const themeObj = await resolveTheme(\n        themeSpec,\n        configFilePath,\n        true,\n        rootDir\n      )\n      return processTheme(themeObj, { rootDir })\n    }\n  ).then(arr => _.flattenDeep(arr))\n\n  // log out flattened themes list to aid in debugging\n  debug(themesA)\n\n  // map over each theme, adding the theme itself to the plugins\n  // list in the config for the theme. This enables the usage of\n  // gatsby-node, etc in themes.\n  return (\n    Promise.mapSeries(\n      themesA,\n      ({ themeName, themeConfig = {}, themeSpec, themeDir, parentDir }) => {\n        return {\n          ...themeConfig,\n          plugins: [\n            ...(themeConfig.plugins || []).map(plugin => {\n              return {\n                resolve: typeof plugin === `string` ? plugin : plugin.resolve,\n                options: plugin.options || {},\n                parentDir: themeDir,\n              }\n            }),\n            // theme plugin is last so it's gatsby-node, etc can override it's declared plugins, like a normal site.\n            { resolve: themeName, options: themeSpec.options || {}, parentDir },\n          ],\n        }\n      }\n    )\n      /**\n       * themes resolve to a gatsby-config, so here we merge all of the configs\n       * into a single config, making sure to maintain the order in which\n       * they were defined so that later configs, like the user's site and\n       * children, can override functionality in earlier themes.\n       */\n      .reduce(mergeGatsbyConfig, {})\n      .then(newConfig => {\n        return {\n          config: mergeGatsbyConfig(newConfig, config),\n          themes: themesA,\n        }\n      })\n  )\n}\n"],"mappings":"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"}