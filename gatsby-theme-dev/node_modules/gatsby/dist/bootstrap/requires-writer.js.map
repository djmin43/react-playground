{"version":3,"file":"requires-writer.js","names":["paramRe","SEGMENT_POINTS","STATIC_POINTS","DYNAMIC_POINTS","SPLAT_PENALTY","ROOT_POINTS","isRootSegment","segment","isDynamic","test","isSplat","segmentize","uri","replace","split","rankRoute","path","reduce","score","lastHash","resetLastHash","pickComponentFields","page","getComponents","pages","c","componentChunkName","getMatchPaths","createMatchPathEntry","index","matchPath","undefined","reporter","panic","matchPathPages","forEach","getPageMode","push","length","newMatches","isInsideMatchPath","find","pageWithMatchPath","match","sort","a","b","order","localeCompare","map","createHash","matchPaths","components","cleanedSSRVisitedPageComponents","crypto","update","JSON","stringify","digest","writeAll","state","program","values","process","env","GATSBY_EXPERIMENTAL_DEV_SSR","ssrVisitedPageComponents","visitedPages","get","filter","some","s","newHash","lazySyncRequires","joinPath","component","join","writeModule","devSSRWillInvalidate","syncRequires","asyncRequires","gatsby_executing_command","relativeComponentPath","relative","getAbsolutePathForVirtualModule","slash","writeAndMove","virtualFilePath","file","data","destination","directory","tmp","Date","now","fs","writeFile","then","move","overwrite","Promise","all","debouncedWriteAll","activity","activityTimer","id","start","store","getState","end","leading","listenerStarted","startListener","emitter","on","pendingActivity"],"sources":["../../src/bootstrap/requires-writer.ts"],"sourcesContent":["import _ from \"lodash\"\nimport path from \"path\"\nimport fs from \"fs-extra\"\nimport crypto from \"crypto\"\nimport { slash } from \"gatsby-core-utils\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport { match } from \"@gatsbyjs/reach-router/lib/utils\"\nimport { joinPath } from \"gatsby-core-utils\"\nimport { store, emitter } from \"../redux/\"\nimport { IGatsbyState, IGatsbyPage } from \"../redux/types\"\nimport {\n  writeModule,\n  getAbsolutePathForVirtualModule,\n} from \"../utils/gatsby-webpack-virtual-modules\"\nimport { getPageMode } from \"../utils/page-mode\"\nimport { devSSRWillInvalidate } from \"../commands/build-html\"\n\ninterface IGatsbyPageComponent {\n  component: string\n  componentChunkName: string\n}\n\ninterface IGatsbyPageMatchPath {\n  path: string\n  matchPath: string | undefined\n}\n\n// path ranking algorithm copied (with small adjustments) from `@reach/router` (internal util, not exported from the package)\n// https://github.com/reach/router/blob/28a79e7fc3a3487cb3304210dc3501efb8a50eba/src/lib/utils.js#L216-L254\nconst paramRe = /^:(.+)/\n\nconst SEGMENT_POINTS = 4\nconst STATIC_POINTS = 3\nconst DYNAMIC_POINTS = 2\nconst SPLAT_PENALTY = 1\nconst ROOT_POINTS = 1\n\nconst isRootSegment = (segment: string): boolean => segment === ``\nconst isDynamic = (segment: string): boolean => paramRe.test(segment)\nconst isSplat = (segment: string): boolean => segment === `*`\n\nconst segmentize = (uri: string): Array<string> =>\n  uri\n    // strip starting/ending slashes\n    .replace(/(^\\/+|\\/+$)/g, ``)\n    .split(`/`)\n\nconst rankRoute = (path: string): number =>\n  segmentize(path).reduce((score, segment) => {\n    score += SEGMENT_POINTS\n    if (isRootSegment(segment)) score += ROOT_POINTS\n    else if (isDynamic(segment)) score += DYNAMIC_POINTS\n    else if (isSplat(segment)) score -= SEGMENT_POINTS + SPLAT_PENALTY\n    else score += STATIC_POINTS\n    return score\n  }, 0)\n// end of copied `@reach/router` internals\n\nlet lastHash: string | null = null\n\nexport const resetLastHash = (): void => {\n  lastHash = null\n}\n\nconst pickComponentFields = (page: IGatsbyPage): IGatsbyPageComponent =>\n  _.pick(page, [`component`, `componentChunkName`])\n\nexport const getComponents = (\n  pages: Array<IGatsbyPage>\n): Array<IGatsbyPageComponent> =>\n  _.orderBy(\n    _.uniqBy(_.map(pages, pickComponentFields), c => c.componentChunkName),\n    c => c.componentChunkName\n  )\n\n/**\n * Get all dynamic routes and sort them by most specific at the top\n * code is based on @reach/router match utility (https://github.com/reach/router/blob/152aff2352bc62cefc932e1b536de9efde6b64a5/src/lib/utils.js#L224-L254)\n */\nconst getMatchPaths = (\n  pages: Array<IGatsbyPage>\n): Array<IGatsbyPageMatchPath> => {\n  interface IMatchPathEntry extends IGatsbyPage {\n    index: number\n    score: number\n    matchPath: string\n  }\n\n  const createMatchPathEntry = (\n    page: IGatsbyPage,\n    index: number\n  ): IMatchPathEntry => {\n    const { matchPath } = page\n\n    if (matchPath === undefined) {\n      return reporter.panic(\n        `Error: matchPath property is undefined for page ${page.path}, should be a string`\n      ) as never\n    }\n\n    return {\n      ...page,\n      matchPath,\n      index,\n      score: rankRoute(matchPath),\n    }\n  }\n\n  const matchPathPages: Array<IMatchPathEntry> = []\n\n  pages.forEach((page: IGatsbyPage, index: number): void => {\n    if (_CFLAGS_.GATSBY_MAJOR === `4`) {\n      if (page.matchPath && getPageMode(page) === `SSG`) {\n        matchPathPages.push(createMatchPathEntry(page, index))\n      }\n    } else {\n      if (page.matchPath) {\n        matchPathPages.push(createMatchPathEntry(page, index))\n      }\n    }\n  })\n\n  // Pages can live in matchPaths, to keep them working without doing another network request\n  // we save them in matchPath. We use `@reach/router` path ranking to score paths/matchPaths\n  // and sort them so more specific paths are before less specific paths.\n  // More info in https://github.com/gatsbyjs/gatsby/issues/16097\n  // small speedup: don't bother traversing when no matchPaths found.\n  if (matchPathPages.length) {\n    const newMatches: Array<IMatchPathEntry> = []\n\n    pages.forEach((page: IGatsbyPage, index: number): void => {\n      const isInsideMatchPath = !!matchPathPages.find(\n        pageWithMatchPath =>\n          !page.matchPath && match(pageWithMatchPath.matchPath, page.path)\n      )\n\n      if (isInsideMatchPath) {\n        newMatches.push(\n          createMatchPathEntry(\n            {\n              ...page,\n              matchPath: page.path,\n            },\n            index\n          )\n        )\n      }\n    })\n    // Add afterwards because the new matches are not relevant for the existing search\n    matchPathPages.push(...newMatches)\n  }\n\n  return matchPathPages\n    .sort((a, b) => {\n      // The higher the score, the higher the specificity of our matchPath\n      const order = b.score - a.score\n      if (order !== 0) {\n        return order\n      }\n\n      // if specificity is the same we do lexigraphic comparison of path to ensure\n      // deterministic order regardless of order pages where created\n      return a.matchPath.localeCompare(b.matchPath)\n    })\n    .map(({ path, matchPath }) => {\n      return { path, matchPath }\n    })\n}\n\nconst createHash = (\n  matchPaths: Array<IGatsbyPageMatchPath>,\n  components: Array<IGatsbyPageComponent>,\n  cleanedSSRVisitedPageComponents: Array<IGatsbyPageComponent>\n): string =>\n  crypto\n    .createHash(`md5`)\n    .update(\n      JSON.stringify({\n        matchPaths,\n        components,\n        cleanedSSRVisitedPageComponents,\n      })\n    )\n    .digest(`hex`)\n\n// Write out pages information.\nexport const writeAll = async (state: IGatsbyState): Promise<boolean> => {\n  const { program } = state\n  const pages = [...state.pages.values()]\n  const matchPaths = getMatchPaths(pages)\n  const components = getComponents(pages)\n  let cleanedSSRVisitedPageComponents: Array<IGatsbyPageComponent> = []\n\n  if (process.env.GATSBY_EXPERIMENTAL_DEV_SSR) {\n    const ssrVisitedPageComponents = [\n      ...(state.visitedPages.get(`server`)?.values() || []),\n    ]\n\n    // Remove any page components that no longer exist.\n    cleanedSSRVisitedPageComponents = components.filter(c =>\n      ssrVisitedPageComponents.some(s => s === c.componentChunkName)\n    )\n  }\n\n  const newHash = createHash(\n    matchPaths,\n    components,\n    cleanedSSRVisitedPageComponents\n  )\n\n  if (newHash === lastHash) {\n    // Nothing changed. No need to rewrite files\n    return false\n  }\n\n  lastHash = newHash\n\n  if (process.env.GATSBY_EXPERIMENTAL_DEV_SSR) {\n    // Create file with sync requires of visited page components files.\n\n    const lazySyncRequires = `exports.ssrComponents = {\\n${cleanedSSRVisitedPageComponents\n      .map(\n        (c: IGatsbyPageComponent): string =>\n          `  \"${c.componentChunkName}\": require(\"${joinPath(c.component)}\")`\n      )\n      .join(`,\\n`)}\n  }\\n\\n`\n\n    writeModule(`$virtual/ssr-sync-requires`, lazySyncRequires)\n    // if this is executed, webpack should mark it as invalid, but sometimes there is some timing race\n    // so we also explicitly set flag here as well\n    devSSRWillInvalidate()\n  }\n\n  // Create file with sync requires of components/json files.\n  let syncRequires = `\n// prefer default export if available\nconst preferDefault = m => (m && m.default) || m\n\\n\\n`\n  syncRequires += `exports.components = {\\n${components\n    .map(\n      (c: IGatsbyPageComponent): string =>\n        `  \"${c.componentChunkName}\": preferDefault(require(\"${joinPath(\n          c.component\n        )}\"))`\n    )\n    .join(`,\\n`)}\n}\\n\\n`\n\n  // Create file with async requires of components/json files.\n  let asyncRequires = ``\n\n  if (process.env.gatsby_executing_command === `develop`) {\n    asyncRequires = `exports.components = {\\n${components\n      .map((c: IGatsbyPageComponent): string => {\n        // we need a relative import path to keep contenthash the same if directory changes\n        const relativeComponentPath = path.relative(\n          getAbsolutePathForVirtualModule(`$virtual`),\n          c.component\n        )\n\n        return `  \"${c.componentChunkName}\": () => import(\"${slash(\n          `./${relativeComponentPath}`\n        )}?export=default\" /* webpackChunkName: \"${c.componentChunkName}\" */)`\n      })\n      .join(`,\\n`)}\n}\\n\\n\n\nexports.head = {\\n${components\n      .map((c: IGatsbyPageComponent): string => {\n        // we need a relative import path to keep contenthash the same if directory changes\n        const relativeComponentPath = path.relative(\n          getAbsolutePathForVirtualModule(`$virtual`),\n          c.component\n        )\n\n        return `  \"${c.componentChunkName}\": () => import(\"${slash(\n          `./${relativeComponentPath}`\n        )}?export=head\" /* webpackChunkName: \"${c.componentChunkName}head\" */)`\n      })\n      .join(`,\\n`)}\n}\\n\\n`\n  } else {\n    asyncRequires = `exports.components = {\\n${components\n      .map((c: IGatsbyPageComponent): string => {\n        // we need a relative import path to keep contenthash the same if directory changes\n        const relativeComponentPath = path.relative(\n          getAbsolutePathForVirtualModule(`$virtual`),\n          c.component\n        )\n        return `  \"${c.componentChunkName}\": () => import(\"${slash(\n          `./${relativeComponentPath}`\n        )}\" /* webpackChunkName: \"${c.componentChunkName}\" */)`\n      })\n      .join(`,\\n`)}\n}\\n\\n`\n  }\n\n  const writeAndMove = (\n    virtualFilePath: string,\n    file: string,\n    data: string\n  ): Promise<void> => {\n    writeModule(virtualFilePath, data)\n\n    // files in .cache are not used anymore as part of webpack builds, but\n    // still can be used by other tools (for example `gatsby serve` reads\n    // `match-paths.json` to setup routing)\n    const destination = joinPath(program.directory, `.cache`, file)\n    const tmp = `${destination}.${Date.now()}`\n    return fs\n      .writeFile(tmp, data)\n      .then(() => fs.move(tmp, destination, { overwrite: true }))\n  }\n\n  await Promise.all([\n    writeAndMove(`$virtual/sync-requires.js`, `sync-requires.js`, syncRequires),\n    writeAndMove(\n      `$virtual/async-requires.js`,\n      `async-requires.js`,\n      asyncRequires\n    ),\n    writeAndMove(\n      `$virtual/match-paths.json`,\n      `match-paths.json`,\n      JSON.stringify(matchPaths, null, 4)\n    ),\n  ])\n\n  return true\n}\n\nconst debouncedWriteAll = _.debounce(\n  async (): Promise<void> => {\n    const activity = reporter.activityTimer(`write out requires`, {\n      id: `requires-writer`,\n    })\n    activity.start()\n    await writeAll(store.getState())\n    activity.end()\n  },\n  500,\n  {\n    // using \"leading\" can cause double `writeAll` call - particularly\n    // when refreshing data using `/__refresh` hook.\n    leading: false,\n  }\n)\n\n/**\n * Start listening to CREATE/DELETE_PAGE events so we can rewrite\n * files as required\n */\nlet listenerStarted = false\nexport const startListener = (): void => {\n  // Only start the listener once.\n  if (listenerStarted) {\n    return\n  }\n  listenerStarted = true\n\n  if (process.env.GATSBY_EXPERIMENTAL_DEV_SSR) {\n    /**\n     * Start listening to CREATE_SERVER_VISITED_PAGE events so we can rewrite\n     * files as required\n     */\n    emitter.on(`CREATE_SERVER_VISITED_PAGE`, async (): Promise<void> => {\n      // this event only happen on new additions\n      devSSRWillInvalidate()\n      reporter.pendingActivity({ id: `requires-writer` })\n      debouncedWriteAll()\n    })\n  }\n\n  emitter.on(`CREATE_PAGE`, (): void => {\n    reporter.pendingActivity({ id: `requires-writer` })\n    debouncedWriteAll()\n  })\n\n  emitter.on(`CREATE_PAGE_END`, (): void => {\n    reporter.pendingActivity({ id: `requires-writer` })\n    debouncedWriteAll()\n  })\n\n  emitter.on(`DELETE_PAGE`, (): void => {\n    reporter.pendingActivity({ id: `requires-writer` })\n    debouncedWriteAll()\n  })\n\n  emitter.on(`DELETE_PAGE_BY_PATH`, (): void => {\n    reporter.pendingActivity({ id: `requires-writer` })\n    debouncedWriteAll()\n  })\n}\n"],"mappings":"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"}