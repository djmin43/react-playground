{"version":3,"file":"get-config-file.js","names":["isNearMatch","fileName","configName","distance","levenshtein","getConfigFile","siteDirectory","configPath","configFilePath","configModule","path","join","COMPILED_CACHE_DIR","require","resolve","outerError","isModuleNotFoundError","code","isThisFileRequireError","requireStack","includes","report","panic","id","error","context","message","innerError","testRequireError","files","fs","readdir","tsConfig","nearMatch","file","name","ext","parse","existsSync"],"sources":["../../src/bootstrap/get-config-file.ts"],"sourcesContent":["import { distance as levenshtein } from \"fastest-levenshtein\"\nimport fs from \"fs-extra\"\nimport { testRequireError } from \"../utils/test-require-error\"\nimport report from \"gatsby-cli/lib/reporter\"\nimport path from \"path\"\nimport { sync as existsSync } from \"fs-exists-cached\"\nimport { COMPILED_CACHE_DIR } from \"../utils/parcel/compile-gatsby-files\"\n\nexport function isNearMatch(\n  fileName: string | undefined,\n  configName: string,\n  distance: number\n): boolean {\n  if (!fileName) return false\n  return levenshtein(fileName, configName) <= distance\n}\n\nexport async function getConfigFile(\n  siteDirectory: string,\n  configName: string,\n  distance: number = 3\n): Promise<{\n  configModule: any\n  configFilePath: string\n}> {\n  let configPath = ``\n  let configFilePath = ``\n  let configModule: any\n\n  // Attempt to find compiled gatsby-config.js in .cache/compiled/gatsby-config.js\n  try {\n    configPath = path.join(`${siteDirectory}/${COMPILED_CACHE_DIR}`, configName)\n    configFilePath = require.resolve(configPath)\n    configModule = require(configFilePath)\n  } catch (outerError) {\n    // Not all plugins will have a compiled file, so the err.message can look like this:\n    // \"Cannot find module '<root>/node_modules/gatsby-source-filesystem/.cache/compiled/gatsby-config'\"\n    // But the compiled file can also have an error like this:\n    // \"Cannot find module 'foobar'\"\n    // So this is trying to differentiate between an error we're fine ignoring and an error that we should throw\n    const isModuleNotFoundError = outerError.code === `MODULE_NOT_FOUND`\n    const isThisFileRequireError =\n      outerError?.requireStack?.[0]?.includes(`get-config-file`) ?? true\n\n    // User's module require error inside gatsby-config.js\n    if (!(isModuleNotFoundError && isThisFileRequireError)) {\n      report.panic({\n        id: `11902`,\n        error: outerError,\n        context: {\n          configName,\n          message: outerError.message,\n        },\n      })\n    }\n\n    // Attempt to find uncompiled gatsby-config.js in root dir\n    configPath = path.join(siteDirectory, configName)\n\n    try {\n      configFilePath = require.resolve(configPath)\n      configModule = require(configFilePath)\n    } catch (innerError) {\n      // Some other error that is not a require error\n      if (!testRequireError(configPath, innerError)) {\n        report.panic({\n          id: `10123`,\n          error: innerError,\n          context: {\n            configName,\n            message: innerError.message,\n          },\n        })\n      }\n\n      const files = await fs.readdir(siteDirectory)\n\n      let tsConfig = false\n      let nearMatch = ``\n\n      for (const file of files) {\n        if (tsConfig || nearMatch) {\n          break\n        }\n\n        const { name, ext } = path.parse(file)\n\n        if (name === configName && ext === `.ts`) {\n          tsConfig = true\n          break\n        }\n\n        if (isNearMatch(name, configName, distance)) {\n          nearMatch = file\n        }\n      }\n\n      // gatsby-config.ts exists but compiled gatsby-config.js does not\n      if (tsConfig) {\n        report.panic({\n          id: `10127`,\n          error: innerError,\n          context: {\n            configName,\n          },\n        })\n      }\n\n      // gatsby-config is misnamed\n      if (nearMatch) {\n        report.panic({\n          id: `10124`,\n          error: innerError,\n          context: {\n            configName,\n            nearMatch,\n          },\n        })\n      }\n\n      // gatsby-config.js is incorrectly located in src/gatsby-config.js\n      if (existsSync(path.join(siteDirectory, `src`, configName + `.js`))) {\n        report.panic({\n          id: `10125`,\n          context: {\n            configName,\n          },\n        })\n      }\n    }\n  }\n\n  return { configModule, configFilePath }\n}\n"],"mappings":"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"}