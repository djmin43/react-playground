{"version":3,"file":"resolve-module-exports.js","names":["staticallyAnalyzeExports","modulePath","resolver","resolveModule","absPath","exportNames","err","code","fs","readFileSync","ast","babelParseToAst","SyntaxError","codeFrame","codeFrameColumns","start","loc","highlightCode","report","panic","message","isCommonJS","isES6","traverse","ImportDeclaration","ExportNamedDeclaration","astPath","declaration","node","type","declarations","id","push","name","ExportSpecifier","exp","exported","exportName","ExportDefaultDeclaration","t","isIdentifier","isArrowFunctionExpression","isFunctionDeclaration","AssignmentExpression","nodeLeft","left","isMemberExpression","property","object","process","env","NODE_ENV","resolveModuleExports","mode","require","resolve","Object","keys","filter","e","testRequireError"],"sources":["../../src/bootstrap/resolve-module-exports.ts"],"sourcesContent":["import * as fs from \"fs-extra\"\nimport * as t from \"@babel/types\"\nimport traverse from \"@babel/traverse\"\nimport { codeFrameColumns, SourceLocation } from \"@babel/code-frame\"\nimport report from \"gatsby-cli/lib/reporter\"\nimport { babelParseToAst } from \"../utils/babel-parse-to-ast\"\nimport { testRequireError } from \"../utils/test-require-error\"\nimport { resolveModule } from \"../utils/module-resolver\"\n\nconst staticallyAnalyzeExports = (\n  modulePath: string,\n  resolver = resolveModule\n): Array<string> => {\n  let absPath: string | undefined\n  const exportNames: Array<string> = []\n\n  try {\n    absPath = resolver(modulePath) as string\n  } catch (err) {\n    return exportNames // doesn't exist\n  }\n  const code = fs.readFileSync(absPath, `utf8`) // get file contents\n\n  let ast\n  try {\n    ast = babelParseToAst(code, absPath)\n  } catch (err) {\n    if (err instanceof SyntaxError) {\n      // Pretty print syntax errors\n      const codeFrame = codeFrameColumns(\n        code,\n        {\n          start: (err as unknown as { loc: SourceLocation[\"start\"] }).loc,\n        },\n        {\n          highlightCode: true,\n        }\n      )\n\n      report.panic(\n        `Syntax error in \"${absPath}\":\\n${err.message}\\n${codeFrame}`\n      )\n    } else {\n      // if it's not syntax error, just throw it\n      throw err\n    }\n  }\n\n  let isCommonJS = false\n  let isES6 = false\n\n  // extract names of exports from file\n  traverse(ast, {\n    // Check if the file is using ES6 imports\n    ImportDeclaration: function ImportDeclaration() {\n      isES6 = true\n    },\n\n    ExportNamedDeclaration: function ExportNamedDeclaration(astPath) {\n      const declaration = astPath.node.declaration\n\n      // get foo from `export const foo = bar`\n      if (\n        declaration?.type === `VariableDeclaration` &&\n        declaration.declarations[0]?.id.type === `Identifier`\n      ) {\n        isES6 = true\n        exportNames.push(declaration.declarations[0].id.name)\n      }\n\n      // get foo from `export function foo()`\n      if (\n        declaration?.type === `FunctionDeclaration` &&\n        declaration.id?.type === `Identifier`\n      ) {\n        isES6 = true\n        exportNames.push(declaration.id.name)\n      }\n    },\n\n    // get foo from `export { foo } from 'bar'`\n    // get foo from `export { foo }`\n    ExportSpecifier: function ExportSpecifier(astPath) {\n      isES6 = true\n      const exp = astPath?.node?.exported\n      if (!exp) {\n        return\n      }\n      if (exp.type === `Identifier`) {\n        const exportName = exp.name\n        if (exportName) {\n          exportNames.push(exportName)\n        }\n      }\n    },\n\n    // export default () => {}\n    // export default function() {}\n    // export default function foo() {}\n    // const foo = () => {}; export default foo\n    ExportDefaultDeclaration: function ExportDefaultDeclaration(astPath) {\n      const declaration = astPath.node.declaration\n      if (\n        !t.isIdentifier(declaration) &&\n        !t.isArrowFunctionExpression(declaration) &&\n        !t.isFunctionDeclaration(declaration)\n      ) {\n        return\n      }\n\n      let name = ``\n      if (t.isIdentifier(declaration)) {\n        name = declaration.name\n      } else if (t.isFunctionDeclaration(declaration) && declaration.id) {\n        name = declaration.id.name\n      }\n\n      const exportName = `export default${name ? ` ${name}` : ``}`\n      isES6 = true\n      exportNames.push(exportName)\n    },\n\n    AssignmentExpression: function AssignmentExpression(astPath) {\n      const nodeLeft = astPath.node.left\n\n      if (!t.isMemberExpression(nodeLeft)) {\n        return\n      }\n\n      // ignore marker property `__esModule`\n      if (\n        t.isIdentifier(nodeLeft.property) &&\n        nodeLeft.property.name === `__esModule`\n      ) {\n        return\n      }\n\n      // get foo from `exports.foo = bar`\n      if (\n        t.isIdentifier(nodeLeft.object) &&\n        nodeLeft.object.name === `exports`\n      ) {\n        isCommonJS = true\n        exportNames.push((nodeLeft.property as t.Identifier).name)\n      }\n\n      // get foo from `module.exports.foo = bar`\n      if (t.isMemberExpression(nodeLeft.object)) {\n        const exp: t.MemberExpression = nodeLeft.object\n\n        if (\n          t.isIdentifier(exp.object) &&\n          t.isIdentifier(exp.property) &&\n          exp.object.name === `module` &&\n          exp.property.name === `exports`\n        ) {\n          isCommonJS = true\n          exportNames.push((nodeLeft.property as t.Identifier).name)\n        }\n      }\n    },\n  })\n\n  if (isES6 && isCommonJS && process.env.NODE_ENV !== `test`) {\n    report.panic(\n      `This plugin file is using both CommonJS and ES6 module systems together which we don't support.\nYou'll need to edit the file to use just one or the other.\n\nplugin: ${modulePath}.js\n\nThis didn't cause a problem in Gatsby v1 so you might want to review the migration doc for this:\nhttps://gatsby.dev/no-mixed-modules\n      `\n    )\n  }\n  return exportNames\n}\n\n/**\n * Given a `require.resolve()` compatible path pointing to a JS module,\n * return an array listing the names of the module's exports.\n *\n * Returns [] for invalid paths and modules without exports.\n *\n * @param modulePath\n * @param mode\n * @param resolver\n */\nexport const resolveModuleExports = (\n  modulePath: string,\n  { mode = `analysis`, resolver = resolveModule } = {}\n): Array<string> => {\n  if (mode === `require`) {\n    let absPath: string | undefined\n    try {\n      absPath = require.resolve(modulePath)\n      return Object.keys(require(modulePath)).filter(\n        exportName => exportName !== `__esModule`\n      )\n    } catch (e) {\n      if (!testRequireError(modulePath, e)) {\n        // if module exists, but requiring it cause errors,\n        // show the error to the user and terminate build\n        report.panic(`Error in \"${absPath}\":`, e)\n      }\n    }\n  } else {\n    return staticallyAnalyzeExports(modulePath, resolver)\n  }\n\n  return []\n}\n"],"mappings":"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"}