{"version":3,"file":"is-file.js","names":["getFirstValueAt","node","selector","value","getValueAt","Array","isArray","withBaseDir","dir","p","path","posix","join","slash","findAncestorNode","childNode","predicate","getNode","parent","undefined","getBaseDir","internal","type","getAbsolutePath","relativePath","withDir","map","getFilePath","fieldPath","typeName","split","looksLikeFile","isAbsolute","mime","getType","isRelative","isRelativeUrl","normalizedPath","getNodesByType","find","isFile","filePath","filePathExists","some","absolutePath"],"sources":["../../../src/schema/infer/is-file.ts"],"sourcesContent":["import path from \"path\"\nimport { slash } from \"gatsby-core-utils\"\nimport mime from \"mime\"\nimport isRelative from \"is-relative\"\nimport isRelativeUrl from \"is-relative-url\"\nimport { getValueAt } from \"../../utils/get-value-at\"\nimport { getNode, getNodesByType } from \"../../datastore\"\nimport { IGatsbyNode } from \"../../redux/types\"\n\nconst getFirstValueAt = (\n  node: IGatsbyNode,\n  selector: string | Array<string>\n): string => {\n  let value = getValueAt(node, selector)\n  while (Array.isArray(value)) {\n    value = value[0]\n  }\n  return value\n}\n\nconst withBaseDir =\n  (dir: string) =>\n  (p: string): string =>\n    path.posix.join(dir, slash(p))\n\nconst findAncestorNode = (\n  childNode: IGatsbyNode,\n  predicate: (n: IGatsbyNode) => boolean\n): IGatsbyNode | null => {\n  let node: IGatsbyNode | undefined = childNode\n  do {\n    if (predicate(node)) {\n      return node\n    }\n    node = getNode(node.parent)\n  } while (node !== undefined)\n  return null\n}\n\nconst getBaseDir = (node: IGatsbyNode): string | null => {\n  if (node) {\n    const { dir } = findAncestorNode(\n      node,\n      node => node.internal.type === `File`\n    ) || { dir: `` }\n    return typeof dir === `string` ? dir : null\n  }\n  return null\n}\n\nconst getAbsolutePath = (\n  node: IGatsbyNode,\n  relativePath: string\n): string | Array<string> | null => {\n  const dir = getBaseDir(node)\n  const withDir = withBaseDir(dir ?? ``)\n  return dir\n    ? Array.isArray(relativePath)\n      ? relativePath.map(withDir)\n      : withDir(relativePath)\n    : null\n}\n\nconst getFilePath = (\n  fieldPath: string,\n  relativePath: string\n): string | Array<string> | null => {\n  const [typeName, ...selector] = Array.isArray(fieldPath)\n    ? fieldPath\n    : fieldPath.split(`.`)\n\n  if (typeName === `File`) return null\n\n  const looksLikeFile =\n    !path.isAbsolute(relativePath) &&\n    mime.getType(relativePath) !== null &&\n    // FIXME: Do we need all of this?\n    mime.getType(relativePath) !== `application/x-msdownload` &&\n    isRelative(relativePath) &&\n    isRelativeUrl(relativePath)\n\n  if (!looksLikeFile) return null\n\n  const normalizedPath = slash(relativePath)\n  const node = getNodesByType(typeName).find(\n    node => getFirstValueAt(node, selector) === normalizedPath\n  )\n\n  return node ? getAbsolutePath(node, normalizedPath) : null\n}\n\nexport const isFile = (fieldPath: string, relativePath: string): boolean => {\n  const filePath = getFilePath(fieldPath, relativePath)\n  if (!filePath) return false\n  const filePathExists = getNodesByType(`File`).some(\n    node => node.absolutePath === filePath\n  )\n  return filePathExists\n}\n"],"mappings":"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"}