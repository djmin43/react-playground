{"version":3,"file":"bundle-webpack.js","names":["extensions","outputDir","path","join","process","cwd","cacheLocation","getApisToRemoveForQueryEngine","apisToKeep","Set","schemaCustomizationAPIs","add","apisToRemove","Object","keys","nodeApis","filter","api","has","createGraphqlEngineBundle","rootDir","reporter","isVerbose","schemaSnapshotString","fs","readFile","printQueryEnginePlugins","assetRelocatorUseEntry","loader","require","resolve","options","outputAssetBase","gatsbyPluginTSRequire","mod","createRequire","compiler","webpack","name","mode","entry","__dirname","output","filename","libraryTarget","target","externalsPresets","node","cache","type","buildDependencies","config","__filename","externals","builtinModules","reduce","acc","builtinModule","module","rules","oneOf","test","parser","amd","use","remove","jsx","exclude","presets","byDependency","esm","fullySpecified","alias","inquirer","lmdb","plugins","EnvironmentPlugin","DefinePlugin","JSON","stringify","SCHEMA_SNAPSHOT","env","GATSBY_WEBPACK_LOGGING","includes","WebpackLoggingPlugin","Boolean","Promise","reject","run","err","stats","getResourcePath","webpackModule","ConcatenatedModule","resource","modules","firstSubModule","undefined","iterateModules","webpackModules","compilation","resourcePath","importedBy","moduleGraph","getIssuer","structuredError","id","context","package","advisory","close","closeErr","e"],"sources":["../../../src/schema/graphql-engine/bundle-webpack.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/naming-convention */\n\nimport * as path from \"path\"\nimport * as fs from \"fs-extra\"\nimport webpack, { Module, NormalModule, Compilation } from \"webpack\"\nimport ConcatenatedModule from \"webpack/lib/optimize/ConcatenatedModule\"\nimport { printQueryEnginePlugins } from \"./print-plugins\"\nimport mod from \"module\"\nimport { WebpackLoggingPlugin } from \"../../utils/webpack/plugins/webpack-logging\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport { schemaCustomizationAPIs } from \"./print-plugins\"\nimport type { GatsbyNodeAPI } from \"../../redux/types\"\nimport * as nodeApis from \"../../utils/api-node-docs\"\n\ntype Reporter = typeof reporter\n\nconst extensions = [`.mjs`, `.js`, `.json`, `.node`, `.ts`, `.tsx`]\n\nconst outputDir = path.join(process.cwd(), `.cache`, `query-engine`)\nconst cacheLocation = path.join(\n  process.cwd(),\n  `.cache`,\n  `webpack`,\n  `query-engine`\n)\n\nfunction getApisToRemoveForQueryEngine(): Array<GatsbyNodeAPI> {\n  const apisToKeep = new Set(schemaCustomizationAPIs)\n  apisToKeep.add(`onPluginInit`)\n\n  const apisToRemove = (Object.keys(nodeApis) as Array<GatsbyNodeAPI>).filter(\n    api => !apisToKeep.has(api)\n  )\n  return apisToRemove\n}\n\nexport async function createGraphqlEngineBundle(\n  rootDir: string,\n  reporter: Reporter,\n  isVerbose?: boolean\n): Promise<webpack.Compilation | undefined> {\n  const schemaSnapshotString = await fs.readFile(\n    path.join(rootDir, `.cache`, `schema.gql`),\n    `utf-8`\n  )\n  await printQueryEnginePlugins()\n\n  const assetRelocatorUseEntry = {\n    loader: require.resolve(`@vercel/webpack-asset-relocator-loader`),\n    options: {\n      outputAssetBase: `assets`,\n    },\n  }\n\n  const gatsbyPluginTSRequire = mod.createRequire(\n    require.resolve(`gatsby-plugin-typescript`)\n  )\n\n  const compiler = webpack({\n    name: `Query Engine`,\n    // mode: `production`,\n    mode: `none`,\n    entry: path.join(__dirname, `entry.js`),\n    output: {\n      path: outputDir,\n      filename: `index.js`,\n      libraryTarget: `commonjs`,\n    },\n    target: `node`,\n    externalsPresets: {\n      node: false,\n    },\n    cache: {\n      type: `filesystem`,\n      name: `graphql-engine`,\n      cacheLocation,\n      buildDependencies: {\n        config: [__filename],\n      },\n    },\n    // those are required in some runtime paths, but we don't need them\n    externals: [\n      `cbor-x`, // optional dep of lmdb-store, but we are using `msgpack` (default) encoding, so we don't need it\n      `babel-runtime/helpers/asyncToGenerator`, // undeclared dep of yurnalist (but used in code path we don't use)\n      `electron`, // :shrug: `got` seems to have electron specific code path\n      mod.builtinModules.reduce((acc, builtinModule) => {\n        if (builtinModule === `fs`) {\n          acc[builtinModule] = `global _actualFsWrapper`\n        } else {\n          acc[builtinModule] = `commonjs ${builtinModule}`\n        }\n\n        return acc\n      }, {}),\n    ],\n    module: {\n      rules: [\n        {\n          oneOf: [\n            {\n              // specific set of loaders for LMBD - our custom patch to massage lmdb to work with relocator -> relocator\n              test: /node_modules[/\\\\]lmdb[/\\\\].*\\.[cm]?js/,\n              // it is recommended for Node builds to turn off AMD support\n              parser: { amd: false },\n              use: [\n                assetRelocatorUseEntry,\n                {\n                  loader: require.resolve(`./lmdb-bundling-patch`),\n                },\n              ],\n            },\n            {\n              // specific set of loaders for gatsby-node files - our babel transform that removes lifecycles not needed for engine -> relocator\n              test: /gatsby-node\\.(cjs|mjs|js|ts)$/,\n              // it is recommended for Node builds to turn off AMD support\n              parser: { amd: false },\n              use: [\n                assetRelocatorUseEntry,\n                {\n                  loader: require.resolve(\n                    `../../utils/webpack/loaders/webpack-remove-exports-loader`\n                  ),\n                  options: {\n                    remove: getApisToRemoveForQueryEngine(),\n                    jsx: false,\n                  },\n                },\n              ],\n            },\n            {\n              // generic loader for all other cases than lmdb or gatsby-node - we don't do anything special other than using relocator on it\n              // For node binary relocations, include \".node\" files as well here\n              test: /\\.(cjs|mjs|js|ts|node)$/,\n              // it is recommended for Node builds to turn off AMD support\n              parser: { amd: false },\n              use: assetRelocatorUseEntry,\n            },\n          ],\n        },\n        {\n          test: /\\.ts$/,\n          exclude: /node_modules/,\n          use: {\n            loader: require.resolve(`babel-loader`),\n            options: {\n              presets: [\n                gatsbyPluginTSRequire.resolve(`@babel/preset-typescript`),\n              ],\n            },\n          },\n        },\n        {\n          test: /\\.m?js$/,\n          type: `javascript/auto`,\n          resolve: {\n            byDependency: {\n              esm: {\n                fullySpecified: false,\n              },\n            },\n          },\n        },\n        {\n          test: /\\.txt/,\n          type: `asset/resource`,\n        },\n      ],\n    },\n    resolve: {\n      extensions,\n      alias: {\n        \".cache\": process.cwd() + `/.cache/`,\n\n        [require.resolve(`gatsby-cli/lib/reporter/loggers/ink/index.js`)]:\n          false,\n        inquirer: false,\n        // only load one version of lmdb\n        lmdb: require.resolve(`lmdb`),\n        \"ts-node\": require.resolve(`./shims/ts-node`),\n      },\n    },\n    plugins: [\n      new webpack.EnvironmentPlugin([`GATSBY_CLOUD_IMAGE_CDN`]),\n      new webpack.DefinePlugin({\n        // \"process.env.GATSBY_LOGGER\": JSON.stringify(`yurnalist`),\n        \"process.env.GATSBY_EXPERIMENTAL_LMDB_STORE\": `true`,\n        \"process.env.GATSBY_SKIP_WRITING_SCHEMA_TO_FILE\": `true`,\n        \"process.env.NODE_ENV\": JSON.stringify(`production`),\n        SCHEMA_SNAPSHOT: JSON.stringify(schemaSnapshotString),\n        \"process.env.GATSBY_LOGGER\": JSON.stringify(`yurnalist`),\n      }),\n      process.env.GATSBY_WEBPACK_LOGGING?.includes(`query-engine`) &&\n        new WebpackLoggingPlugin(rootDir, reporter, isVerbose),\n    ].filter(Boolean) as Array<webpack.WebpackPluginInstance>,\n  })\n\n  return new Promise((resolve, reject) => {\n    compiler.run((err, stats): void => {\n      function getResourcePath(\n        webpackModule?: Module | NormalModule | ConcatenatedModule | null\n      ): string | undefined {\n        if (webpackModule && !(webpackModule instanceof ConcatenatedModule)) {\n          return (webpackModule as NormalModule).resource\n        }\n\n        if (webpackModule?.modules) {\n          // ConcatenatedModule is a collection of modules so we have to go deeper to actually get a path,\n          // at this point we won't know which one so we just grab first module here\n          const [firstSubModule] = webpackModule.modules\n          return getResourcePath(firstSubModule)\n        }\n\n        return undefined\n      }\n\n      function iterateModules(\n        webpackModules: Set<Module>,\n        compilation: Compilation\n      ): void {\n        for (const webpackModule of webpackModules) {\n          if (webpackModule instanceof ConcatenatedModule) {\n            iterateModules(\n              (webpackModule as ConcatenatedModule).modules,\n              compilation\n            )\n          } else {\n            const resourcePath = getResourcePath(webpackModule)\n            if (resourcePath?.includes(`ts-node`)) {\n              const importedBy = getResourcePath(\n                compilation.moduleGraph.getIssuer(webpackModule)\n              )\n              const structuredError = {\n                id: `98011`,\n                context: {\n                  package: `ts-node`,\n                  importedBy,\n                  advisory: `Gatsby is supporting TypeScript natively (see https://gatsby.dev/typescript). \"ts-node\" might not be needed anymore at all, consider removing it.`,\n                },\n              }\n              throw structuredError\n            }\n          }\n        }\n      }\n\n      try {\n        if (stats?.compilation.modules) {\n          iterateModules(stats.compilation.modules, stats.compilation)\n        }\n\n        compiler.close(closeErr => {\n          if (err) {\n            return reject(err)\n          }\n          if (closeErr) {\n            return reject(closeErr)\n          }\n          return resolve(stats?.compilation)\n        })\n      } catch (e) {\n        reject(e)\n      }\n    })\n  })\n}\n"],"mappings":"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"}