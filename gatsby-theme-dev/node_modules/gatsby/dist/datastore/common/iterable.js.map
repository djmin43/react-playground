{"version":3,"file":"iterable.js","names":["GatsbyIterable","constructor","source","Symbol","iterator","i","val","clearKeptObjects","concat","other","concatSequence","map","fn","mapSequence","filter","predicate","filterSequence","slice","start","end","Error","sliceSequence","deduplicate","keyFn","deduplicateSequence","forEach","callback","value","mergeSorted","comparator","intersectSorted","deduplicateSorted","isIterable","obj","isNonArrayIterable","Array","isArray","index","item","first","second","registered","Set","current","key","has","add","defaultComparator","prev","firstSorted","secondSorted","iter1","iter2","a","next","b","done","return","eq"],"sources":["../../../src/datastore/common/iterable.ts"],"sourcesContent":["declare module \"lmdb\" {\n  // currently lmdb doesn't have typings for this export\n  export function clearKeptObjects(): void\n}\n\nimport { clearKeptObjects } from \"lmdb\"\n/**\n * Wrapper for any iterable providing chainable interface and convenience methods\n * similar to array.\n *\n * Additionally provides convenience methods for sorted iterables.\n *\n * Note: avoiding async iterables because of perf reasons, see https://github.com/nodejs/node/issues/31979\n * (fortunately lmdb can traverse stuff in sync manner very fast)\n */\nexport class GatsbyIterable<T> {\n  constructor(private source: Iterable<T> | (() => Iterable<T>)) {}\n\n  *[Symbol.iterator](): Iterator<T> {\n    const source =\n      typeof this.source === `function` ? this.source() : this.source\n\n    let i = 0\n    for (const val of source) {\n      yield val\n\n      // clearKeptObjects just make it possible for WeakRefs used in any way during current\n      // sync execution tick to be garbage collected. It doesn't force GC, just remove\n      // internal strong references in V8.\n      // see https://github.com/kriszyp/weak-lru-cache/issues/4\n      if (++i % 100 === 0) {\n        clearKeptObjects()\n      }\n    }\n  }\n\n  concat<U>(other: Iterable<U>): GatsbyIterable<T | U> {\n    return new GatsbyIterable(() => concatSequence(this, other))\n  }\n\n  map<U>(fn: (entry: T, index: number) => U): GatsbyIterable<U> {\n    return new GatsbyIterable(() => mapSequence(this, fn))\n  }\n\n  filter(predicate: (entry: T) => unknown): GatsbyIterable<T> {\n    return new GatsbyIterable(() => filterSequence(this, predicate))\n  }\n\n  slice(start: number, end?: number): GatsbyIterable<T> {\n    if ((typeof end !== `undefined` && end < start) || start < 0)\n      throw new Error(\n        `Both arguments must not be negative and end must be greater than start`\n      )\n    return new GatsbyIterable<T>(() => sliceSequence(this, start, end))\n  }\n\n  deduplicate(keyFn?: (entry: T) => unknown): GatsbyIterable<T> {\n    return new GatsbyIterable<T>(() => deduplicateSequence(this, keyFn))\n  }\n\n  forEach(callback: (entry: T, index: number) => unknown): void {\n    let i = 0\n    for (const value of this) {\n      callback(value, i++)\n    }\n  }\n\n  /**\n   * Assuming both this and the other iterable are sorted\n   * produces the new sorted iterable with interleaved values.\n   *\n   * Note: this method is not removing duplicates\n   */\n  mergeSorted<U = T>(\n    other: Iterable<U>,\n    comparator?: (a: T | U, b: T | U) => number\n  ): GatsbyIterable<T | U> {\n    return new GatsbyIterable(() => mergeSorted(this, other, comparator))\n  }\n\n  /**\n   * Assuming both this and the other iterable are sorted\n   * produces the new sorted iterable with values from this iterable\n   * that also exist in the other iterable.\n   */\n  intersectSorted<U = T>(\n    other: Iterable<U>,\n    comparator?: (a: T | U, b: T | U) => number\n  ): GatsbyIterable<T | U> {\n    return new GatsbyIterable(() => intersectSorted(this, other, comparator))\n  }\n\n  /**\n   * Assuming this iterable is sorted, removes duplicates from it\n   * by applying comparator(prev, current) to sibling iterable values.\n   *\n   * Comparator function is expected to return 0 when items are equal,\n   * similar to Array.prototype.sort() argument.\n   *\n   * If comparator is not set, uses strict === comparison\n   */\n  deduplicateSorted(comparator?: (a: T, b: T) => number): GatsbyIterable<T> {\n    return new GatsbyIterable<T>(() => deduplicateSorted(this, comparator))\n  }\n}\n\n/**\n * Returns true when passed value is iterable\n */\nexport function isIterable(obj: unknown): obj is Iterable<any> {\n  if (typeof obj !== `object` || obj === null) {\n    return false\n  }\n  return typeof obj[Symbol.iterator] === `function`\n}\n\nexport function isNonArrayIterable<T>(value: unknown): value is Iterable<T> {\n  return isIterable(value) && !Array.isArray(value)\n}\n\nfunction* mapSequence<T, U>(\n  source: Iterable<T>,\n  fn: (arg: T, index: number) => U\n): Generator<U> {\n  let i = 0\n  for (const value of source) {\n    yield fn(value, i++)\n  }\n}\n\nfunction* sliceSequence<T>(\n  source: Iterable<T>,\n  start: number,\n  end: number | undefined\n): Generator<T> {\n  let index = -1\n  for (const item of source) {\n    index++\n    if (index < start) continue\n    if (typeof end !== `undefined` && index >= end) break\n    yield item\n  }\n}\n\nfunction* filterSequence<T>(\n  source: Iterable<T>,\n  predicate: (arg: T) => unknown\n): Generator<T> {\n  for (const value of source) {\n    if (predicate(value)) {\n      yield value\n    }\n  }\n}\n\nfunction* concatSequence<T, U>(\n  first: Iterable<T>,\n  second: Iterable<U>\n): Generator<U | T> {\n  for (const value of first) {\n    yield value\n  }\n  for (const value of second) {\n    yield value\n  }\n}\n\nfunction* deduplicateSequence<T>(\n  source: Iterable<T>,\n  keyFn?: (entry: T) => unknown\n): Generator<T> {\n  // TODO: this can be potentially improved by using bloom filters?\n  const registered = new Set<unknown>()\n\n  for (const current of source) {\n    const key = keyFn ? keyFn(current) : current\n    if (!registered.has(key)) {\n      registered.add(key)\n      yield current\n    }\n  }\n}\n\nfunction* deduplicateSorted<T>(\n  source: Iterable<T>,\n  comparator: (a: T, b: T) => number = defaultComparator\n): Generator<T> {\n  let prev\n  for (const current of source) {\n    if (typeof prev === `undefined` || comparator(prev, current) !== 0) {\n      yield current\n    }\n    prev = current\n  }\n}\n\n// Merge two originally sorted iterables:\nfunction* mergeSorted<T, U = T>(\n  firstSorted: Iterable<T>,\n  secondSorted: Iterable<U>,\n  comparator: (a: T | U, b: T | U) => number = defaultComparator\n): Generator<T | U> {\n  const iter1 = firstSorted[Symbol.iterator]()\n  const iter2 = secondSorted[Symbol.iterator]()\n  try {\n    let a = iter1.next()\n    let b = iter2.next()\n    while (!a.done && !b.done) {\n      if (comparator(a.value, b.value) <= 0) {\n        yield a.value\n        a = iter1.next()\n      } else {\n        yield b.value\n        b = iter2.next()\n      }\n    }\n    while (!a.done) {\n      yield a.value\n      a = iter1.next()\n    }\n    while (!b.done) {\n      yield b.value\n      b = iter2.next()\n    }\n  } finally {\n    // If generator is exited early, make sure to close iterators too\n    // See https://raganwald.com/2017/07/22/closing-iterables-is-a-leaky-abstraction.html#more-about-closing-iterators-explicitly\n    if (typeof iter1.return === `function`) iter1.return()\n    if (typeof iter2.return === `function`) iter2.return()\n  }\n}\n\nfunction* intersectSorted<T, U = T>(\n  firstSorted: Iterable<T>,\n  secondSorted: Iterable<U>,\n  comparator: (a: T | U, b: T | U) => number = defaultComparator\n): Generator<T> {\n  const iter1 = firstSorted[Symbol.iterator]()\n  const iter2 = secondSorted[Symbol.iterator]()\n  try {\n    let a = iter1.next()\n    let b = iter2.next()\n\n    while (!a.done && !b.done) {\n      const eq = comparator(a.value, b.value)\n\n      if (eq < 0) {\n        // a < b\n        a = iter1.next()\n      } else if (eq > 0) {\n        // a > b\n        b = iter2.next()\n      } else {\n        yield a.value\n        a = iter1.next()\n      }\n    }\n  } finally {\n    if (typeof iter1.return === `function`) iter1.return()\n    if (typeof iter2.return === `function`) iter2.return()\n  }\n}\n\nfunction defaultComparator<T, U = T>(a: T | U, b: T | U): number {\n  if (a === b) {\n    return 0\n  }\n  return a > b ? 1 : -1\n}\n"],"mappings":"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"}